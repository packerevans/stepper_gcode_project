<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Strip Controls</title>
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
    <style>
        /* Modernized Styles */
        :root {
            --primary-color: #d2b48c; /* Khaki/Tan */
            --secondary-color: #b08d5c; /* Darker Tan */
            --text-color: #000000;
            --background-color: #f7f7f7;
            --terminal-bg: #ffffff;
            --terminal-border: #ccc;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }
        /* Sidebar Styles */
        .sidebar { height:100%; width:0; position:fixed; top:0; left:0; background:var(--primary-color); overflow-x:hidden; transition:0.3s; padding-top:60px; z-index:1000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar a { padding:12px 24px; text-decoration:none; font-size:18px; color:var(--text-color); display:block; transition:0.3s; }
        .sidebar a:hover { background-color:var(--secondary-color); }
        .openbtn { font-size:26px; cursor:pointer; background-color:var(--primary-color); color:var(--text-color); padding:10px 20px; border:none; border-radius:0 0 8px 0; position:fixed; top:0; left:0; z-index:1100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main-content { margin-left:0; transition:0.3s; padding:20px; max-width: 800px; margin: 0 auto; }
        
        h1 { text-align:center; margin-bottom:30px; color: var(--secondary-color); font-weight: 300; }
        .header-image { width:100%; max-height:200px; object-fit:cover; border-radius:12px; margin-bottom:30px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .control-section { background-color: var(--terminal-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .status-section { display:flex; justify-content:center; align-items:center; gap:20px; margin-bottom:15px; padding: 10px 0; }
        .indicator { width:15px; height:15px; border-radius:50%; background-color:lightgray; transition: background-color 0.3s; }
        
        button { background-color:var(--primary-color); color:var(--text-color); border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:16px; transition:0.2s ease-in-out; font-weight: 500; }
        button:hover { background-color:var(--secondary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .slider-section { display:flex; flex-direction: column; gap: 10px;}
        .slider-container { display:flex; align-items:center; justify-content:space-between; gap:15px; }
        .slider-container label { width:80px; font-weight:bold; }
        input[type="range"] { flex-grow:1; -webkit-appearance: none; appearance: none; height: 8px; background: #ddd; border-radius: 5px; cursor: pointer; }

        .bottom-section { display:flex; justify-content:space-around; align-items:flex-start; gap:20px; margin-top:25px; }
        .bottom-section > div { flex: 1; display: flex; flex-direction: column; align-items: center; }

        .color-display { width:120px; height:120px; border-radius:50%; border:5px solid var(--terminal-border); transition: background-color 0.5s; }
        .terminal { background:var(--terminal-bg); color:var(--text-color); font-family:'Consolas', 'Courier New', monospace; padding:15px; border-radius:8px; width: 100%; height:150px; overflow-y:auto; font-size:12px; border:1px solid var(--terminal-border); white-space: pre-wrap; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
<div id="mySidebar" class="sidebar">
    <a href="javascript:void(0)" onclick="closeNav()">✖ Close</a>
    <a href="{{ url_for('index') }}">Manual Command</a>
    <a href="{{ url_for('terminal') }}">Terminal</a>
    <a href="{{ url_for('led_controls') }}">LED Controls</a>
</div>

<button class="openbtn" onclick="openNav()">☰</button>

<div class="main-content">
    <img src="{{ url_for('static', filename='led.png') }}" alt="LED Header" class="header-image">

    <h1>LED Strip Controller</h1>

    <div class="control-section">
        <h2>Connection & Power</h2>
        <div class="status-section">
            <span style="font-weight:bold;">BLE Status:</span>
            <div class="indicator" id="connIndicator"></div>
            <span id="connStatusText">DISCONNECTED</span>
            
            <button onclick="toggleConnection()" id="connBtn">Connect</button>
            <button onclick="togglePower()" id="powerBtn">Turn OFF</button>
        </div>
    </div>

    <div class="control-section">
        <h2>Color Selector</h2>
        <div class="slider-section">
            <div class="slider-container"><label>Red</label><input type="range" id="redSlider" min="0" max="255" value="255" oninput="updateColorDisplay()"><span id="redVal">255</span></div>
            <div class="slider-container"><label>Green</label><input type="range" id="greenSlider" min="0" max="255" value="255" oninput="updateColorDisplay()"><span id="greenVal">255</span></div>
            <div class="slider-container"><label>Blue</label><input type="range" id="blueSlider" min="0" max="255" value="255" oninput="updateColorDisplay()"><span id="blueVal">255</span></div>
            <div class="slider-container"><label>Brightness</label><input type="range" id="brightnessSlider" min="1" max="16" value="16" oninput="updateColorDisplay()"><span id="brightnessVal">16</span></div>

            <div style="text-align:center; margin-top:20px;">
                <button onclick="sendLEDCommand()">Set Color</button>
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div>
            <h3>Current Color</h3>
            <div class="color-display" id="colorDisplay"></div>
        </div>
        <div>
            <h3>Terminal Log</h3>
            <div class="terminal" id="terminal"></div>
        </div>
    </div>
</div>

<script>
    // --- Sidebar Functions (Kept) ---
    function openNav() {
        document.getElementById("mySidebar").style.width = "200px";
        document.querySelector(".main-content").style.marginLeft = "200px";
    }

    function closeNav() {
        document.getElementById("mySidebar").style.width = "0";
        document.querySelector(".main-content").style.marginLeft = "0";
    }

    // --- State and UI Updates ---
    let isConnected = false;
    let powerOn = true;
    let brightnessValue = 16; 

    function updateColorDisplay() {
        const r = parseInt(document.getElementById('redSlider').value);
        const g = parseInt(document.getElementById('greenSlider').value);
        const b = parseInt(document.getElementById('blueSlider').value);
        const br = parseInt(document.getElementById('brightnessSlider').value);

        document.getElementById('redVal').textContent = r;
        document.getElementById('greenVal').textContent = g;
        document.getElementById('blueVal').textContent = b;
        document.getElementById('brightnessVal').textContent = br;
        
        brightnessValue = br; // Update global variable used when sending command

        // Scale RGB values for VISUAL DISPLAY ONLY (color circle)
        const scaledR = Math.round(r * (br / 16));
        const scaledG = Math.round(g * (br / 16));
        const scaledB = Math.round(b * (br / 16));
        
        document.getElementById('colorDisplay').style.backgroundColor = `rgb(${scaledR},${scaledG},${scaledB})`;
    }

    function updateConnectionStatusUI(connected) {
        if (isConnected !== connected) {
            isConnected = connected;
            const indicator = document.getElementById("connIndicator");
            const statusText = document.getElementById("connStatusText");
            const btn = document.getElementById("connBtn");

            indicator.style.backgroundColor = connected ? "green" : "red";
            statusText.textContent = connected ? "CONNECTED" : "DISCONNECTED";
            btn.textContent = connected ? "Disconnect" : "Connect";
            logToTerminal(`Status: Bluetooth ${connected ? 'CONNECTED' : 'DISCONNECTED'}`);
        }
    }

    function updatePowerStatusUI(on) {
        powerOn = on;
        document.getElementById("powerBtn").textContent = on ? "Turn OFF" : "Turn ON";
    }

    // --- Backend Communication ---

    async function sendCommand(cmd) {
        logToTerminal(`API Call: ${cmd}`);
        try {
            const response = await fetch("/send", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command: cmd })
            });
            const data = await response.json();
            if (!data.success) {
                logToTerminal(`Error sending ${cmd}: ${data.error || 'Unknown Error'}`, 'error');
            }
        } catch (e) {
            logToTerminal(`Network Error sending ${cmd}: ${e.message}`, 'error');
        }
    }

    async function sendLEDCommand() {
        const r = parseInt(document.getElementById('redSlider').value);
        const g = parseInt(document.getElementById('greenSlider').value);
        const b = parseInt(document.getElementById('blueSlider').value);
        
        // FIX: Send RAW R, G, B values along with the brightness byte (1-16)
        const cmd = `LED:${r},${g},${b},${brightnessValue}`; 
        await sendCommand(cmd);
        updatePowerStatusUI(true); 
    }

    async function toggleConnection() {
        const cmd = isConnected ? "DISCONNECT" : "CONNECT";
        await sendCommand(cmd);
    }

    async function togglePower() {
        const cmd = powerOn ? "POWER:OFF" : "POWER:ON";
        updatePowerStatusUI(!powerOn); 
        await sendCommand(cmd);
    }

    // --- Terminal Logger ---
    function logToTerminal(msg, type = 'info') {
        const term = document.getElementById("terminal");
        const line = document.createElement("div");
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        if (type === 'error') {
            line.style.color = 'red';
            line.style.fontWeight = 'bold';
        }
        term.appendChild(line);
        term.scrollTop = term.scrollHeight; 
    }

    // --- Status Polling ---
    async function pollStatus() {
        try {
            const response = await fetch("/status");
            if (!response.ok) throw new Error('Failed to fetch status');
            const data = await response.json();
            updateConnectionStatusUI(data.connected);
        } catch (e) {
            updateConnectionStatusUI(false);
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        updateColorDisplay();
        setInterval(pollStatus, 2000);
        updatePowerStatusUI(false); 
    });
</script>
</body>
</html>
