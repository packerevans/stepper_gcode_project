<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Strip Controls</title>
    <!-- Assuming Flask URLs for icons. Changed URL to a generic placeholder for display -->
    <link rel="icon" type="image/png" sizes="192x192" href="https://placehold.co/192x192/000000/FFFFFF?text=LED">
    <link rel="apple-touch-icon" sizes="512x512" href="https://placehold.co/512x512/000000/FFFFFF?text=LED">
    
    <style>
        /* --- Root Variables (Light Mode) --- */
        :root {
            --color-primary: #d2b48c; /* Khaki/Tan */
            --color-secondary: #b08d5c; /* Darker Tan */
            --color-background: #f0f0f0; 
            --color-surface: #ffffff; 
            --color-text: #333333;
            --color-shadow: rgba(0, 0, 0, 0.08);
            --color-icon: #000000;
            
            /* Terminal Colors (Light) */
            --color-terminal-bg: #e9e9e9;
            --color-terminal-text: #333333;
            --color-terminal-prompt: #008080; /* Teal/Cyan */
            
            --border-radius: 12px;
        }

        /* --- Dark Mode Variables --- */
        body[data-theme='dark'] {
            --color-background: #1e1e1e;
            --color-surface: #2c2c2c;
            --color-text: #e0e0e0;
            --color-shadow: rgba(255, 255, 255, 0.08);
            --color-icon: #ffffff;
            
            /* Terminal Colors (Dark) */
            --color-terminal-bg: #1a1a1a;
            --color-terminal-text: #cccccc;
            --color-terminal-prompt: #98fb98; /* Pale Green */
        }
        
        /* --- Base Styles --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 0;
            margin: 0;
            transition: background 0.3s, color 0.3s;
        }

        /* --- Sidebar & Header --- */
        .sidebar {
            height: 100%; width: 0; position: fixed; top: 0; left: 0;
            background-color: var(--color-primary); overflow-x: hidden;
            transition: 0.3s; padding-top: 60px; z-index: 1000;
            box-shadow: 2px 0 5px var(--color-shadow);
        }

        .sidebar a {
            padding: 15px 24px; text-decoration: none; font-size: 18px;
            color: var(--color-text); display: block; transition: 0.2s;
            font-weight: 500;
        }
        .sidebar a:hover {
            background-color: var(--color-secondary);
            color: var(--color-surface);
        }

        .openbtn {
            font-size: 26px; cursor: pointer; background-color: var(--color-primary);
            color: var(--color-text); padding: 10px 20px; border: none;
            border-radius: 0 0 var(--border-radius) 0; position: fixed;
            top: 0; left: 0; z-index: 1100; box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        #themeToggle {
            position: fixed; top: 15px; right: 15px; background: var(--color-surface);
            color: var(--color-icon); border: 1px solid var(--color-icon);
            padding: 8px 15px; border-radius: 20px; z-index: 1200;
            transition: background 0.3s, color 0.3s, border-color 0.3s;
        }
        
        .main-content {
            margin-left: 0; transition: margin-left 0.3s; padding: 20px;
            max-width: 800px; margin: 0 auto;
        }

        h1 {
            text-align: center; margin-top: 20px; margin-bottom: 30px;
            font-weight: 300; color: var(--color-secondary);
        }

        .header-image {
            width: 100%; max-height: 250px; object-fit: cover;
            border-radius: var(--border-radius); margin-bottom: 30px;
            box-shadow: 0 4px 15px var(--color-shadow);
        }

        /* --- Control Sections --- */
        .control-section {
            background-color: var(--color-surface); padding: 25px;
            border-radius: var(--border-radius); box-shadow: 0 4px 8px var(--color-shadow);
            margin-bottom: 25px;
        }

        .status-section {
            display: flex; justify-content: center; align-items: center;
            gap: 20px; margin-bottom: 15px; padding: 10px 0;
        }
        .indicator {
            width: 15px; height: 15px; border-radius: 50%;
            background-color: lightgray; transition: background-color 0.3s;
        }
        
        button {
            background-color: var(--color-primary); color: var(--color-text);
            border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;
            font-size: 16px; transition: 0.2s ease-in-out; font-weight: 500;
        }
        button:hover {
            background-color: var(--color-secondary); box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        /* --- Sliders --- */
        .slider-section { display: flex; flex-direction: column; gap: 10px;}
        .slider-container { display: flex; align-items: center; justify-content: space-between; gap: 15px; }
        .slider-container label { width: 80px; font-weight: 600; }
        
        input[type="range"] {
            flex-grow: 1; -webkit-appearance: none; appearance: none;
            height: 8px; background: #ddd; border-radius: 5px; cursor: pointer;
            transition: background 0.3s;
        }
        body[data-theme='dark'] input[type="range"] { background: #555; }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            border-radius: 50%; background: var(--color-secondary); cursor: pointer;
            box-shadow: 0 0 5px var(--color-shadow);
        }

        .bottom-section {
            display: flex; justify-content: space-around; align-items: flex-start;
            gap: 20px; margin-top: 25px;
        }
        .bottom-section > div { flex: 1; display: flex; flex-direction: column; align-items: center; }

        .color-display {
            width: 120px; height: 120px; border-radius: 50%;
            border: 5px solid var(--color-text); transition: background-color 0.5s, border-color 0.3s, opacity 0.5s;
        }
        
        /* --- Terminal --- */
        .terminal {
            background: var(--color-terminal-bg); color: var(--color-terminal-text);
            font-family: 'Consolas', 'Courier New', monospace; padding: 15px;
            border-radius: 8px; width: 100%; height: 150px; overflow-y: auto;
            font-size: 12px; border: 1px solid var(--color-shadow);
            white-space: pre-wrap; box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
            transition: background 0.3s, color 0.3s;
        }
        .terminal .prompt { color: var(--color-terminal-prompt); font-weight: bold; }
        .terminal .response { color: var(--color-terminal-text); }


        /* --- Mobile Responsiveness (Shared with Sand Table Page) --- */
        @media (max-width: 600px) {
            .main-content {
                padding: 10px;
            }
            .sidebar {
                padding-top: 10px;
            }
            .header-image {
                max-height: 150px;
                margin-bottom: 20px;
            }
            h1 {
                font-size: 1.8em;
                margin-bottom: 20px;
            }
            
            /* LED Page Specific */
            .status-section {
                flex-wrap: wrap;
                justify-content: space-between;
                gap: 10px;
            }
            .status-section button {
                flex-basis: calc(50% - 10px);
                padding: 10px 5px;
                font-size: 14px;
            }
            .slider-container {
                flex-direction: row; /* Keep sliders side-by-side on mobile if possible, but adjust spacing */
                align-items: center;
                gap: 5px;
                padding: 5px 0;
                border-bottom: 1px dashed #ccc5;
                flex-wrap: nowrap;
            }
            .slider-container label {
                width: 70px; /* Give a fixed width for labels */
                min-width: 70px;
            }
            input[type="range"] {
                width: auto;
            }
            .bottom-section {
                flex-direction: column;
                gap: 30px;
            }
            .color-display {
                width: 100px;
                height: 100px;
            }
        }
    </style>
</head>
<body data-theme="light">
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" onclick="closeNav()">✖ Close</a>
        <!-- Assuming Flask URLs -->
        <a href="{{ url_for('index') }}">Sand Table Controls</a>
        <a href="{{ url_for('led_controls') }}">LED Controls</a>
        <a href="{{ url_for('terminal') }}">Terminal</a>
    </div>

    <button class="openbtn" onclick="openNav()">☰</button>
    <button id="themeToggle" onclick="toggleDarkMode()">
        <span id="themeIcon">☀️</span>
    </button>

    <div class="main-content">
        <!-- Using a generic placeholder image -->
        <img src="https://placehold.co/800x250/d2b48c/333?text=LED+Strip+Controller" alt="LED Header" class="header-image">

        <h1>LED Strip Controller</h1>

        <div class="control-section">
            <h2>Connection & Power</h2>
            <div class="status-section">
                <span style="font-weight:bold;">BLE Status:</span>
                <div class="indicator" id="connIndicator"></div>
                <span id="connStatusText">DISCONNECTED</span>
                
                <button onclick="toggleConnection()" id="connBtn">Connect</button>
                <button onclick="togglePower()" id="powerBtn">Turn OFF</button>
            </div>
        </div>

        <div class="control-section">
            <h2>Color Selector</h2>
            <div class="slider-section">
                <div class="slider-container">
                    <label>Red</label>
                    <input type="range" id="redSlider" min="0" max="255" value="255" oninput="updateColorDisplay()">
                    <span id="redVal">255</span>
                </div>
                <div class="slider-container">
                    <label>Green</label>
                    <input type="range" id="greenSlider" min="0" max="255" value="255" oninput="updateColorDisplay()">
                    <span id="greenVal">255</span>
                </div>
                <div class="slider-container">
                    <label>Blue</label>
                    <input type="range" id="blueSlider" min="0" max="255" value="255" oninput="updateColorDisplay()">
                    <span id="blueVal">255</span>
                </div>
                <!-- FIX: Corrected ID and range for Brightness slider -->
                <div class="slider-container">
                    <label>Brightness</label>
                    <input type="range" id="brightnessSlider" min="1" max="16" value="16" oninput="updateColorDisplay()">
                    <span id="brightnessVal">16</span>
                </div>
                <div style="text-align:center; margin-top:20px;">
                    <button onclick="sendLEDCommand()">Set Color</button>
                </div>
            </div>
        </div>

        <div class="bottom-section">
            <div>
                <h3>Current Color</h3>
                <div class="color-display" id="colorDisplay"></div>
            </div>
            <div>
                <h3>Terminal Log</h3>
                <div class="terminal" id="terminal"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state variable for brightness
        let brightnessValue = 16; 
        
        // --- Sidebar Functions ---
        function openNav() {
            document.getElementById("mySidebar").style.width = "200px";
            if (window.innerWidth > 600) {
                 document.querySelector(".main-content").style.marginLeft = "200px";
            }
        }

        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.querySelector(".main-content").style.marginLeft = "0";
        }
        
        // --- Dark Mode Toggle ---
        function updateThemeIcon(theme) {
            document.getElementById('themeIcon').textContent = theme === 'dark' ? '🌙' : '☀️';
        }

        function toggleDarkMode() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        // --- State and UI Updates ---
        let isConnected = false;
        let powerOn = true;

        function updateColorDisplay() {
            const r = parseInt(document.getElementById('redSlider').value);
            const g = parseInt(document.getElementById('greenSlider').value);
            const b = parseInt(document.getElementById('blueSlider').value);
            // FIX: Use the correct ID for brightness slider and span
            const br = parseInt(document.getElementById('brightnessSlider').value);

            document.getElementById('redVal').textContent = r;
            document.getElementById('greenVal').textContent = g;
            document.getElementById('blueVal').textContent = b;
            document.getElementById('brightnessVal').textContent = br;

            // Update the global state variable
            brightnessValue = br; 

            // Visual Display: Modulate color circle brightness/opacity for a visual cue (1/16 to 1)
            const brightnessRatio = br / 16; 
            
            // Set the color circle background
            document.getElementById('colorDisplay').style.backgroundColor = `rgb(${r},${g},${b})`;
            // Adjust opacity (0.2 minimum to 1 maximum)
            document.getElementById('colorDisplay').style.opacity = brightnessRatio * 0.8 + 0.2; 
        }

        function updateConnectionStatusUI(connected) {
            if (isConnected !== connected) {
                isConnected = connected;
                const indicator = document.getElementById("connIndicator");
                const statusText = document.getElementById("connStatusText");
                const btn = document.getElementById("connBtn");

                indicator.style.backgroundColor = connected ? "green" : "red";
                statusText.textContent = connected ? "CONNECTED" : "DISCONNECTED";
                btn.textContent = connected ? "Disconnect" : "Connect";
                logToTerminal(`Status: Bluetooth ${connected ? 'CONNECTED' : 'DISCONNECTED'}`, 'info', true);
            }
        }

        function updatePowerStatusUI(on) {
            powerOn = on;
            document.getElementById("powerBtn").textContent = on ? "Turn OFF" : "Turn ON";
            
            // Re-call updateColorDisplay to visually dim/restore based on power state
            updateColorDisplay();
        }

        // --- Terminal Logger ---
        function logToTerminal(msg, type = 'info', isStatus = false) {
            const term = document.getElementById("terminal");
            const line = document.createElement("div");
            const time = `[${new Date().toLocaleTimeString()}]`;
            
            if (isStatus) {
                 line.innerHTML = `<span class="prompt">${time} ${msg}</span>`;
            } else if (type === 'error') {
                line.innerHTML = `<span class="response" style="color:red; font-weight:bold;">${time} ERROR: ${msg}</span>`;
            } else {
                line.innerHTML = `<span class="response">${time} ${msg}</span>`;
            }
            
            term.appendChild(line);
            term.scrollTop = term.scrollHeight;  
        }

        // --- Backend Communication ---

        async function sendCommand(cmd) {
            logToTerminal(`Sending: ${cmd}`);
            try {
                const response = await fetch("/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ command: cmd })
                });
                const data = await response.json();
                if (!data.success) {
                    logToTerminal(`Command failed: ${data.error || 'Unknown Error'}`, 'error');
                } else {
                    logToTerminal(`Command successful: ${data.message || 'Sent.'}`, 'info');
                }
            } catch (e) {
                logToTerminal(`Network Error: Could not reach server (${e.message})`, 'error');
            }
        }

        async function sendLEDCommand() {
            const r = parseInt(document.getElementById('redSlider').value);
            const g = parseInt(document.getElementById('greenSlider').value);
            const b = parseInt(document.getElementById('blueSlider').value);
            
            // FIX: Use the global brightnessValue variable
            const cmd = `LED:${r},${g},${b},${brightnessValue}`; 
            
            await sendCommand(cmd);
            updatePowerStatusUI(true); // Always turn on power when color is set
        }

        async function toggleConnection() {
            const cmd = isConnected ? "DISCONNECT" : "CONNECT";
            await sendCommand(cmd); 
        }

        async function togglePower() {
            const cmd = powerOn ? "POWER:OFF" : "POWER:ON";
            await sendCommand(cmd);
            updatePowerStatusUI(!powerOn);  
        }

        // --- Status Polling ---
        async function pollStatus() {
            try {
                const response = await fetch("/status");
                if (!response.ok) throw new Error('Failed to fetch status');
                const data = await response.json();
                // Assumes /status returns { connected: bool }
                updateConnectionStatusUI(data.connected);
                
            } catch (e) {
                // If status polling fails, assume disconnected
                updateConnectionStatusUI(false); 
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load theme from local storage
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            // Set initial state based on slider defaults
            updateColorDisplay();
            updatePowerStatusUI(false); // Initialize to OFF visually
            
            // Start polling status
            setInterval(pollStatus, 2000);
            pollStatus(); // Run immediately
        });
    </script>
</body>
</html>
