<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Strip Controls</title>
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
    
    <style>
        /* --- Root Variables (Light Mode) --- */
        :root {
            --color-primary: #d2b48c; /* Khaki/Tan */
            --color-secondary: #b08d5c; /* Darker Tan */
            --color-background: #f0f0f0; 
            --color-surface: #ffffff; 
            --color-text: #333333;
            --color-shadow: rgba(0, 0, 0, 0.08);
            --color-icon: #000000;
            
            --border-radius: 12px;
        }

        /* --- Dark Mode Variables --- */
        body[data-theme='dark'] {
            --color-background: #1e1e1e;
            --color-surface: #2c2c2c;
            --color-text: #e0e0e0;
            --color-shadow: rgba(255, 255, 255, 0.08);
            --color-icon: #ffffff;
        }
        
        /* --- Base Styles --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 0;
            margin: 0;
            transition: background 0.3s, color 0.3s;
        }

        /* --- Sidebar & Header --- */
        .sidebar {
            height: 100%; width: 0; position: fixed; top: 0; left: 0;
            background-color: var(--color-primary); overflow-x: hidden;
            transition: 0.3s; padding-top: 60px; z-index: 1000;
            box-shadow: 2px 0 5px var(--color-shadow);
        }

        .sidebar a {
            padding: 15px 24px; text-decoration: none; font-size: 18px;
            color: var(--color-text); display: block; transition: 0.2s;
            font-weight: 500;
        }
        .sidebar a:hover {
            background-color: var(--color-secondary);
            color: var(--color-surface);
        }

        .openbtn {
            font-size: 26px; cursor: pointer; background-color: var(--color-primary);
            color: var(--color-text); padding: 10px 20px; border: none;
            border-radius: 0 0 var(--border-radius) 0; position: fixed;
            top: 0; left: 0; z-index: 1100; box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        #themeToggle {
            position: fixed; top: 15px; right: 15px; background: var(--color-surface);
            color: var(--color-icon); border: 1px solid var(--color-icon);
            padding: 8px 15px; border-radius: 20px; z-index: 1200;
            transition: background 0.3s, color 0.3s, border-color 0.3s;
        }
        
        .main-content {
            margin-left: 0; transition: margin-left 0.3s; padding: 20px;
            max-width: 800px; margin: 0 auto;
            padding-top: 70px;
        }

        h1 {
            text-align: center; margin-top: 10px; margin-bottom: 20px;
            font-weight: 300; color: var(--color-secondary);
        }

        /* --- Control Cards --- */
        .control-section {
            background-color: var(--color-surface); padding: 25px;
            border-radius: var(--border-radius); box-shadow: 0 4px 8px var(--color-shadow);
            margin-bottom: 25px;
            text-align: center;
        }

        /* --- Status Indicators --- */
        .status-row {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 15px;
        }
        .indicator {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #ccc; transition: background-color 0.3s;
            display: inline-block;
        }
        
        /* --- Buttons --- */
        button {
            background-color: var(--color-primary); color: var(--color-text);
            border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;
            font-size: 16px; transition: 0.2s ease-in-out; font-weight: 600;
            min-width: 120px;
        }
        button:hover {
            background-color: var(--color-secondary); box-shadow: 0 2px 5px var(--color-shadow);
        }
        button.btn-outline {
            background: transparent; border: 2px solid var(--color-primary);
        }
        button.btn-outline:hover {
            background: var(--color-primary); color: var(--color-text);
        }
        
        /* --- Color Picker UI --- */
        .color-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
        }
        
        /* Hide default color input but keep functionality */
        input[type="color"] {
            -webkit-appearance: none; border: none;
            width: 150px; height: 150px;
            cursor: pointer; background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch {
            border: 4px solid var(--color-text); border-radius: 50%;
            box-shadow: 0 4px 10px var(--color-shadow);
        }

        /* --- Brightness Slider --- */
        .brightness-container {
            width: 100%; max-width: 300px; margin-top: 10px;
        }
        input[type="range"] {
            width: 100%; -webkit-appearance: none; appearance: none;
            height: 10px; background: #ddd; border-radius: 5px; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px;
            border-radius: 50%; background: var(--color-secondary);
            box-shadow: 0 0 5px var(--color-shadow); margin-top: -7px;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            height: 10px; background: #ddd; border-radius: 5px;
        }

        /* --- Favorites System --- */
        .favorites-grid {
            display: flex; justify-content: center; gap: 20px; margin-top: 20px;
        }
        .fav-circle {
            width: 50px; height: 50px; border-radius: 50%;
            border: 2px solid var(--color-shadow); cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        .fav-circle:hover { transform: scale(1.1); }
        .fav-circle:active { transform: scale(0.95); }

        /* --- Terminal --- */
        .terminal {
            background: var(--color-terminal-bg); color: var(--color-terminal-text);
            font-family: 'Consolas', 'Courier New', monospace; padding: 15px;
            border-radius: 8px; width: 100%; height: 120px; overflow-y: auto;
            font-size: 12px; border: 1px solid var(--color-shadow);
            text-align: left;
            box-sizing: border-box;
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 600px) {
            .sidebar { padding-top: 10px; }
            h1 { font-size: 1.8em; }
            .status-row { flex-direction: column; gap: 10px; }
            button { width: 100%; }
        }
    </style>
</head>
<body data-theme="light">
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" onclick="closeNav()">‚úñ Close</a>
        <a href="/controls">Controls</a>
        <a href="/">Designs</a> 
        <a href="/led_controls">Led Controls</a>
        <a href="/terminal">Terminal</a>
    </div>

    <button class="openbtn" onclick="openNav()">‚ò∞</button>
    <button id="themeToggle" onclick="toggleDarkMode()">
        <span id="themeIcon">‚òÄÔ∏è</span>
    </button>

    <div class="main-content">
        <h1>LED Controller</h1>

        <div class="control-section">
            <div class="status-row">
                <div>
                    <div class="indicator" id="connIndicator"></div>
                    <span id="connStatusText" style="font-weight:bold; margin-left:5px;">DISCONNECTED</span>
                </div>
                <button onclick="toggleConnection()" id="connBtn">Connect</button>
            </div>
            <div class="status-row">
                 <button onclick="togglePower()" id="powerBtn" class="btn-outline">Power ON/OFF</button>
            </div>
        </div>

        <div class="control-section">
            <h2>Color & Brightness</h2>
            
            <div class="color-wrapper">
                <input type="color" id="colorPicker" value="#ff0000" oninput="handleColorInput()">
                
                <div class="brightness-container">
                    <label>Brightness: <span id="brightVal">16</span></label>
                    <input type="range" id="brightnessSlider" min="1" max="16" value="16" oninput="handleColorInput()">
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>Quick Favorites</h3>
                <div class="favorites-grid" id="favGrid">
                    </div>
                <button onclick="saveCurrentToFavorite()" style="margin-top:15px; font-size:14px; padding:8px 16px;">Save Current Color</button>
            </div>
        </div>

        <div class="control-section" style="padding:15px;">
            <h3 style="margin-top:0;">Log</h3>
            <div class="terminal" id="terminal">System Ready. Click Connect to start.</div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        let isConnected = false;
        let debounceTimer;
        // Max favorites to store
        const MAX_FAVS = 3; 
        // Default favs if none saved
        const DEFAULT_FAVS = ["#ff0000", "#00ff00", "#0000ff"];

        // --- THEME & SIDEBAR (Standard) ---
        function openNav() {
            document.getElementById("mySidebar").style.width = "200px";
            if(window.innerWidth > 600) document.querySelector(".main-content").style.marginLeft = "200px";
        }
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.querySelector(".main-content").style.marginLeft = "0";
        }
        function toggleDarkMode() {
            const body = document.body;
            const current = body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            document.getElementById('themeIcon').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        // --- COLOR LOGIC ---

        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return { r, g, b };
        }

        // This function is called whenever the wheel moves or brightness changes
        function handleColorInput() {
            // Update UI Text immediately
            document.getElementById('brightVal').textContent = document.getElementById('brightnessSlider').value;

            // Debounce: Wait 300ms after user stops moving before sending data
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                sendCurrentState();
            }, 300); 
        }

        async function sendCurrentState() {
            if (!isConnected) return; // Don't spam if not connected

            const hex = document.getElementById('colorPicker').value;
            const br = document.getElementById('brightnessSlider').value;
            const rgb = hexToRgb(hex);
            
            const cmd = `LED:${rgb.r},${rgb.g},${rgb.b},${br}`;
            await sendCommand(cmd, false); // false = don't log every color change to keep terminal clean
        }

        async function applyFavorite(hex) {
            document.getElementById('colorPicker').value = hex;
            handleColorInput(); // Trigger send
        }

        // --- FAVORITES SYSTEM ---
        function loadFavorites() {
            const container = document.getElementById('favGrid');
            container.innerHTML = '';
            
            let favs = JSON.parse(localStorage.getItem('ledFavs'));
            if (!favs || favs.length === 0) favs = DEFAULT_FAVS;

            favs.forEach(color => {
                const circle = document.createElement('div');
                circle.className = 'fav-circle';
                circle.style.backgroundColor = color;
                circle.onclick = () => applyFavorite(color);
                container.appendChild(circle);
            });
        }

        function saveCurrentToFavorite() {
            const current = document.getElementById('colorPicker').value;
            let favs = JSON.parse(localStorage.getItem('ledFavs')) || [...DEFAULT_FAVS];
            
            // Add to front, remove last if > MAX
            favs.unshift(current);
            if (favs.length > MAX_FAVS) favs.pop();
            
            localStorage.setItem('ledFavs', JSON.stringify(favs));
            loadFavorites();
            logToTerminal(`Saved color ${current} to favorites.`);
        }

        // --- COMMUNICATIONS ---

        async function sendCommand(cmd, logIt = true) {
            if (logIt) logToTerminal(`Sending: ${cmd}`);
            try {
                const res = await fetch("/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ command: cmd })
                });
                const data = await res.json();
                if (!data.success && logIt) logToTerminal(`Error: ${data.error}`, 'error');
                else if (logIt) logToTerminal("Sent.");
                return data.success;
            } catch (e) {
                logToTerminal(`Network Error: ${e.message}`, 'error');
                return false;
            }
        }

        async function toggleConnection() {
            const btn = document.getElementById("connBtn");
            btn.disabled = true; // Prevent double clicks
            
            const cmd = isConnected ? "DISCONNECT" : "CONNECT";
            logToTerminal(`Attempting to ${cmd}...`);
            
            const success = await sendCommand(cmd);
            
            // Allow the status poller to update the actual UI state
            // But give a momentary visual feedback
            if(success) {
                // Wait a second for Python to actually establish/break link
                setTimeout(pollStatus, 1000);
            } else {
                btn.disabled = false;
            }
        }

        function togglePower() {
             // We blindly toggle, relying on the previous state logic or just sending ON/OFF
             // Ideally, we track state, but simpler is to check connection first
             if(!isConnected) {
                 logToTerminal("Connect Bluetooth first!", "error");
                 return;
             }
             // We will determine state by just sending the opposite of what we think, 
             // or just create separate ON/OFF buttons if needed. 
             // For now, let's send POWER:ON if we are "connected" but maybe off.
             // Actually, best to toggle based on a variable or just send specific commands.
             // Let's use a prompt for now to keep it simple single button? 
             // No, let's just assume if we are clicking it, we want to toggle.
             // Since we don't know current power state from Python easily without tracking, 
             // let's use the button text to toggle logic locally.
             const btn = document.getElementById('powerBtn');
             const isOff = btn.innerText.includes("OFF");
             const cmd = isOff ? "POWER:OFF" : "POWER:ON"; // Logic inverted based on label
             sendCommand(cmd);
             
             // Toggle label immediately for responsiveness
             btn.innerText = isOff ? "Power ON" : "Power OFF";
        }

        // --- STATUS POLLING ---
        async function pollStatus() {
            try {
                const res = await fetch("/status");
                const data = await res.json();
                
                if (isConnected !== data.connected) {
                    isConnected = data.connected;
                    updateStatusUI(isConnected);
                }
            } catch (e) {
                console.log("Poll failed");
            }
        }

        function updateStatusUI(connected) {
            const ind = document.getElementById("connIndicator");
            const txt = document.getElementById("connStatusText");
            const btn = document.getElementById("connBtn");
            
            ind.style.backgroundColor = connected ? "#28a745" : "#dc3545"; // Green/Red
            txt.textContent = connected ? "CONNECTED" : "DISCONNECTED";
            txt.style.color = connected ? "#28a745" : "#dc3545";
            btn.textContent = connected ? "Disconnect" : "Connect";
            btn.disabled = false;
            
            if(connected) logToTerminal("Device Connected.");
            else logToTerminal("Device Disconnected.");
        }

        function logToTerminal(msg, type='info') {
            const term = document.getElementById("terminal");
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : 'inherit';
            term.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            term.scrollTop = term.scrollHeight;
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            // Theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

            loadFavorites();
            
            // Start Polling Status (Every 3 seconds is enough, don't spam)
            setInterval(pollStatus, 3000);
            pollStatus();
        });
    </script>
</body>
</html>
