<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Strip Controls</title>
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
    
    <style>
        :root {
            --color-primary: #d2b48c;
            --color-secondary: #b08d5c;
            --color-background: #f0f0f0; 
            --color-surface: #ffffff; 
            --color-text: #333333;
            --color-shadow: rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        body[data-theme='dark'] {
            --color-background: #1e1e1e;
            --color-surface: #2c2c2c;
            --color-text: #e0e0e0;
            --color-shadow: rgba(255, 255, 255, 0.08);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 0; margin: 0;
            transition: background 0.3s, color 0.3s;
        }

        /* --- Sidebar & Layout --- */
        .sidebar {
            height: 100%; width: 0; position: fixed; top: 0; left: 0;
            background-color: var(--color-primary); overflow-x: hidden;
            transition: 0.3s; padding-top: 60px; z-index: 1000;
            box-shadow: 2px 0 5px var(--color-shadow);
        }
        .sidebar a {
            padding: 15px 24px; text-decoration: none; font-size: 18px;
            color: var(--color-text); display: block; transition: 0.2s; font-weight: 500;
        }
        .sidebar a:hover { background-color: var(--color-secondary); color: var(--color-surface); }

        .openbtn {
            font-size: 26px; cursor: pointer; background-color: var(--color-primary);
            color: var(--color-text); padding: 10px 20px; border: none;
            border-radius: 0 0 var(--border-radius) 0; position: fixed;
            top: 0; left: 0; z-index: 1100; box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        /* UPDATED: Fixed Theme Toggle to be a perfect circle */
        #themeToggle {
            position: fixed; top: 15px; right: 15px; background: var(--color-surface);
            color: var(--color-text); border: 1px solid var(--color-text);
            /* Removed padding to strictly control size */
            padding: 0; 
            border-radius: 50%; z-index: 1200;
            width: 45px; height: 45px; /* Fixed equal width/height */
            display: flex; align-items: center; justify-content: center;
            transition: background 0.3s;
            cursor: pointer;
        }
        
        .main-content {
            margin-left: 0; transition: margin-left 0.3s; padding: 20px;
            max-width: 800px; margin: 0 auto; padding-top: 60px;
        }

        .header-image {
            width: 100%; max-height: 250px; object-fit: cover;
            border-radius: var(--border-radius); margin-bottom: 20px;
            box-shadow: 0 4px 15px var(--color-shadow);
            display: block;
        }

        h1 {
            text-align: center; margin-bottom: 20px;
            font-weight: 300; color: var(--color-secondary);
        }

        /* --- Controls --- */
        .control-section {
            background-color: var(--color-surface);
            color: var(--color-text);
            padding: 25px;
            border-radius: var(--border-radius); box-shadow: 0 4px 8px var(--color-shadow);
            margin-bottom: 25px; text-align: center;
        }
        
        .status-row {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 0;
        }
        .indicator {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #555; display: inline-block;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        button {
            background-color: var(--color-primary); color: var(--color-text);
            border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;
            font-size: 16px; transition: 0.2s ease-in-out; font-weight: 600;
            min-width: 120px;
        }
        button:hover {
            background-color: var(--color-secondary); box-shadow: 0 2px 5px var(--color-shadow);
        }
        button:disabled {
            background-color: #ccc; cursor: not-allowed;
        }
        
        .color-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            margin-top: 10px;
        }
        input[type="color"] {
            -webkit-appearance: none; border: none;
            width: 150px; height: 150px;
            cursor: pointer; background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch {
            border: 4px solid var(--color-text); border-radius: 50%;
            box-shadow: 0 4px 10px var(--color-shadow);
        }

        .favorites-grid {
            display: flex; justify-content: center; gap: 20px; margin-top: 20px;
        }
        .fav-circle {
            width: 60px; height: 60px; border-radius: 50%;
            border: 3px solid var(--color-surface); cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        .fav-circle:hover { transform: scale(1.1); border-color: var(--color-primary); }
        
        .terminal {
            background: #ffffff; 
            color: #000000;
            font-family: 'Consolas', 'Courier New', monospace; padding: 15px;
            border-radius: 8px; width: 100%; height: 150px; overflow-y: auto;
            font-size: 13px; border: 1px solid #ccc;
            text-align: left; box-sizing: border-box; white-space: pre-wrap;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        @media (max-width: 600px) {
            .status-row { flex-direction: column; gap: 15px; }
            button { width: 100%; }
        }
    </style>
</head>
<body data-theme="light">
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" onclick="closeNav()">‚úñ Close</a>
        <a href="/">Designs</a> 
        <a href="/controls">Drawing</a>
        <a href="{{ url_for('led_controls') }}">LED Controls</a>
        <a href="{{ url_for('AI_builder') }}">AI Builder</a>
        <a href="/terminal">Terminal</a>
    </div>

    <button class="openbtn" onclick="openNav()">‚ò∞</button>
    <button id="themeToggle" onclick="toggleDarkMode()">
        <span id="themeIcon">‚òÄÔ∏è</span>
    </button>

    <div class="main-content">
        <img src="{{ url_for('static', filename='led.png') }}" alt="LED Header" class="header-image">

        <h1>LED Controller</h1>

        <div class="control-section">
            <div class="status-row">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div class="indicator" id="connIndicator"></div>
                    <span id="connStatusText" style="font-weight:bold; font-size: 1.1em;">Unknown</span>
                </div>
            </div>
            <div class="status-row" style="margin-top: 15px;">
                <button onclick="toggleConnection()" id="connBtn">Connect</button>
                <button onclick="togglePower()" id="powerBtn">Power ON/OFF</button>
            </div>
        </div>

        <div class="control-section">
            <h2>Select Color</h2>
            
            <div class="color-wrapper">
                <input type="color" id="colorPicker" value="#ffffff" oninput="handleColorInput()">
                <p style="color: var(--color-text); opacity: 0.7; margin-top:-10px;">Tap circle to change</p>
            </div>

            <div style="margin-top: 30px; border-top: 1px solid var(--color-shadow); padding-top: 20px;">
                <h3>Your Favorite Whites</h3>
                <div class="favorites-grid" id="favGrid"></div>
                <button onclick="saveCurrentToFavorite()" style="margin-top:20px;">Save This White</button>
            </div>
        </div>

        <div class="control-section" style="padding:15px;">
            <h3 style="margin-top:0; font-size: 1em; opacity: 0.6;">System Log (Live)</h3>
            <div class="terminal" id="terminal">Loading...</div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let debounceTimer;
        const MAX_FAVS = 3; 
        const DEFAULT_FAVS = ["#ffffff", "#f0f0f0", "#e0e0e0"]; 
        
        // --- COLOR CALIBRATION ---
        // Adjust these values to fix the "Blueish" tint of your LEDs.
        // 1.0 = 100% strength, 0.8 = 80% strength.
        // We reduce Blue significantly to make "White" look like real white.
        const CALIBRATION = {
            r: 1.0,  // Red (Keep full)
            g: 0.9,  // Green (Reduce slightly)
            b: 0.75  // Blue (Reduce significantly to fix cool-white tint)
        };

        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
        }

        function handleColorInput() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                sendCurrentState();
            }, 200);
        }

        async function sendCurrentState() {
            const hex = document.getElementById('colorPicker').value;
            const rawRgb = hexToRgb(hex);
            
            // Apply Calibration
            const r = Math.floor(rawRgb.r * CALIBRATION.r);
            const g = Math.floor(rawRgb.g * CALIBRATION.g);
            const b = Math.floor(rawRgb.b * CALIBRATION.b);

            // Send corrected values to the strip
            await sendCommand(`LED:${r},${g},${b},16`, false); 
        }

        async function applyFavorite(hex) {
            document.getElementById('colorPicker').value = hex;
            handleColorInput(); 
        }

        function loadFavorites() {
            const container = document.getElementById('favGrid');
            container.innerHTML = '';
            let favs = JSON.parse(localStorage.getItem('ledLocalFavs'));
            if (!favs || favs.length === 0) favs = [...DEFAULT_FAVS];
            
            favs.forEach(color => {
                const circle = document.createElement('div');
                circle.className = 'fav-circle';
                circle.style.backgroundColor = color;
                circle.onclick = () => applyFavorite(color);
                container.appendChild(circle);
            });
        }

        function saveCurrentToFavorite() {
            const current = document.getElementById('colorPicker').value;
            let favs = JSON.parse(localStorage.getItem('ledLocalFavs')) || [...DEFAULT_FAVS];
            if (favs.includes(current)) favs = favs.filter(c => c !== current);
            favs.unshift(current);
            favs = favs.slice(0, MAX_FAVS);
            localStorage.setItem('ledLocalFavs', JSON.stringify(favs));
            loadFavorites();
        }

        async function sendCommand(cmd, logIt = true) {
            try {
                const res = await fetch("/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ command: cmd })
                });
                const data = await res.json();
            } catch (e) {
                console.error("Network Error", e);
            }
        }

        async function toggleConnection() {
            const btn = document.getElementById("connBtn");
            const txt = document.getElementById("connStatusText");
            
            btn.disabled = true;
            
            if (!isConnected) {
                txt.textContent = "Requesting Connection...";
                txt.style.color = "#d4a017"; 
                await sendCommand("CONNECT");
                
                let checks = 0;
                const rapidPoll = setInterval(async () => {
                    await pollStatus();
                    checks++;
                    if(isConnected || checks > 15) {
                        clearInterval(rapidPoll);
                        btn.disabled = false;
                        if(!isConnected) {
                             txt.textContent = "DISCONNECTED (Timeout)";
                             txt.style.color = "#333";
                        }
                    }
                }, 1000);
            } else {
                await sendCommand("DISCONNECT");
                setTimeout(pollStatus, 1000);
                setTimeout(() => btn.disabled = false, 2000);
            }
            fetchLogs(); 
        }

        function togglePower() {
             sendCommand("POWER:ON");
        }

        async function pollStatus() {
            try {
                const res = await fetch("/status");
                const data = await res.json();
                if (isConnected !== data.connected) {
                    isConnected = data.connected;
                    updateStatusUI(isConnected);
                }
            } catch (e) {}
        }

        function updateStatusUI(connected) {
            const ind = document.getElementById("connIndicator");
            const txt = document.getElementById("connStatusText");
            const btn = document.getElementById("connBtn");
            
            ind.style.backgroundColor = connected ? "#28a745" : "#dc3545"; 
            txt.textContent = connected ? "CONNECTED" : "DISCONNECTED";
            txt.style.color = "#333";
            btn.textContent = connected ? "Disconnect" : "Connect";
            btn.disabled = false;
        }

        async function fetchLogs() {
            try {
                const res = await fetch("/terminal/logs");
                const logs = await res.json();
                
                const relevantKeywords = ["LED", "Power", "Connect", "Disconnect", "Error", "Serial"];
                
                const filteredLogs = logs.filter(line => {
                    if (line.includes("GET /") || line.includes("POST /") || line.includes("HTTP/1.1")) {
                        return false;
                    }
                    return relevantKeywords.some(keyword => line.toUpperCase().includes(keyword.toUpperCase()));
                });

                const term = document.getElementById("terminal");
                
                if(filteredLogs.length === 0) {
                    term.innerHTML = "<span style='opacity:0.5; font-style:italic'>Waiting for commands...</span>";
                } else {
                    term.innerHTML = filteredLogs.join("\n");
                }
                term.scrollTop = term.scrollHeight;
            } catch (e) {
                console.log("Log fetch error", e);
            }
        }

        function openNav() {
            document.getElementById("mySidebar").style.width = "200px";
            if(window.innerWidth > 600) document.querySelector(".main-content").style.marginLeft = "200px";
        }
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.querySelector(".main-content").style.marginLeft = "0";
        }
        function toggleDarkMode() {
            const body = document.body;
            const next = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            document.getElementById('themeIcon').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

            loadFavorites();
            setInterval(pollStatus, 3000);
            setInterval(fetchLogs, 2000);
            pollStatus();
            fetchLogs();
        });
    </script>
</body>
</html>
