<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED Strip Controls</title>
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
    
    <style>
        /* --- Root Variables --- */
        :root {
            --color-primary: #d2b48c; /* Khaki/Tan */
            --color-secondary: #b08d5c; /* Darker Tan */
            --color-background: #f0f0f0; 
            --color-surface: #ffffff; /* White for control boxes */
            --color-text: #333333;
            --color-shadow: rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        body[data-theme='dark'] {
            --color-background: #1e1e1e;
            --color-surface: #2c2c2c; /* Darker surface for dark mode */
            --color-text: #e0e0e0;
            --color-shadow: rgba(255, 255, 255, 0.08);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            padding: 0; margin: 0;
            transition: background 0.3s, color 0.3s;
        }

        /* --- Layout --- */
        .sidebar {
            height: 100%; width: 0; position: fixed; top: 0; left: 0;
            background-color: var(--color-primary); overflow-x: hidden;
            transition: 0.3s; padding-top: 60px; z-index: 1000;
            box-shadow: 2px 0 5px var(--color-shadow);
        }
        .sidebar a {
            padding: 15px 24px; text-decoration: none; font-size: 18px;
            color: var(--color-text); display: block; transition: 0.2s; font-weight: 500;
        }
        .sidebar a:hover { background-color: var(--color-secondary); color: var(--color-surface); }

        .openbtn {
            font-size: 26px; cursor: pointer; background-color: var(--color-primary);
            color: var(--color-text); padding: 10px 20px; border: none;
            border-radius: 0 0 var(--border-radius) 0; position: fixed;
            top: 0; left: 0; z-index: 1100; box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        #themeToggle {
            position: fixed; top: 15px; right: 15px; background: var(--color-surface);
            color: var(--color-text); border: 1px solid var(--color-text);
            padding: 8px; border-radius: 50%; z-index: 1200;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            transition: background 0.3s;
        }
        
        .main-content {
            margin-left: 0; transition: margin-left 0.3s; padding: 20px;
            max-width: 800px; margin: 0 auto; padding-top: 60px;
        }

        /* --- Header Image --- */
        .header-image {
            width: 100%; max-height: 250px; object-fit: cover;
            border-radius: var(--border-radius); margin-bottom: 20px;
            box-shadow: 0 4px 15px var(--color-shadow);
            display: block;
        }

        h1 {
            text-align: center; margin-bottom: 20px;
            font-weight: 300; color: var(--color-secondary);
        }

        /* --- Control Cards (now all white) --- */
        .control-section {
            background-color: var(--color-surface); /* Reverted to white */
            color: var(--color-text); /* Ensure text is readable */
            padding: 25px;
            border-radius: var(--border-radius); box-shadow: 0 4px 8px var(--color-shadow);
            margin-bottom: 25px; text-align: center;
        }
        
        /* --- Status Indicators --- */
        .status-row {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 0;
        }
        .indicator {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #555; display: inline-block;
            border: 1px solid rgba(0,0,0,0.2);
        }
        
        /* --- Buttons --- */
        button {
            background-color: var(--color-primary); color: var(--color-text);
            border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;
            font-size: 16px; transition: 0.2s ease-in-out; font-weight: 600;
            min-width: 120px;
        }
        button:hover {
            background-color: var(--color-secondary); box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        /* --- Color Picker UI --- */
        .color-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            margin-top: 10px;
        }
        input[type="color"] {
            -webkit-appearance: none; border: none;
            width: 150px; height: 150px;
            cursor: pointer; background: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch {
            border: 4px solid var(--color-text); border-radius: 50%;
            box-shadow: 0 4px 10px var(--color-shadow);
        }

        /* --- Favorites System --- */
        .favorites-grid {
            display: flex; justify-content: center; gap: 20px; margin-top: 20px;
        }
        .fav-circle {
            width: 60px; height: 60px; border-radius: 50%;
            border: 3px solid var(--color-surface); cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        .fav-circle:hover { transform: scale(1.1); border-color: var(--color-primary); }
        
        /* --- Terminal --- */
        .terminal {
            background: var(--color-terminal-bg); color: var(--color-terminal-text);
            font-family: 'Consolas', 'Courier New', monospace; padding: 15px;
            border-radius: 8px; width: 100%; height: 120px; overflow-y: auto;
            font-size: 12px; border: 1px solid var(--color-shadow);
            text-align: left; box-sizing: border-box;
        }

        @media (max-width: 600px) {
            .status-row { flex-direction: column; gap: 15px; }
            button { width: 100%; }
            .connection-card { padding: 20px; }
        }
    </style>
</head>
<body data-theme="light">
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" onclick="closeNav()">‚úñ Close</a>
        <a href="/controls">Controls</a>
        <a href="/">Designs</a> 
        <a href="/led_controls">Led Controls</a>
        <a href="/terminal">Terminal</a>
    </div>

    <button class="openbtn" onclick="openNav()">‚ò∞</button>
    <button id="themeToggle" onclick="toggleDarkMode()">
        <span id="themeIcon">‚òÄÔ∏è</span>
    </button>

    <div class="main-content">
        <img src="{{ url_for('static', filename='led.png') }}" alt="LED Header" class="header-image">

        <h1>LED Controller</h1>

        <div class="control-section">
            <div class="status-row">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div class="indicator" id="connIndicator"></div>
                    <span id="connStatusText" style="font-weight:bold; font-size: 1.1em;">DISCONNECTED</span>
                </div>
            </div>
            <div class="status-row" style="margin-top: 15px;">
                <button onclick="toggleConnection()" id="connBtn">Connect</button>
                <button onclick="togglePower()" id="powerBtn">Power ON/OFF</button>
            </div>
        </div>

        <div class="control-section">
            <h2>Select Color</h2>
            
            <div class="color-wrapper">
                <input type="color" id="colorPicker" value="#ffffff" oninput="handleColorInput()">
                <p style="color: var(--color-text); opacity: 0.7; margin-top:-10px;">Tap circle to change</p>
            </div>

            <div style="margin-top: 30px; border-top: 1px solid var(--color-shadow); padding-top: 20px;">
                <h3>Your Favorite Whites</h3>
                <div class="favorites-grid" id="favGrid">
                    <div style="padding:10px;">Loading...</div>
                </div>
                <button onclick="saveCurrentToFavorite()" style="margin-top:20px;">Save This White</button>
            </div>
        </div>

        <div class="control-section" style="padding:15px;">
            <h3 style="margin-top:0; font-size: 1em; opacity: 0.6;">System Log</h3>
            <div class="terminal" id="terminal">Ready.</div>
        </div>
    </div>

    <script>
        let isConnected = false;
        let debounceTimer;

        // --- CONFIGURATION ---
        const MAX_FAVS = 3; 
        // Default white/soft colors
        const DEFAULT_FAVS = ["#ffffff", "#f0f0f0", "#e0e0e0"]; 

        // --- COLOR LOGIC ---
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
        }

        function handleColorInput() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                sendCurrentState();
            }, 200); // 200ms debounce
        }

        async function sendCurrentState() {
            if (!isConnected) return; 
            const hex = document.getElementById('colorPicker').value;
            const rgb = hexToRgb(hex);
            
            // Hardcoded brightness: 16 (Max)
            const cmd = `LED:${rgb.r},${rgb.g},${rgb.b},16`;
            await sendCommand(cmd, false); 
        }

        async function applyFavorite(hex) {
            document.getElementById('colorPicker').value = hex;
            handleColorInput(); // Trigger send
        }

        // --- LOCAL FAVORITES SYSTEM ---
        function loadFavorites() {
            const container = document.getElementById('favGrid');
            container.innerHTML = '';
            
            // Load from local storage, or use defaults
            let favs = JSON.parse(localStorage.getItem('ledLocalFavs'));
            if (!favs || favs.length === 0) favs = [...DEFAULT_FAVS]; // Copy default array
            
            favs.forEach(color => {
                const circle = document.createElement('div');
                circle.className = 'fav-circle';
                circle.style.backgroundColor = color;
                circle.onclick = () => applyFavorite(color);
                container.appendChild(circle);
            });
        }

        function saveCurrentToFavorite() {
            const current = document.getElementById('colorPicker').value;
            let favs = JSON.parse(localStorage.getItem('ledLocalFavs')) || [...DEFAULT_FAVS];
            
            // Add to front, remove duplicates
            if (favs.includes(current)) {
                favs = favs.filter(c => c !== current); // Remove if exists
            }
            favs.unshift(current); // Add to beginning
            
            // Keep only top MAX_FAVS
            favs = favs.slice(0, MAX_FAVS);
            
            localStorage.setItem('ledLocalFavs', JSON.stringify(favs));
            loadFavorites(); // Reload UI
            logToTerminal(`Saved color ${current} to your favorites.`);
        }

        // --- COMMUNICATIONS ---
        async function sendCommand(cmd, logIt = true) {
            if (logIt) logToTerminal(`Sending: ${cmd}`);
            try {
                const res = await fetch("/send", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ command: cmd })
                });
                const data = await res.json();
                if (!data.success && logIt) logToTerminal(`Error: ${data.error}`, 'error');
            } catch (e) {
                logToTerminal(`Network Error`, 'error');
            }
        }

        async function toggleConnection() {
            const btn = document.getElementById("connBtn");
            btn.disabled = true;
            const cmd = isConnected ? "DISCONNECT" : "CONNECT";
            logToTerminal(`Requesting ${cmd}...`);
            await sendCommand(cmd);
            setTimeout(pollStatus, 1000); 
            setTimeout(() => btn.disabled = false, 2000);
        }

        function togglePower() {
             if(!isConnected) {
                 logToTerminal("Connect Bluetooth first!", "error");
                 return;
             }
             const btn = document.getElementById('powerBtn');
             const isOff = btn.innerText.includes("OFF"); 
             sendCommand(isOff ? "POWER:OFF" : "POWER:ON");
        }

        async function pollStatus() {
            try {
                const res = await fetch("/status");
                const data = await res.json();
                if (isConnected !== data.connected) {
                    isConnected = data.connected;
                    updateStatusUI(isConnected);
                }
            } catch (e) {}
        }

        function updateStatusUI(connected) {
            const ind = document.getElementById("connIndicator");
            const txt = document.getElementById("connStatusText");
            const btn = document.getElementById("connBtn");
            
            ind.style.backgroundColor = connected ? "#28a745" : "#dc3545"; // Green/Red
            txt.textContent = connected ? "CONNECTED" : "DISCONNECTED";
            txt.style.color = connected ? "#333" : "#333"; // Keep dark text
            btn.textContent = connected ? "Disconnect" : "Connect";
            
            if(connected) logToTerminal("Device Connected.");
            else logToTerminal("Device Disconnected.");
        }

        function logToTerminal(msg, type='info') {
            const term = document.getElementById("terminal");
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : 'inherit';
            term.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            term.scrollTop = term.scrollHeight;
        }

        // --- INIT ---
        function openNav() {
            document.getElementById("mySidebar").style.width = "200px";
            if(window.innerWidth > 600) document.querySelector(".main-content").style.marginLeft = "200px";
        }
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.querySelector(".main-content").style.marginLeft = "0";
        }
        function toggleDarkMode() {
            const body = document.body;
            const next = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            document.getElementById('themeIcon').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';

            loadFavorites();
            setInterval(pollStatus, 3000);
            pollStatus();
        });
    </script>
</body>
</html>
