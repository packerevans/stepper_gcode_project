<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Packers Sand Table Control</title>
Â  Â  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
Â  Â  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
Â  Â Â 
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  /* --- Root Variables (Light Mode) --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --color-primary: #d2b48c; /* Khaki/Tan (Button/Sidebar Background) */
Â  Â  Â  Â  Â  Â  --color-secondary: #b08d5c; /* Darker Tan (Button Hover/Accent) */
Â  Â  Â  Â  Â  Â  --color-background: #f0f0f0; /* Light Gray Background */
Â  Â  Â  Â  Â  Â  --color-surface: #ffffff; /* White Card/Container Background */
Â  Â  Â  Â  Â  Â  --color-text: #333333;
Â  Â  Â  Â  Â  Â  --color-shadow: rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  Â  Â  --color-icon: #000000;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Terminal Colors (Light) */
Â  Â  Â  Â  Â  Â  --color-terminal-bg: #e9e9e9;
Â  Â  Â  Â  Â  Â  --color-terminal-text: #333333;
Â  Â  Â  Â  Â  Â  --color-terminal-prompt: #008080; /* Teal/Cyan */
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  --border-radius: 12px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Dark Mode Variables --- */
Â  Â  Â  Â  body[data-theme='dark'] {
Â  Â  Â  Â  Â  Â  --color-background: #1e1e1e;
Â  Â  Â  Â  Â  Â  --color-surface: #2c2c2c;
Â  Â  Â  Â  Â  Â  --color-text: #e0e0e0;
Â  Â  Â  Â  Â  Â  --color-shadow: rgba(255, 255, 255, 0.08);
Â  Â  Â  Â  Â  Â  --color-icon: #ffffff;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Terminal Colors (Dark) */
Â  Â  Â  Â  Â  Â  --color-terminal-bg: #1a1a1a;
Â  Â  Â  Â  Â  Â  --color-terminal-text: #cccccc;
Â  Â  Â  Â  Â  Â  --color-terminal-prompt: #98fb98; /* Pale Green */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Base Styles --- */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--color-background);
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  transition: background 0.3s, color 0.3s;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Sidebar & Header --- */
Â  Â  Â  Â  .sidebar {
Â  Â  Â  Â  Â  Â  height: 100%; width: 0; position: fixed; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary); overflow-x: hidden;
Â  Â  Â  Â  Â  Â  transition: 0.3s; padding-top: 60px; z-index: 1000;
Â  Â  Â  Â  Â  Â  box-shadow: 2px 0 5px var(--color-shadow);
Â  Â  Â  Â  }

Â  Â  Â  Â  .sidebar a {
Â  Â  Â  Â  Â  Â  padding: 15px 24px; text-decoration: none; font-size: 18px;
Â  Â  Â  Â  Â  Â  color: var(--color-text); display: block; transition: 0.2s;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sidebar a:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  Â  Â  color: var(--color-surface);
Â  Â  Â  Â  }

Â  Â  Â  Â  .openbtn {
Â  Â  Â  Â  Â  Â  font-size: 26px; cursor: pointer; background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-text); padding: 10px 20px; border: none;
Â  Â  Â  Â  Â  Â  border-radius: 0 0 var(--border-radius) 0; position: fixed;
Â  Â  Â  Â  Â  Â  top: 0; left: 0; z-index: 1100; box-shadow: 0 2px 5px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Theme Toggle Button --- */
Â  Â  Â  Â  #themeToggle {
Â  Â  Â  Â  Â  Â  position: fixed; top: 15px; right: 15px; background: var(--color-surface);
Â  Â  Â  Â  Â  Â  color: var(--color-icon); border: 1px solid var(--color-icon);
Â  Â  Â  Â  Â  Â  padding: 8px 15px; border-radius: 20px; z-index: 1200;
Â  Â  Â  Â  Â  Â  transition: background 0.3s, color 0.3s, border-color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .main-content {
Â  Â  Â  Â  Â  Â  margin-left: 0; transition: margin-left 0.3s; padding: 20px;
Â  Â  Â  Â  Â  Â  max-width: 1200px; /* Wide enough for calculator */
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  h1 {
Â  Â  Â  Â  Â  Â  text-align: center; margin-top: 20px; margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  font-weight: 300; color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  h2 {
Â  Â  Â  Â  Â  Â  font-weight: 400;
Â  Â  Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--color-shadow);
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header-image {
Â  Â  Â  Â  Â  Â  width: 100%; max-height: 250px; object-fit: cover;
Â  Â  Â  Â  Â  Â  border-radius: var(--border-radius); margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Main Control Container --- */
Â  Â  Â  Â  .control-panel {
Â  Â  Â  Â  Â  Â  background-color: var(--color-surface); padding: 30px;
Â  Â  Â  Â  Â  Â  border-radius: var(--border-radius); box-shadow: 0 4px 10px var(--color-shadow);
Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- NEW Sandify Module --- */
Â  Â  Â  Â  .sandify-module {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 25px;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap; /* Allows wrapping on small screens */
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module img {
Â  Â  Â  Â  Â  Â  width: 100px;
Â  Â  Â  Â  Â  Â  height: 100px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module-content {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  min-width: 250px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module-content h3 {
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module-content p {
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Style the link as a button */
Â  Â  Â  Â  .sandify-module a {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);Â 
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px;
Â  Â  Â  Â  Â  Â  cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module a:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Buttons --- */
Â  Â  Â  Â  /* This will style ALL buttons, including Tailwind ones, to match the theme */
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);Â 
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px;
Â  Â  Â  Â  Â  Â  cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  button:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â  button:disabled {
Â  Â  Â  Â  Â  Â  background-color: #ccc;
Â  Â  Â  Â  Â  Â  color: #777;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Specific button for sending to Arduino */
Â  Â  Â  Â  #send-to-table-btn {
Â  Â  Â  Â  Â  Â  margin-top: 25px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  /* Make it stand out */
Â  Â  Â  Â  Â  Â  background-color: #3b82f6; /* blue-500 */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  #send-to-table-btn:hover {
Â  Â  Â  Â  Â  Â  background-color: #2563eb; /* blue-600 */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- NEW: Style for Manual Next Button --- */
Â  Â  Â  Â  #nextLineButton {
Â  Â  Â  Â  Â  Â  Â background-color: #16a34a; /* green-600 */
Â  Â  Â  Â  Â  Â  Â color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  #nextLineButton:hover {
Â  Â  Â  Â  Â  Â  Â background-color: #15803d; /* green-700 */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* --- NEW: Style for Manual Controls Container --- */
Â  Â  Â  Â  .manual-controls {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  margin-top: 16px;
Â  Â  Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  Â  Â  background-color: var(--color-background);
Â  Â  Â  Â  Â  Â  border-radius: var(--border-radius);
Â  Â  Â  Â  }
Â  Â  Â  Â  .manual-controls label {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Custom styled checkbox */
Â  Â  Â  Â  .manual-controls input[type="checkbox"] {
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  appearance: none;
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  font: inherit;
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  width: 1.15em;
Â  Â  Â  Â  Â  Â  height: 1.15em;
Â  Â  Â  Â  Â  Â  border: 0.1em solid var(--color-text);
Â  Â  Â  Â  Â  Â  border-radius: 0.15em;
Â  Â  Â  Â  Â  Â  transform: translateY(-0.075em);
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  Â  Â  place-content: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .manual-controls input[type="checkbox"]::before {
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  width: 0.65em;
Â  Â  Â  Â  Â  Â  height: 0.65em;
Â  Â  Â  Â  Â  Â  transform: scale(0);
Â  Â  Â  Â  Â  Â  transition: 120ms transform ease-in-out;
Â  Â  Â  Â  Â  Â  box-shadow: inset 1em 1em #2563eb; /* blue-600 */
Â  Â  Â  Â  Â  Â  transform-origin: bottom left;
Â  Â  Â  Â  Â  Â  clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
Â  Â  Â  Â  }
Â  Â  Â  Â  .manual-controls input[type="checkbox"]:checked::before {
Â  Â  Â  Â  Â  Â  transform: scale(1);
Â  Â  Â  Â  }


Â  Â  Â  Â  /* --- Terminal --- */
Â  Â  Â  Â  .terminal {
Â  Â  Â  Â  Â  Â  background: var(--color-terminal-bg); color: var(--color-terminal-text);
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Courier New', monospace; padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 8px; width: 100%; height: 200px; overflow-y: auto;
Â  Â  Â  Â  Â  Â  font-size: 14px; border: 1px solid var(--color-shadow);
Â  Â  Â  Â  Â  Â  white-space: pre-wrap; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  Â  Â  transition: background 0.3s, color 0.3s;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  .terminal .prompt { color: var(--color-terminal-prompt); font-weight: bold; }
Â  Â  Â  Â  .terminal .response { color: var(--color-terminal-text); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Calculator-specific Styles (from your file) --- */
Â  Â  Â  Â  /* We prefix them with .calculator-content to avoid breaking our theme */
Â  Â  Â  Â  .calculator-content {
Â  Â  Â  Â  Â  Â  font-family: "Inter", sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--color-surface); /* Use theme surface color */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content canvas {
Â  Â  Â  Â  Â  Â  touch-action: none;
Â  Â  Â  Â  Â  Â  border: 1px solid #d1d5db; /* gray-300 */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content textarea {
Â  Â  Â  Â  Â  Â  height: 300px;
Â  Â  Â  Â  Â  Â  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
Â  Â  Â  Â  Â  Â  font-size: 0.875rem; /* text-sm */
Â  Â  Â  Â  Â  Â  /* Make textareas match theme */
Â  Â  Â  Â  Â  Â  background: var(--color-background);
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content input[type=range]::-webkit-slider-thumb {
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #2563eb; /* blue-600 */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-top: -6px; /* Center thumb on track */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content input[type=range]::-moz-range-thumb {
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #2563eb; /* blue-600 */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Override Tailwind colors to match theme */
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .bg-white {
Â  Â  Â  Â  Â  Â  background: var(--color-surface) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .text-gray-800,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .text-gray-700,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .text-gray-600 {
Â  Â  Â  Â  Â  Â  color: var(--color-text) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .bg-gray-100,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .bg-gray-50 {
Â  Â  Â  Â  Â  Â  Â background: var(--color-background) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .border,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .border-gray-300,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .border-gray-200 {
Â  Â  Â  Â  Â  Â  border-color: #555 !important;
Â  Â  Â  Â  }

Â  Â  </style>
</head>

<body data-theme="light">

Â  Â  <div id="mySidebar" class="sidebar">
Â  Â  Â  Â  <a href="javascript:void(0)" onclick="closeNav()">âœ– Close</a>
Â  Â  Â  Â  <a href="{{ url_for('index') }}">Manual Command</a>
Â  Â  Â  Â  <a href="{{ url_for('led_controls') }}">LED Controls</a>
Â  Â  Â  Â  <a href="{{ url_for('script') }}">Bulk Commands</a>
Â  Â  Â  Â  <a href="{{ url_for('terminal') }}">Terminal</a>
Â  Â  </div>

Â  Â  <button class="openbtn" onclick="openNav()">â˜°</button>
Â  Â  <button id="themeToggle" onclick="toggleDarkMode()">
Â  Â  Â  Â  <span id="themeIcon">â˜€ï¸</span>
Â  Â  </button>

Â  Â  <div class="main-content">
Â  Â  Â  Â  <img src="{{ url_for('static', filename='sand.png') }}" alt="Sand Table Header" class="header-image">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="control-panel sandify-module">
Â  Â  Â  Â  Â  Â  <img src="{{ url_for('static', filename='sandify.png') }}" alt="Sandify Logo">
Â  Â  Â  Â  Â  Â  <div class="sandify-module-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Sandify</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Unleash intricate patterns with this powerful, web-based G-code creator!</p>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://sandify.org/" target="_blank" rel="noopener noreferrer">Open Sandify</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="control-panel">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="calculator-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full max-w-7xl mx-auto bg-white rounded-lg p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-bold text-gray-800 mb-4">Interactive G-Code Converter</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border border-gray-300 p-3 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-sm font-medium text-gray-700 px-1">Initial Start Position</legend>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="initialX" class="block text-xs font-medium text-gray-600">Start X</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="initialX" value="203.2" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="initialY" class="block text-xs font-medium text-gray-600">Start Y</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="initialY" value="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border border-gray-300 p-3 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-sm font-medium text-gray-700 px-1">Preferred Solution (Constant)</legend>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-around mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="solution" value="up" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300" checked>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-green-700 font-medium">Elbow Up</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="solution" value="down" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-blue-700 font-medium">Elbow Down</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </fieldset>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="convertButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow transition duration-150 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Convert G-Code
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow w-full aspect-square rounded-lg overflow-hidden mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="ikCanvas" class="bg-white rounded-lg w-full h-full"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="stepSlider" class="block text-sm font-medium text-gray-700 mb-1">Step: <span id="stepLabel" class="font-bold">0 / 0</span></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="stepSlider" min="0" max="0" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="inputGcode" class="block text-sm font-medium text-gray-700 mb-1">Input G-Code (Cartesian)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="inputGcode" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" spellcheck="false">G1 X0 Y0
G1 X0 Y203.2
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="outputGcode" class="block text-sm font-medium text-gray-700">Converted G-Code (Motor Steps)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="warningIndicator" class="hidden text-sm font-medium text-yellow-600 flex items-center gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-yellow-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path fill-rule="evenodd" d="M8.485 2.495c.646-1.136 2.376-1.136 3.022 0l7.25 12.72c.646 1.136-.192 2.53-1.51 2.53H2.744c-1.32 0-2.158-1.395-1.51-2.53l7.25-12.72zM9 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm1-7a1 1 0 0 1 1 1v4a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1z" clip-rule="evenodd" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Warnings
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="outputGcode" class="w-full p-3 border border-gray-300 bg-gray-50 rounded-md shadow-sm" readonly></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="copyButton" class="absolute right-3 top-3 bg-gray-700 hover:bg-gray-600 text-white text-xs font-medium py-1 px-2 rounded-md transition-all duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Copy
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="copySuccess" class="absolute right-3 top-3 text-green-500 text-xs font-medium hidden bg-gray-700 py-1 px-2 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Copied!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="warningMessages" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-md text-xs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button id="send-to-table-btn" onclick="sendGcodeFromCalculator()">
Â  Â  Â  Â  Â  Â  Â  Â  Send Commands
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="manual-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="manualModeCheckbox">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="manualModeCheckbox">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Manual Step-by-Step
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="nextLineButton" onclick="sendManualLine()" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Send Next Line
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div> <h2>Live Terminal Log</h2>
Â  Â  Â  Â  <div id="terminal" class="terminal"></div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Sidebar Functions ---
Â  Â  Â  Â  function openNav() {
Â  Â  Â  Â  Â  Â  document.getElementById("mySidebar").style.width = "200px";
Â  Â  Â  Â  Â  Â  const main = document.querySelector(".main-content");
Â  Â  Â  Â  Â  Â  if (main) main.style.marginLeft = "200px";
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeNav() {
Â  Â  Â  Â  Â  Â  document.getElementById("mySidebar").style.width = "0";
Â  Â  Â  Â  Â  Â  const main = document.querySelector(".main-content");
Â  Â  Â  Â  Â  Â  if (main) main.style.marginLeft = "auto";
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Dark Mode Toggle ---
Â  Â  Â  Â  function updateThemeIcon(theme) {
Â  Â  Â  Â  Â  Â  document.getElementById('themeIcon').textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleDarkMode() {
Â  Â  Â  Â  Â  Â  const body = document.body;
Â  Â  Â  Â  Â  Â  const currentTheme = body.getAttribute('data-theme');
Â  Â  Â  Â  Â  Â  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  body.setAttribute('data-theme', newTheme);
Â  Â  Â  Â  Â  Â  localStorage.setItem('theme', newTheme);
Â  Â  Â  Â  Â  Â  updateThemeIcon(newTheme);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Terminal Logger ---
Â  Â  Â  Â  // (Also logs to browser console for easier debugging)
Â  Â  Â  Â  function appendToTerminal(text, isCommand = false) {
Â  Â  Â  Â  Â  Â  const term = document.getElementById("terminal");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Log to console first
Â  Â  Â  Â  Â  Â  if (isCommand) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`> ${text}`);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`[Response] ${text}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!term) return; // Don't fail if terminal isn't on the page
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const line = document.createElement("div");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isCommand) {
Â  Â  Â  Â  Â  Â  Â  Â  line.innerHTML = `<span class="prompt">[${new Date().toLocaleTimeString()}] > </span><span class="response">${text}</span>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  line.innerHTML = `<span class="response">[${new Date().toLocaleTimeString()}] ${text}</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  term.appendChild(line);
Â  Â  Â  Â  Â  Â  term.scrollTop = term.scrollHeight;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- State for Manual G-code ---
Â  Â  Â  Â  let manualGcodeLines = [];
Â  Â  Â  Â  let manualCurrentLineIndex = 0;
Â  Â  Â  Â  let isManualJobActive = false;

Â  Â  Â  Â  // --- MODIFIED Function to send G-code ---
Â  Â  Â  Â  function sendGcodeFromCalculator() {
Â  Â  Â  Â  Â  Â  const sendButton = document.getElementById('send-to-table-btn');
Â  Â  Â  Â  Â  Â  const manualCheckbox = document.getElementById('manualModeCheckbox');
Â  Â  Â  Â  Â  Â  const nextButton = document.getElementById('nextLineButton');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let gcodeText = "";
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const outputBox = document.getElementById('outputGcode');
Â  Â  Â  Â  Â  Â  Â  Â  if (!outputBox) throw new Error("Could not find 'outputGcode' element.");
Â  Â  Â  Â  Â  Â  Â  Â  gcodeText = outputBox.value;
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Error reading from calculator: ${e.message}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!gcodeText.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal("Calculator output text box is empty.", false);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Check Mode ---
Â  Â  Â  Â  Â  Â  if (manualCheckbox.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  // --- MANUAL MODE ---
Â  Â  Â  Â  Â  Â  Â  Â  manualGcodeLines = gcodeText.split('\n')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(line => line.split(';')[0].trim()) // Clean comments
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(line => line.toUpperCase().startsWith('G1')); // Filter for G1
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (manualGcodeLines.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal("No valid G1 commands found for manual mode.", false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  manualCurrentLineIndex = 0;
Â  Â  Â  Â  Â  Â  Â  Â  isManualJobActive = true;

Â  Â  Â  Â  Â  Â  Â  Â  // Update UI for manual job
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  manualCheckbox.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  nextButton.style.display = 'block'; // Show the 'Next' button
Â  Â  Â  Â  Â  Â  Â  Â  nextButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Starting manual job with ${manualGcodeLines.length} lines.`, true);
Â  Â  Â  Â  Â  Â  Â  Â  // Send the first line immediately
Â  Â  Â  Â  Â  Â  Â  Â  sendManualLine();

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // --- AUTOMATIC (DRIP) MODE ---
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.textContent = "Sending...";
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal("Sending G-code block to server (auto-drip)...", true);

Â  Â  Â  Â  Â  Â  Â  Â  fetch("/send_gcode_block", {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ gcode: gcodeText })
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => response.json())
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Server response: ${data.message}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Error: ${data.error || 'Unknown Error'}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Network Error: ${error.message}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendButton.textContent = "Send Commands";
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Function for sending one manual line ---
Â  Â  Â  Â  function sendManualLine() {
Â  Â  Â  Â  Â  Â  if (!isManualJobActive || manualCurrentLineIndex >= manualGcodeLines.length) {
Â  Â  Â  Â  Â  Â  Â  Â  if(isManualJobActive) appendToTerminal("Manual job finished.", false);
Â  Â  Â  Â  Â  Â  Â  Â  resetManualJobState();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nextButton = document.getElementById('nextLineButton');
Â  Â  Â  Â  Â  Â  const line = manualGcodeLines[manualCurrentLineIndex];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Disable button while sending
Â  Â  Â  Â  Â  Â  nextButton.disabled = true;
Â  Â  Â  Â  Â  Â  nextButton.textContent = "Sending...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  appendToTerminal(`Sending line ${manualCurrentLineIndex + 1}/${manualGcodeLines.length}: ${line}`, true);

Â  Â  Â  Â  Â  Â  fetch("/send_single_gcode_line", { // NEW ENDPOINT
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ gcode_line: line })
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(response => response.json())
Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Server ACK: ${data.message}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  manualCurrentLineIndex++; // Only increment on success
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (manualCurrentLineIndex >= manualGcodeLines.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal("Manual job finished.", false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetManualJobState();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Error on line ${manualCurrentLineIndex + 1}: ${data.error || 'Unknown Error'}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal("Aborting manual job.", false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resetManualJobState(); // Abort on error
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Network Error: ${error.message}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal("Aborting manual job.", false);
Â  Â  Â  Â  Â  Â  Â  Â  resetManualJobState(); // Abort on error
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (isManualJobActive) { // Don't re-enable if job just finished
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextButton.textContent = `Send Next (${manualCurrentLineIndex + 1}/${manualGcodeLines.length})`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Helper to reset UI ---
Â  Â  Â  Â  function resetManualJobState() {
Â  Â  Â  Â  Â  Â  isManualJobActive = false;
Â  Â  Â  Â  Â  Â  manualGcodeLines = [];
Â  Â  Â  Â  Â  Â  manualCurrentLineIndex = 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const sendButton = document.getElementById('send-to-table-btn');
Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  sendButton.textContent = document.getElementById('manualModeCheckbox').checked ? "Start Manual Job" : "Send Commands";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('manualModeCheckbox').disabled = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const nextButton = document.getElementById('nextLineButton');
Â  Â  Â  Â  Â  Â  nextButton.style.display = 'none';
Â  Â  Â  Â  Â  Â  nextButton.textContent = "Send Next Line";
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Initialization ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  // Load theme from local storage
Â  Â  Â  Â  Â  Â  const savedTheme = localStorage.getItem('theme') || 'light';
Â  Â  Â  Â  Â  Â  document.body.setAttribute('data-theme', savedTheme);
Â  Â  Â  Â  Â  Â  updateThemeIcon(savedTheme);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  appendToTerminal("System ready. Bulk command page initialized.", false);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Add listener to update button text ---
Â  Â  Â  Â  Â  Â  const manualCheckbox = document.getElementById('manualModeCheckbox');
Â  Â  Â  Â  Â  Â  const sendButton = document.getElementById('send-to-table-btn');
Â  Â  Â  Â  Â  Â  if (manualCheckbox && sendButton) {
Â  Â  Â  Â  Â  Â  Â  Â  manualCheckbox.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendButton.textContent = "Start Manual Job";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sendButton.textContent = "Send Commands";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>

Â  Â  <script>
Â  Â  Â  Â  // --- Fixed Constants ---
Â  Â  Â  Â  const L1_LENGTH = 101.6;
Â  Â  Â  Â  const L2_LENGTH = 101.6;
Â  Â  Â  Â  const MAX_REACH = L1_LENGTH + L2_LENGTH;
Â  Â  Â  Â  const MIN_REACH = Math.abs(L1_LENGTH - L2_LENGTH);
Â  Â  Â  Â  const DEG_TO_STEPS = 3200 / 360;
Â  Â  Â  Â  const Q1_OFFSET_DEG = 90;Â  // Arm 1 "0" is 90deg (Up)
Â  Â  Â  Â  const Q2_OFFSET_DEG = 180; // Arm 2 "0" is 180deg (Folded)
Â  Â  Â  Â  const EPSILON = 1e-6; // Small value for float comparison
Â  Â  Â  Â  // const SEGMENT_LENGTH = 5.0; // NO LONGER NEEDED

Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  function getCalculatorElements() {
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  initialXInput: document.getElementById('initialX'),
Â  Â  Â  Â  Â  Â  Â  Â  initialYInput: document.getElementById('initialY'),
Â  Â  Â  Â  Â  Â  Â  Â  convertButton: document.getElementById('convertButton'),
Â  Â  Â  Â  Â  Â  Â  Â  inputGcodeEl: document.getElementById('inputGcode'),
Â  Â  Â  Â  Â  Â  Â  Â  outputGcodeEl: document.getElementById('outputGcode'),
Â  Â  Â  Â  Â  Â  Â  Â  copyButton: document.getElementById('copyButton'),
Â  Â  Â  Â  Â  Â  Â  Â  copySuccess: document.getElementById('copySuccess'),
Â  Â  Â  Â  Â  Â  Â  Â  canvas: document.getElementById('ikCanvas'),
Â  Â  Â  Â  Â  Â  Â  Â  ctx: document.getElementById('ikCanvas') ? document.getElementById('ikCanvas').getContext('2d') : null,
Â  Â  Â  Â  Â  Â  Â  Â  warningIndicator: document.getElementById('warningIndicator'),
Â  Â  Â  Â  Â  Â  Â  Â  warningMessages: document.getElementById('warningMessages'),
Â  Â  Â  Â  Â  Â  Â  Â  stepSlider: document.getElementById('stepSlider'),
Â  Â  Â  Â  Â  Â  Â  Â  stepLabel: document.getElementById('stepLabel')
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- State ---
Â  Â  Â  Â  let canvasSize = 0;
Â  Â  Â  Â  let scale = 1;
Â  Â  Â  Â  let originX = 0;
Â  Â  Â  Â  let originY = 0;
Â  Â  Â  Â  let globalPathSegments = []; // Stores the calculated path segments

Â  Â  Â  Â  // --- Utility Functions ---
Â  Â  Â  Â  function toDegrees(radians) {
Â  Â  Â  Â  Â  Â  return radians * (180 / Math.PI);
Â  Â  Â  Â  }
Â  Â  Â  Â  function toRadians(degrees) {
Â  Â  Â  Â  Â  Â  return degrees * (Math.PI / 180);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Calculates Inverse Kinematics for a given point.
Â  Â  Â  Â  Â * @returns {object} { solution1, solution2, clampedX, clampedY, isClamped, error }
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function calculateIK(l1, l2, x, y) {
Â  Â  Â  Â  Â  Â  let dSq = x * x + y * y;
Â  Â  Â  Â  Â  Â  let d = Math.sqrt(dSq);
Â  Â  Â  Â  Â  Â  let clampedX = x;
Â  Â  Â  Â  Â  Â  let clampedY = y;
Â  Â  Â  Â  Â  Â  let isClamped = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Clamping Logic ---
Â  Â  Â  Â  Â  Â  // Check if truly outside max reach (beyond float error)
Â  Â  Â  Â  Â  Â  if (d > MAX_REACH + EPSILON) { 
Â  Â  Â  Â  Â  Â  Â  Â  isClamped = true;
Â  Â  Â  Â  Â  Â  Â  Â  const ratio = MAX_REACH / d; // Clamp *to* max reach
Â  Â  Â  Â  Â  Â  Â  Â  clampedX = x * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  clampedY = y * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  d = MAX_REACH;
Â  Â  Â  Â  Â  Â  Â  Â  dSq = d * d;
Â  Â  Â  Â  Â  Â  } 
Â  Â  Â  Â  Â  Â  // Check if inside min reach (but not at origin)
Â  Â  Â  Â  Â  Â  else if (d < MIN_REACH - EPSILON) { 
Â  Â  Â  Â  Â  Â  Â  Â  if (d < EPSILON) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // At origin (0,0), d is effectively 0. Do nothing.
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isClamped = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ratio = MIN_REACH / d; // Clamp *to* min reach
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clampedX = x * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clampedY = y * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d = MIN_REACH;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dSq = d * d;
Â  Â  Â  Â  Â  _ Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // If d is on the boundary (or within EPSILON), just adjust d for the math
Â  Â  Â  Â  Â  Â  // This prevents Math.acos from getting NaN without triggering a warning
Â  Â  Â  Â  Â  Â  else if (d > MAX_REACH) {
Â  Â  Â  Â  Â  Â  Â  Â  d = MAX_REACH;
Â  Â  Â  Â  Â  Â  Â  Â  dSq = d * d;
Â  Â  Â  Â  Â  Â  } else if (d < MIN_REACH) {
Â  Â  Â  Â  Â  Â  Â  Â  d = MIN_REACH;
Â  Â  Â  Â  Â  Â  Â  Â  dSq = d * d;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- IK Calculation (on potentially clamped values) ---
Â  Â  Â  Â  Â  Â  const cosQ2 = (dSq - l1 * l1 - l2 * l2) / (2 * l1 * l2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Handle precision errors at max/min reach
Â  Â  Â  Â  Â  Â  const clampedCosQ2 = Math.max(-1, Math.min(1, cosQ2));

Â  Â  Â  Â  Â  Â  // Handle (0,0) singularity for q1
Â  Â  Â  Â  Â  Â  if (d < EPSILON) {
Â  Â  Â  Â  Â  Â  Â  Â  const home_q1_rad = toRadians(Q1_OFFSET_DEG); // 90 deg
Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solution1: { q1: home_q1_rad, q2: Math.acos(clampedCosQ2) }, // q2 = pi (Elbow Down)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solution2: { q1: home_q1_rad, q2: -Math.acos(clampedCosQ2) }, // q2 = -pi (Elbow Up)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clampedX, clampedY, isClamped
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // sol1 = Elbow Down (positive q2)
Â  Â  Â  Â  Â  Â  const q2_rad_sol1 = Math.acos(clampedCosQ2);
Â  Â  Â  Â  Â  Â  // sol2 = Elbow Up (negative q2)
Â  Â  Â  Â  Â  Â  const q2_rad_sol2 = -Math.acos(clampedCosQ2);

Â  Â  Â  Â  Â  Â  const k1_sol1 = l1 + l2 * Math.cos(q2_rad_sol1);
Â  Â  Â  Â  Â  Â  const k2_sol1 = l2 * Math.sin(q2_rad_sol1);
Â  Â  Â  Â  Â  Â  const q1_rad_sol1 = Math.atan2(clampedY, clampedX) - Math.atan2(k2_sol1, k1_sol1);

Â  Â  Â  Â  Â  Â  const k1_sol2 = l1 + l2 * Math.cos(q2_rad_sol2);
Â  Â  Â  Â  Â  Â  const k2_sol2 = l2 * Math.sin(q2_rad_sol2);
Â  Â  Â  Â  Â  Â  const q1_rad_sol2 = Math.atan2(clampedY, clampedX) - Math.atan2(k2_sol2, k1_sol2);

Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  solution1: { q1: q1_rad_sol1, q2: q2_rad_sol1 }, // Elbow Down
Â  Â  Â  Â  Â  Â  Â  Â  solution2: { q1: q1_rad_sol2, q2: q2_rad_sol2 }, // Elbow Up
Â  Â  Â  Â  Â  Â  Â  Â  clampedX, clampedY, isClamped
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Drawing Functions ---
Â  Â  Â  Â  function resizeCanvas() {
Â  Â  Â  Â  Â  Â  const { canvas, ctx, stepSlider } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dpr = window.devicePixelRatio || 1;
Â  Â  Â  Â  Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  if (rect.width === 0) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  canvas.width = rect.width * dpr;
Â  Â  Â  Â  Â  Â  canvas.height = rect.height * dpr;
Â  Â  Â  Â  Â  Â  ctx.scale(dpr, dpr);
Â  Â  Â  Â  Â  Â  canvasSize = rect.width;
Â  Â  Â  Â  Â  Â  originX = canvasSize / 2;
Â  Â  Â  Â  Â  Â  originY = canvasSize / 2;
Â  Â  Â  Â  Â  Â  drawToStep(stepSlider.value);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawGrid() {
Â  Â  Â  Â  Â  Â  const { canvas, ctx } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;
Â  Â  Â  Â  Â  Â  scale = (canvasSize / 2) * 0.9 / MAX_REACH;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.clearRect(0, 0, canvasSize, canvasSize);
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.translate(originX, originY);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Grid, Axes, Reach Circle... (as before, no changes)
Â  Â  Â  Â  Â  Â  const gridSize = 50 * scale;
Â  Â  Â  Â  Â  Â  const steps = Math.ceil(originX / gridSize);
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#e5e7eb'; // gray-200
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;
Â  Â  Â  Â  Â  Â  for (let i = -steps; i <= steps; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(i * gridSize, -originY); ctx.lineTo(i * gridSize, originY);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(-originX, i * gridSize); ctx.lineTo(originX, i * gridSize);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#9ca3af'; // gray-400
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 2;
Â  Â  Â  Â  Â  Â  ctx.moveTo(-originX, 0); ctx.lineTo(originX, 0); // X Axis
Â  Â  Â  Â  Â  Â  ctx.moveTo(0, -originY); ctx.lineTo(0, originY); // Y Axis
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.arc(0, 0, MAX_REACH * scale, 0, 2 * Math.PI);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#3b82f6'; // blue-500
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;
Â  Â  Â  Â  Â  Â  ctx.setLineDash([5, 5]);
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  ctx.setLineDash([]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  // Draws just the path segments (lines)
Â  Â  Â  Â  function drawPathSegments(segments) {
Â  Â  Â  Â  Â  Â  const { canvas, ctx } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.translate(originX, originY);
Â  Â  Â  Â  Â  Â  ctx.scale(1, -1); // Flip Y-axis

Â  Â  Â  Â  Â  Â  for (const segment of segments) {
Â  Â  Â  Â  Â  Â  Â  Â  // Do not draw "prep" moves, which have same start/end
Â  Â  Â  Â  Â  Â  Â  Â  if (segment.startX === segment.endX && segment.startY === segment.endY) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(segment.startX * scale, segment.startY * scale);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineTo(segment.endX * scale, segment.endY * scale);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // We're not interpolating, so all lines are "complex" arcs
Â  Â  Â  Â  Â  Â  Â  Â  // Let's color them differently
Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = segment.isClamped ? '#ef4444' : '#f97316'; // red-500 or orange-500
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 2;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.setLineDash([2, 4]); // Draw arcs as dashed lines
Â  Â  Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ctx.setLineDash([]);
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Draws the arm at a specific X, Y cartesian coordinate AND solution
Â  Â  Â  Â  function drawArmAtPosition(x, y, solution) {
Â  Â  Â  Â  Â  Â  const { canvas, ctx } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;
Â  Â  Â  Â  Â  Â  const result = calculateIK(L1_LENGTH, L2_LENGTH, x, y);
Â  Â  Â  Â  Â  Â  if (result.error) return;

Â  Â  Â  Â  Â  Â  const angles = (solution === 'down') ? result.solution1 : result.solution2;
Â  Â  Â  Â  Â  Â  const { q1, q2 } = angles;
Â  Â  Â  Â  Â  Â  const color = (solution === 'down') ? '#0ea5e9' : '#2563eb'; // 'up' is blue-600, 'down' is cyan-500

Â  Â  Â  Â  Â  Â  const joint1X = (L1_LENGTH * Math.cos(q1)) * scale;
Â  Â  Â  Â  Â  Â  const joint1Y = (L1_LENGTH * Math.sin(q1)) * scale;

Â  Â  Â  Â  Â  Â  const endEffectorX = (L1_LENGTH * Math.cos(q1) + L2_LENGTH * Math.cos(q1 + q2)) * scale;
Â  Â  Â  Â  Â  Â  const endEffectorY = (L1_LENGTH * Math.sin(q1) + L2_LENGTH * Math.sin(q1 + q2)) * scale;

Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.translate(originX, originY);
Â  Â  Â  Â  Â  Â  ctx.scale(1, -1); // Flip Y-axis

Â  Â  Â  Â  Â  Â  // Draw Arm 1
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.moveTo(0, 0);
Â  Â  Â  Â  Â  Â  ctx.lineTo(joint1X, joint1Y);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = color;
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 8;
Â  Â  Â  Â  Â  Â  ctx.lineCap = 'round';
Â  Â  Â  Â  Â  Â  ctx.stroke();

Â  Â  Â  Â  Â  Â  // Draw Arm 2
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.moveTo(joint1X, joint1Y);
Â  Â  Â  Â  Â  Â  ctx.lineTo(endEffectorX, endEffectorY);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = color;
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 8;
Â  Â  Â  Â  Â  Â  ctx.lineCap = 'round';
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw Joints
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.arc(0, 0, 10, 0, 2 * Math.PI); // Base joint
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#4b5563'; // gray-600
Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.arc(joint1X, joint1Y, 8, 0, 2 * Math.PI); // Elbow joint
Â  Â  Â  Â  Â  Â  ctx.fillStyle = color;
Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw Target Point
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.arc(endEffectorX, endEffectorY, 10, 0, 2 * Math.PI);
Â  Â  Â  Â  Â  Â  ctx.fillStyle = color;
Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#ffffff';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  // Main drawing function: draws grid, path, and arm
Â  Â  Â  Â  function drawToStep(stepIndex) {
Â  Â  Â  Â  Â  Â  const { canvas, initialXInput, initialYInput } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !initialXInput || !initialYInput) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  stepIndex = parseInt(stepIndex, 10);
Â  Â  Â  Â  Â  Â  drawGrid();

Â  Â  Â  Â  Â  Â  const segmentsToDraw = globalPathSegments.slice(0, stepIndex);
Â  Â  Â  Â  Â  Â  drawPathSegments(segmentsToDraw);

Â  Â  Â  Â  Â  Â  let finalX, finalY, finalSolution;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (stepIndex === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  finalX = parseFloat(initialXInput.value || "203.2");
Â  Â  Â  Â  Â  Â  Â  Â  finalY = parseFloat(initialYInput.value || "0");
Â  Â  Â  Â  Â  Â  Â  Â  finalSolution = document.querySelector('input[name="solution"]:checked').value;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const lastSegment = segmentsToDraw[stepIndex - 1];
Â  Â  Â  Â  Â  Â  Â  Â  finalX = lastSegment.endX;
Â  Â  Â  Â  Â  Â  Â  Â  finalY = lastSegment.endY;
Â  Â  Â  Â  Â  Â  Â  Â  finalSolution = lastSegment.endSolution; // Use the solution we ended up with
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  drawArmAtPosition(finalX, finalY, finalSolution);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- HELPER: Calculates motor steps from angle deltas ---
Â  Â  Â  Â  function calculateGcode(startAngles, endAngles) {
Â  Â  Â  Â  Â  Â  const delta_q1_deg = toDegrees(endAngles.q1 - startAngles.q1);
Â  Â  Â  Â  Â  Â  const delta_q2_deg = toDegrees(endAngles.q2 - startAngles.q2);

Â  Â  Â  Â  Â  Â  const delta_motor1_deg = delta_q1_deg;
Â  Â  Â  Â  Â  Â  const delta_motor2_deg = delta_q1_deg + delta_q2_deg;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const motor1_steps = Math.round(delta_motor1_deg * DEG_TO_STEPS);
Â  Â  Â  Â  Â  Â  const motor2_steps = Math.round((0.125 * motor1_steps) + (delta_motor2_deg * DEG_TO_STEPS));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Avoid sending 0 0 commands
Â  Â  Â  Â  Â  Â  if (motor1_steps === 0 && motor2_steps === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return { gcode: null, motor1_steps: 0, motor2_steps: 0 };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const gcode = `G1 ${motor2_steps} ${motor1_steps} 1000`;
Â  Â  Â  Â  Â  Â  return { gcode, motor1_steps, motor2_steps };
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- HELPER: Calculates the "cost" (sum of squared motor change) ---
Â  Â  Â  Â  function getAngleCost(anglesA, anglesB) {
Â  Â  Â  Â  Â  Â  const delta_q1_deg = toDegrees(anglesB.q1 - anglesA.q1);
Â  Â  Â  Â  Â  Â  const delta_q2_deg = toDegrees(anglesB.q2 - anglesA.q2);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const delta_motor1_deg = delta_q1_deg;
Â  Â  Â  Â  Â  Â  const delta_motor2_deg = delta_q1_deg + delta_q2_deg;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Return sum of squares
Â  Â  Â  Â  Â  Â  return (delta_motor1_deg * delta_motor1_deg) + (delta_motor2_deg * delta_motor2_deg);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- *NEW* Main Conversion Logic (Lookahead at (0,0) only) ---
Â  Â  Â  Â  function handleConversion() {
Â  Â  Â  Â  Â  Â  const els = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!els.inputGcodeEl || !els.initialXInput || !els.initialYInput || !els.warningIndicator || !els.warningMessages || !els.outputGcodeEl || !els.stepSlider) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const inputGcode = els.inputGcodeEl.value;
Â  Â  Â  Â  Â  Â  const lines = inputGcode.split('\n');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Get the user's *initial* preferred solution
Â  Â  Â  Â  Â  Â  let currentSolution = document.querySelector('input[name="solution"]:checked').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let currentX = parseFloat(els.initialXInput.value || "203.2");
Â  Â  Â  Â  Â  Â  let currentY = parseFloat(els.initialYInput.value || "0");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Reset state ---
Â  Â  Â  Â  Â  Â  els.warningIndicator.classList.add('hidden');
Â  Â  Â  Â  Â  Â  els.warningMessages.classList.add('hidden');
Â  Â  Â  Â  Â  Â  els.warningMessages.querySelector('ul').innerHTML = '';
Â  Â  Â  Â  Â  Â  globalPathSegments = []; // Clear previous path

Â  Â  Â  Â  Â  Â  if (isNaN(currentX) || isNaN(currentY)) {
Â  Â  Â  Â  Â  Â  Â  Â  // ... (error handling as before) ...
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let outputGcode = [];
Â  Â  Â  Â  Â  Â  let warnings = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Step 1: Parse all valid G1 commands first ---
Â  Â  Â  Â  Â  Â  const g1Commands = [];
Â  Â  Â  Â  Â  Â  for (const [index, line] of lines.entries()) {
Â  Â  Â  Â  Â  Â  Â  Â  const trimmedLine = line.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const g1Match = trimmedLine.toUpperCase().match(/^G1\s+/);
Â  Â  Â  Â  Â  Â  Â  Â  if (g1Match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const xMatch = trimmedLine.match(/X\s*(-?[\d\.]+)/i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const yMatch = trimmedLine.match(/Y\s*(-?[\d\.]+)/i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (xMatch || yMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  g1Commands.push({ line: trimmedLine, index: index + 1, xMatch, yMatch });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Step 2: Iterate through the parsed commands with lookahead ---
Â  Â  Â  Â  Â  Â  for (let i = 0; i < g1Commands.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const command = g1Commands[i];
Â  Â  Â  Â  Â  Â  Â  Â  const nextCommand = (i + 1 < g1Commands.length) ? g1Commands[i+1] : null;

Â  Â  Â  Â  Â  Â  Â  Â  const P_start = { x: currentX, y: currentY };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Determine target (P_mid)
Â  Â  Â  Â  Â  Â  Â  Â  const targetX = command.xMatch ? parseFloat(command.xMatch[1]) : currentX;
Â  Â  Â  Â  Â  Â  Â  Â  const targetY = command.yMatch ? parseFloat(command.yMatch[1]) : currentY;
Â  Â  Â  Â  Â  Â  Â  Â  const P_mid = { x: targetX, y: targetY };

Â  Â  Â  Â  Â  Â  Â  Â  // --- Calculate IK for this move (A -> B) ---
Â  Â  Â  Â  Â  Â  Â  Â  const startResult = calculateIK(L1_LENGTH, L2_LENGTH, P_start.x, P_start.y);
Â  Â  Â  Â  Â  Â  Â  Â  const midResult = calculateIK(L1_LENGTH, L2_LENGTH, P_mid.x, P_mid.y);

Â  Â  Â  Â  Â  Â  Â  Â  if (startResult.error || midResult.error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  warnings.push(`Line ${command.index} ('${command.line}'): Calculation failed.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (midResult.isClamped) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  warnings.push(`Line ${command.index} ('${command.line}'): Target unreachable, clamped to (${midResult.clampedX.toFixed(2)}, ${midResult.clampedY.toFixed(2)}).`);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Get angles based on the *current* solution
Â  Â  Â  Â  Â  Â  Â  Â  const startAngles = (currentSolution === 'down') ? startResult.solution1 : startResult.solution2;
Â  Â  Â  Â  Â  Â  Â  Â  const midAngles_current = (currentSolution === 'down') ? midResult.solution1 : midResult.solution2;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- Add G-code for the A -> B move ---
Â  Â  Â  Â  Â  Â  Â  Â  const moveGcode = calculateGcode(startAngles, midAngles_current);
Â  Â  Â  Â  Â  Â  Â  Â  if(moveGcode.gcode) outputGcode.push(moveGcode.gcode);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  globalPathSegments.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startX: P_start.x,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startY: P_start.y,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endX: midResult.clampedX,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endY: midResult.clampedY,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isClamped: midResult.isClamped,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endSolution: currentSolution // Solution we *arrived* with
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Update current position to the (potentially clamped) midpoint
Â  Â  Â  Â  Â  Â  Â  Â  currentX = midResult.clampedX;
Â  Â  Â  Â  Â  Â  Â  Â  currentY = midResult.clampedY;

Â  Â  Â  Â  Â  Â  Â  Â  // --- Lookahead Logic: Decide if a "prep" move is needed at P_mid ---
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Check if we are at the origin
Â  Â  Â  Â  Â  Â  Â  Â  const atOrigin = (currentX * currentX + currentY * currentY) < EPSILON;

Â  Â  Â  Â  Â  Â  Â  Â  if (nextCommand && atOrigin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Lookahead: At origin (0,0), checking for prep move.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Determine next target (P_end)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextTargetX = nextCommand.xMatch ? parseFloat(nextCommand.xMatch[1]) : currentX; // Start from new currentX
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextTargetY = nextCommand.yMatch ? parseFloat(nextCommand.yMatch[1]) : currentY; // Start from new currentY
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const P_end = { x: nextTargetX, y: nextTargetY };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endResult = calculateIK(L1_LENGTH, L2_LENGTH, P_end.x, P_end.y);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (endResult.error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  warnings.push(`Lookahead for Line ${nextCommand.index} failed.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Get the *other* solution for P_mid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const otherSolution = (currentSolution === 'up') ? 'down' : 'up';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const midAngles_other = (otherSolution === 'down') ? midResult.solution1 : midResult.solution2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Get both potential solution angles for P_end
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endAngles_current = (currentSolution === 'down') ? endResult.solution1 : endResult.solution2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endAngles_other = (otherSolution === 'down') ? endResult.solution1 : endResult.solution2;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Calculate cost of B -> C (staying on current solution)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cost_stay = getAngleCost(midAngles_current, endAngles_current);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Calculate cost of B -> C (switching to other solution)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cost_switch = getAngleCost(midAngles_other, endAngles_other);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Decision ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cost_switch <= cost_stay) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Lookahead: Prep move is cheaper. Adding.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // It's "cheaper" to switch. Add the prep move.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prepGcode = calculateGcode(midAngles_current, midAngles_other);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(prepGcode.gcode) outputGcode.push(prepGcode.gcode + ` ; Prep move at (0,0)`);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add a "dummy" segment for the slider (no length, but holds new solution)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globalPathSegments.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startX: currentX, startY: currentY,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endX: currentX, endY: currentY,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isClamped: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endSolution: otherSolution // Solution we are *switching* to
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL: Update the current solution for the *next* loop iteration
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentSolution = otherSolution;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Lookahead: Staying with current solution is cheaper. No prep move.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (nextCommand) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log(`Lookahead: Not at origin. Prep move disabled.`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } // --- End of for loop ---

Â  Â  Â  Â  Â  Â  // --- Finalize ---
Â  Â  Â  Â  Â  Â  els.outputGcodeEl.value = outputGcode.join('\n');
Â  Â  Â  Â  Â  Â  els.stepSlider.max = globalPathSegments.length;
Â  Â  Â  Â  Â  Â  els.stepSlider.value = globalPathSegments.length;
Â  Â  Â  Â  Â  Â  els.stepLabel.textContent = `${globalPathSegments.length} / ${globalPathSegments.length}`;
Â  Â  Â  Â  Â  Â  drawToStep(globalPathSegments.length);

Â  Â  Â  Â  Â  Â  // --- Show Warnings if any ---
Â  Â  Â  Â  Â  Â  if (warnings.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const uniqueWarnings = [...new Set(warnings)];
Â  Â  Â  Â  Â  Â  Â  Â  els.warningIndicator.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  els.warningMessages.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  els.warningMessages.querySelector('ul').innerHTML = uniqueWarnings.map(w => `<li>${w}</li>`).join('');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Slider Event ---
Â  Â  Â  Â  function handleSliderChange(event) {
Â  Â  Â  Â  Â  Â  const { stepLabel, stepSlider } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!stepLabel || !stepSlider) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const step = event.target.value;
Â  Â  Â  Â  Â  Â  stepLabel.textContent = `${step} / ${stepSlider.max}`;
Â  Â  Â  Â  Â  Â  drawToStep(step);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Copy Button Logic ---
Â  Â  Â  Â  function setupCopyButton() {
Â  Â  Â  Â  Â  Â  const { copyButton, outputGcodeEl, copySuccess } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!copyButton || !outputGcodeEl || !copySuccess) return;

Â  Â  Â  Â  Â  Â  copyButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const textToCopy = outputGcodeEl.value;
Â  Â  Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(textToCopy).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copySuccess.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyButton.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copySuccess.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyButton.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback for http or other issues
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const textArea = document.createElement('textarea');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textArea.value = textToCopy;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textArea.style.position = 'fixed';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textArea.style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(textArea);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textArea.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  textArea.select();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(textArea);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copySuccess.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyButton.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copySuccess.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyButton.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Fallback copy failed: ', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initial Setup ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  const { convertButton, stepSlider } = getCalculatorElements();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (convertButton) {
Â  Â  Â  Â  Â  Â  Â  Â  convertButton.addEventListener('click', handleConversion);
Â  Â  Â  Â  Â  Â  Â  Â  stepSlider.addEventListener('input', handleSliderChange);
Â  Â  Â  Â  Â  Â  Â  Â  window.addEventListener('resize', resizeCanvas);
Â  Â  Â  Â  Â  Â  Â  Â  setupCopyButton();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resizeCanvas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleConversion(); // Run once on load
Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>