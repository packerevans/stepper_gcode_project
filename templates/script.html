<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Packers Sand Table Control</title>
Â  Â  <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
Â  Â  <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
Â  Â Â 
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  /* --- Root Variables (Light Mode) --- */
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --color-primary: #d2b48c; /* Khaki/Tan (Button/Sidebar Background) */
Â  Â  Â  Â  Â  Â  --color-secondary: #b08d5c; /* Darker Tan (Button Hover/Accent) */
Â  Â  Â  Â  Â  Â  --color-background: #f0f0f0; /* Light Gray Background */
Â  Â  Â  Â  Â  Â  --color-surface: #ffffff; /* White Card/Container Background */
Â  Â  Â  Â  Â  Â  --color-text: #333333;
Â  Â  Â  Â  Â  Â  --color-shadow: rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  Â  Â  --color-icon: #000000;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Terminal Colors (Light) */
Â  Â  Â  Â  Â  Â  --color-terminal-bg: #e9e9e9;
Â  Â  Â  Â  Â  Â  --color-terminal-text: #333333;
Â  Â  Â  Â  Â  Â  --color-terminal-prompt: #008080; /* Teal/Cyan */
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  --border-radius: 12px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Dark Mode Variables --- */
Â  Â  Â  Â  body[data-theme='dark'] {
Â  Â  Â  Â  Â  Â  --color-background: #1e1e1e;
Â  Â  Â  Â  Â  Â  --color-surface: #2c2c2c;
Â  Â  Â  Â  Â  Â  --color-text: #e0e0e0;
Â  Â  Â  Â  Â  Â  --color-shadow: rgba(255, 255, 255, 0.08);
Â  Â  Â  Â  Â  Â  --color-icon: #ffffff;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Terminal Colors (Dark) */
Â  Â  Â  Â  Â  Â  --color-terminal-bg: #1a1a1a;
Â  Â  Â  Â  Â  Â  --color-terminal-text: #cccccc;
Â  Â  Â  Â  Â  Â  --color-terminal-prompt: #98fb98; /* Pale Green */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Base Styles --- */
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--color-background);
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  transition: background 0.3s, color 0.3s;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- Sidebar & Header --- */
Â  Â  Â  Â  .sidebar {
Â  Â  Â  Â  Â  Â  height: 100%; width: 0; position: fixed; top: 0; left: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary); overflow-x: hidden;
Â  Â  Â  Â  Â  Â  transition: 0.3s; padding-top: 60px; z-index: 1000;
Â  Â  Â  Â  Â  Â  box-shadow: 2px 0 5px var(--color-shadow);
Â  Â  Â  Â  }

Â  Â  Â  Â  .sidebar a {
Â  Â  Â  Â  Â  Â  padding: 15px 24px; text-decoration: none; font-size: 18px;
Â  Â  Â  Â  Â  Â  color: var(--color-text); display: block; transition: 0.2s;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sidebar a:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  Â  Â  color: var(--color-surface);
Â  Â  Â  Â  }

Â  Â  Â  Â  .openbtn {
Â  Â  Â  Â  Â  Â  font-size: 26px; cursor: pointer; background-color: var(--color-primary);
Â  Â  Â  Â  Â  Â  color: var(--color-text); padding: 10px 20px; border: none;
Â  Â  Â  Â  Â  Â  border-radius: 0 0 var(--border-radius) 0; position: fixed;
Â  Â  Â  Â  Â  Â  top: 0; left: 0; z-index: 1100; box-shadow: 0 2px 5px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Theme Toggle Button --- */
Â  Â  Â  Â  #themeToggle {
Â  Â  Â  Â  Â  Â  position: fixed; top: 15px; right: 15px; background: var(--color-surface);
Â  Â  Â  Â  Â  Â  color: var(--color-icon); border: 1px solid var(--color-icon);
Â  Â  Â  Â  Â  Â  padding: 8px 15px; border-radius: 20px; z-index: 1200;
Â  Â  Â  Â  Â  Â  transition: background 0.3s, color 0.3s, border-color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .main-content {
Â  Â  Â  Â  Â  Â  margin-left: 0; transition: margin-left 0.3s; padding: 20px;
Â  Â  Â  Â  Â  Â  max-width: 1200px; /* Wide enough for calculator */
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  }

Â  Â  Â  Â  h1 {
Â  Â  Â  Â  Â  Â  text-align: center; margin-top: 20px; margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  font-weight: 300; color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  h2 {
Â  Â  Â  Â  Â  Â  font-weight: 400;
Â  Â  Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--color-shadow);
Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .header-image {
Â  Â  Â  Â  Â  Â  width: 100%; max-height: 250px; object-fit: cover;
Â  Â  Â  Â  Â  Â  border-radius: var(--border-radius); margin-bottom: 30px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 15px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Main Control Container --- */
Â  Â  Â  Â  .control-panel {
Â  Â  Â  Â  Â  Â  background-color: var(--color-surface); padding: 30px;
Â  Â  Â  Â  Â  Â  border-radius: var(--border-radius); box-shadow: 0 4px 10px var(--color-shadow);
Â  Â  Â  Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- NEW Sandify Module --- */
Â  Â  Â  Â  .sandify-module {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 25px;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap; /* Allows wrapping on small screens */
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module img {
Â  Â  Â  Â  Â  Â  width: 100px;
Â  Â  Â  Â  Â  Â  height: 100px;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  Â  Â  border: 2px solid var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module-content {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  min-width: 250px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module-content h3 {
Â  Â  Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  Â  Â  Â  color: var(--color-secondary);
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module-content p {
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Style the link as a button */
Â  Â  Â  Â  .sandify-module a {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);Â 
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px;
Â  Â  Â  Â  Â  Â  cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  Â  .font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  .sandify-module a:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Buttons --- */
Â  Â  Â  Â  /* This will style ALL buttons, including Tailwind ones, to match the theme */
Â  Â  Â  Â  button {
Â  Â  Â  Â  Â  Â  background-color: var(--color-primary);Â 
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px;
Â  Â  Â  Â  Â  Â  cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  button:hover {
Â  Â  Â  Â  Â  Â  background-color: var(--color-secondary);
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 8px var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â  button:disabled {
Â  Â  Â  Â  Â  Â  background-color: #ccc;
Â  Â  Â  Â  Â  Â  color: #777;
Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Specific button for sending to Arduino */
Â  Â  Â  Â  #send-to-table-btn {
Â  Â  Â  Â  Â  Â  margin-top: 25px;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  /* Make it stand out */
Â  Â  Â  Â  Â  Â  background-color: #3b82f6; /* blue-500 */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  #send-to-table-btn:hover {
Â  Â  Â  Â  Â  Â  background-color: #2563eb; /* blue-600 */
Â  Â  Â  Â  }


Â  Â  Â  Â  /* --- Terminal --- */
Â  Â  Â  Â  .terminal {
Â  Â  Â  Â  Â  Â  background: var(--color-terminal-bg); color: var(--color-terminal-text);
Â  Â  Â  Â  Â  Â  font-family: 'Consolas', 'Courier New', monospace; padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 8px; width: 100%; height: 200px; overflow-y: auto;
Â  Â  Â  Â  Â  Â  font-size: 14px; border: 1px solid var(--color-shadow);
Â  Â  Â  Â  Â  Â  white-space: pre-wrap; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  Â  Â  transition: background 0.3s, color 0.3s;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  .terminal .prompt { color: var(--color-terminal-prompt); font-weight: bold; }
Â  Â  Â  Â  .terminal .response { color: var(--color-terminal-text); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- Calculator-specific Styles (from your file) --- */
Â  Â  Â  Â  /* We prefix them with .calculator-content to avoid breaking our theme */
Â  Â  Â  .calculator-content {
Â  Â  Â  Â  Â  Â  font-family: "Inter", sans-serif;
Â  Â  Â  Â  Â  Â  background: var(--color-surface); /* Use theme surface color */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content canvas {
Â  Â  Â  Â  Â  Â  touch-action: none;
Â  Â  Â  Â  Â  Â  border: 1px solid #d1d5db; /* gray-300 */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content textarea {
Â  Â  Â  Â  Â  Â  height: 300px;
Â  Â  Â  Â  Â  Â  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
Â  Â  Â  Â  Â  Â  font-size: 0.875rem; /* text-sm */
Â  Â  Â  Â  Â  Â  /* Make textareas match theme */
Â  Â  Â  Â  Â  Â  background: var(--color-background);
Â  Â  Â  Â  Â  Â  color: var(--color-text);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--color-shadow);
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content input[type=range]::-webkit-slider-thumb {
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #2563eb; /* blue-600 */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  margin-top: -6px; /* Center thumb on track */
Â  Â  Â  Â  }
Â  Â  Â  Â  .calculator-content input[type=range]::-moz-range-thumb {
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  background: #2563eb; /* blue-600 */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Override Tailwind colors to match theme */
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .bg-white {
Â  Â  Â  Â  Â  Â  background: var(--color-surface) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .text-gray-800,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .text-gray-700,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .text-gray-600 {
Â  Â  Â  Â  Â  Â  color: var(--color-text) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .bg-gray-100,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .bg-gray-50 {
Â  Â  Â  Â  Â  Â  Â background: var(--color-background) !important;
Â  Â  Â  Â  }
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .border,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .border-gray-300,
Â  Â  Â  Â  body[data-theme='dark'] .calculator-content .border-gray-200 {
Â  Â  Â  Â  Â  Â  border-color: #555 !important;
Â  Â  Â  Â  }

Â  Â  </style>
</head>

<body data-theme="light">

Â  Â  <div id="mySidebar" class="sidebar">
Â  Â  Â  Â  <a href="javascript:void(0)" onclick="closeNav()">âœ– Close</a>
Â  Â  Â  Â  <a href="{{ url_for('index') }}">Manual Command</a>
Â  Â  Â  Â  <a href="{{ url_for('led_controls') }}">LED Controls</a>
Â  Â  Â  Â  <a href="{{ url_for('script') }}">Bulk Commands</a>
Â  Â  Â  Â  <a href="{{ url_for('terminal') }}">Terminal</a>
Â  Â  </div>

Â  Â  <button class="openbtn" onclick="openNav()">â˜°</button>
Â  Â  <button id="themeToggle" onclick="toggleDarkMode()">
Â  Â  Â  Â  <span id="themeIcon">â˜€ï¸</span>
Â  Â  </button>

Â  Â  <div class="main-content">
Â  Â  Â  Â  <img src="{{ url_for('static', filename='sand.png') }}" alt="Sand Table Header" class="header-image">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="control-panel sandify-module">
Â  Â  Â  Â  Â  Â  <img src="{{ url_for('static', filename='sandify.png') }}" alt="Sandify Logo">
Â  Â  Â  Â  Â  Â  <div class="sandify-module-content">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>Sandify</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <p>Unleash intricate patterns with this powerful, web-based G-code creator!</p>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://sandify.org/" target="_blank" rel="noopener noreferrer">Open Sandify</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="control-panel">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="calculator-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-full max-w-7xl mx-auto bg-white rounded-lg p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-bold text-gray-800 mb-4">Interactive G-Code Converter</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border border-gray-300 p-3 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-sm font-medium text-gray-700 px-1">Initial Start Position</legend>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="initialX" class="block text-xs font-medium text-gray-600">Start X</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="initialX" value="203.6" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="initialY" class="block text-xs font-medium text-gray-600">Start Y</label>
Ã‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="initialY" value="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <fieldset class="border border-gray-300 p-3 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <legend class="text-sm font-medium text-gray-700 px-1">Preferred Solution (Constant)</legend>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-around mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="solution" value="up" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300" checked>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-green-700 font-medium">Elbow Up</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="solution" value="down" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm text-blue-700 font-medium">Elbow Down</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </fieldset>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="convertButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow transition duration-150 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Convert G-Code
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow w-full aspect-square rounded-lg overflow-hidden mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="ikCanvas" class="bg-white rounded-lg w-full h-full"></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="stepSlider" class="block text-sm font-medium text-gray-700 mb-1">Step: <span id="stepLabel" class="font-bold">0 / 0</span></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="stepSlider" min="0" max="0" value="0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
content...
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="inputGcode" class="block text-sm font-medium text-gray-700 mb-1">Input G-Code (Cartesian)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="inputGcode" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" spellcheck="false">; File name: 'sandify'
;
; BEGIN LAYER: 0 Polygon
G1 X31.500 Y32.500
G1 X-35.500 Y32.500
G1 X-35.500 Y-34.500
G1 X31.500 Y-34.500
G1 X31.500 Y32.500
; Test clamping
G1 X100.000 Y200.000
G1 X101.600 Y101.600
; END LAYER: 0 Polygon
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="outputGcode" class="block text-sm font-medium text-gray-700">Converted G-Code (Motor Steps)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="warningIndicator" class="hidden text-sm font-medium text-yellow-600 flex items-center gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 text-yellow-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path fill-rule="evenodd" d="M8.485 2.495c.646-1.136 2.376-1.136 3.022 0l7.25 12.72c.646 1.136-.192 2.53-1.51 2.53H2.744c-1.32 0-2.158-1.395-1.51-2.53l7.25-12.72zM9 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm1-7a1 1 0 0 1 1 1v4a1 1 0 1 1-2 0V6a1 1 0 0 1 1-1z" clip-rule="evenodd" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Warnings
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="outputGcode" class="w-full p-3 border border-gray-300 bg-gray-50 rounded-md shadow-sm" readonly></textarea>
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="copyButton" class="absolute right-3 top-3 bg-gray-700 hover:bg-gray-600 text-white text-xs font-medium py-1 px-2 rounded-md transition-all duration-150">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Copy
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="copySuccess" class="absolute right-3 top-3 text-green-500 text-xs font-medium hidden bg-gray-700 py-1 px-2 rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Copied!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="warningMessages" class="hidden mt-2 p-3 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-md text-xs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="list-disc list-inside space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
s
Â  Â  Â  Â  Â  Â  </div> <button id="send-to-table-btn" onclick="sendGcodeFromCalculator()">
Â  Â  Â  Â  Â  Â  Â  Â  Send Commands
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  </div> <h2>Live Terminal Log</h2>
Â  Â  Â  Â  <div id="terminal" class="terminal"></div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- Sidebar Functions ---
Â  Â  Â  Â  function openNav() {
Â  Â  Â  Â  Â  Â  document.getElementById("mySidebar").style.width = "200px";
Â  Â  Â  Â  Â  Â  // Adjust margin for wider content
Â  Â  Â  Â  Â  Â  const main = document.querySelector(".main-content");
Â  Â  Â  Â  Â  Â  if (main) main.style.marginLeft = "200px";
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeNav() {
Â  Â  Â  Â  Â  Â  document.getElementById("mySidebar").style.width = "0";
Â  Â  Â  Â  Â  Â  const main = document.querySelector(".main-content");
Â  Â  Â  Â  Â  Â  if (main) main.style.marginLeft = "auto"; // Center again
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Dark Mode Toggle ---
Â  Â  Â  Â  function updateThemeIcon(theme) {
Â  Â  Â  Â  Â  Â  document.getElementById('themeIcon').textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleDarkMode() {
Â  Â  Â  Â  Â  Â  const body = document.body;
Â  Â  Â  Â  Â  Â  const currentTheme = body.getAttribute('data-theme');
Â  Â  Â  Â  Â  Â  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  body.setAttribute('data-theme', newTheme);
s
Â  Â  Â  Â  Â  Â  localStorage.setItem('theme', newTheme);
Â  Â  Â  Â  Â  Â  updateThemeIcon(newTheme);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Terminal Logger ---
Â  Â  Â  Â  function appendToTerminal(text, isCommand = false) {
Â  Â  Â  Â  Â  Â  const term = document.getElementById("terminal");
Â  Â  Â  Â  Â  Â  if (!term) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const line = document.createElement("div");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isCommand) {
Â  Â  Â  Â  Â  Â  Â  Â  line.innerHTML = `<span class="prompt">[${new Date().toLocaleTimeString()}] > </span><span class="response">${text}</span>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  line.innerHTML = `<span class="response">[${new Date().toLocaleTimeString()}] ${text}</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  term.appendChild(line);
Â  Â  Â  Â  Â  Â  term.scrollTop = term.scrollHeight;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Function to send the G-code block from the CALCULATOR ---
Â  Â  Â  Â  function sendGcodeFromCalculator() {
Â  Â  Â  Â  Â  Â  const sendButton = document.getElementById('send-to-table-btn');
Â  Â  Â  Â  Â  Â  let gcodeText = "";

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Get the text from the calculator's output box (it's on the same page now)
Â  Â  Â  Â  Â  Â  Â  Â  const outputBox = document.getElementById('outputGcode');
Â  Â  Â  Â  Â  Â  Â  Â  if (!outputBox) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Could not find 'outputGcode' element.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  gcodeText = outputBox.value;
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Error reading from calculator: ${e.message}`, false);
s
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!gcodeText.trim()) {
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal("Calculator output text box is empty.", false);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Disable button to prevent double-sending
Â  Â  Â  Â  Â  Â  sendButton.disabled = true;
Â  Â  Â  Â  Â  Â  sendButton.textContent = "Sending...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  appendToTerminal("Sending G-code block to server...", true);

Â  Â  Â  Â  Â  Â  // This fetch uses the SAME route as your old script.html, so app.py needs NO changes.
Â  Â  Â  Â  Â  Â  fetch("/send_gcode_block", {
Â  Â  Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ gcode: gcodeText })
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .then(response => response.json())
Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  if (data.success) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Server response: ${data.message}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Error: ${data.error || 'Unknown Error'}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  appendToTerminal(`Network Error: ${error.message}`, false);
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â  // === BUTTON TEXT CHANGED ===
Â  Â  Â  Â  Â  Â  Â  Â  // Re-enable the button after the server responds
s
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  sendButton.textContent = "Send Commands";
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initialization ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  // Load theme from local storage
Â  Â  Â  Â  Â  Â  const savedTheme = localStorage.getItem('theme') || 'light';
Â  Â  Â  Â  Â  Â  document.body.setAttribute('data-theme', savedTheme);
Â  Â  Â  Â  Â  Â  updateThemeIcon(savedTheme);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  appendToTerminal("System ready. Bulk command page initialized.", false);
Â  Â  Â  Â  });
Â  Â  </script>

Â  Â  <script>
Â  Â  Â  Â  // --- Fixed Constants ---
Â  Â  Â  Â  const L1_LENGTH = 101.6;
Â  Â  Â  Â  const L2_LENGTH = 101.6;
Â  Â  Â  Â  const MAX_REACH = L1_LENGTH + L2_LENGTH;
Â  Â  Â  Â  const MIN_REACH = Math.abs(L1_LENGTH - L2_LENGTH);
Â  Â  Â  Â  const DEG_TO_STEPS = 3200 / 360;
Â  Â  Â  Â  const Q1_OFFSET_DEG = 90;Â  // Arm 1 "0" is 90deg (Up)
Â  Â  Â  Â  const Q2_OFFSET_DEG = 180; // Arm 2 "0" is 180deg (Folded)
Â  Â  Â  Â  const EPSILON = 1e-6; // Small value for float comparison

Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  // We use a function to get these to make sure they exist
Â  Â  Â  Â  // on this page before we try to use them.
Â  Â  Â  Â  function getCalculatorElements() {
Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  initialXInput: document.getElementById('initialX'),
Â  Â  Â  Â  Â  Â  Â  Â  initialYInput: document.getElementById('initialY'),
Â  Â  Â  Â  Â  Â  Â  Â  convertButton: document.getElementById('convertButton'),
Â  Â  Â  Â  Â  Â  Â  Â  inputGcodeEl: document.getElementById('inputGcode'),
Â  Â  Â  Â  Â  Â  Â  Â  outputGcodeEl: document.getElementById('outputGcode'),
Â  Â  Â  Â  Â  Â  Â  Â  copyButton: document.getElementById('copyButton'),
Â  Â  Â  Â  Â  Â  Â  Â  copySuccess: document.getElementById('copySuccess'),
Â  Â  Â  Â  Â  Â  Â  Â  canvas: document.getElementById('ikCanvas'),
Â  Â  Â  Â  Â  Â  Â  Â  ctx: document.getElementById('ikCanvas') ? document.getElementById('ikCanvas').getContext('2d') : null,
Â  Â  Â  Â  Â  Â  Â  Â  warningIndicator: document.getElementById('warningIndicator'),
Â  Â  Â  Â  Â  Â  Â  Â  warningMessages: document.getElementById('warningMessages'),
Â  Â  Â  Â  Â  Â  Â  Â  stepSlider: document.getElementById('stepSlider'),
Â  Â  Â  Â  Â  Â  Â  Â  stepLabel: document.getElementById('stepLabel')
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- State ---
Â  Â  Â  Â  let canvasSize = 0;
Â  Â  Â  Â  let scale = 1;
Â  Â  Â  Â  let originX = 0;
Â  Â  Â  Â  let originY = 0;
Â  Â  Â  Â  let globalPathSegments = []; // Stores the calculated path

Â  Â  Â  Â  // --- Utility Functions ---
Â  Â  Â  Â  function toDegrees(radians) {
Â  Â  Â  Â  Â  Â  return radians * (180 / Math.PI);
Â  Â  Â  Â  }
Â  Â  Â  Â  function toRadians(degrees) {
Â  Â  Â  Â  Â  Â  return degrees * (Math.PI / 180);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Calculates Inverse Kinematics for a given point.
Â  Â  Â  Â  Â * This function now also CLAMPS unreachable points.
Â  Â  Â  Â  Â * @returns {object} { solution1, solution2, clampedX, clampedY, isClamped, error }
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function calculateIK(l1, l2, x, y) {
Â  Â  Â  Â  Â  Â  let dSq = x * x + y * y;
Â  Â  Â  Â  Â  Â  let d = Math.sqrt(dSq);
Â  Â  Â  Â  Â  Â  let clampedX = x;
Â  Â  Â  Â  Â  Â  let clampedY = y;
Â  Â  Â  Â  Â  Â  let isClamped = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Clamping Logic ---
Â  Â  Â  Â  Â  Â  if (d > MAX_REACH - EPSILON) {
Â  Â  Â  Â  Â  Â  Â  Â  isClamped = true;
Â  Â  Â  Â  Â  Â  Â  Â  const ratio = MAX_REACH / d;
Â  Â  Â  Â  Â  Â  Â  Â  clampedX = x * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  clampedY = y * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  d = MAX_REACH;
Â  Â  Â  Â  Â  Â  Â  Â  dSq = d * d;
Â  Â  Â  Â  Â  Â  } else if (d < MIN_REACH + EPSILON) {
Â  Â  Â  Â  Â  Â  Â  Â  if (d < EPSILON) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // At origin (0,0), which is a valid home pos.
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isClamped = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ratio = MIN_REACH / d;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clampedX = x * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clampedY = y * ratio;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d = MIN_REACH;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dSq = d * d;
Â  s
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- IK Calculation (on potentially clamped values) ---
Â  Â  Â  Â  Â  Â  const cosQ2 = (dSq - l1 * l1 - l2 * l2) / (2 * l1 * l2);
Â  Â  Â  Â  Â  Â  const clampedCosQ2 = Math.max(-1, Math.min(1, cosQ2));

Â  Â  Â  Â  Â  Â  // Handle (0,0) singularity for q1
Â  Â  Â  Â  Â  Â  if (d < EPSILON) {
Â  Â  Â  Â  Â  Â  Â  Â  const home_q1_rad = toRadians(Q1_OFFSET_DEG); // 90 deg
Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solution1: { q1: home_q1_rad, q2: Math.acos(clampedCosQ2) }, // q2 = pi
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  solution2: { q1: home_q1_rad, q2: -Math.acos(clampedCosQ2) }, // q2 = -pi
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clampedX, clampedY, isClamped
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // sol1 = Elbow Down (positive q2)
Â  Â  Â  Â  Â  Â  const q2_rad_sol1 = Math.acos(clampedCosQ2);
Â  Â  Â  Â  Â  Â  // sol2 = Elbow Up (negative q2)
Â  Â  Â  Â  Â  Â  const q2_rad_sol2 = -Math.acos(clampedCosQ2);

s
Â  Â  Â  Â  Â  Â  const k1_sol1 = l1 + l2 * Math.cos(q2_rad_sol1);
Â  Â  Â  Â  Â  Â  const k2_sol1 = l2 * Math.sin(q2_rad_sol1);
Â  Â  Â  Â  Â  Â  const q1_rad_sol1 = Math.atan2(clampedY, clampedX) - Math.atan2(k2_sol1, k1_sol1);

Â  Â  Â  Â  Â  Â  const k1_sol2 = l1 + l2 * Math.cos(q2_rad_sol2);
Â  Â  Â  Â  Â  Â  const k2_sol2 = l2 * Math.sin(q2_rad_sol2);
Â  Â  Â  Â  Â  Â  const q1_rad_sol2 = Math.atan2(clampedY, clampedX) - Math.atan2(k2_sol2, k1_sol2);

Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  solution1: { q1: q1_rad_sol1, q2: q2_rad_sol1 }, // Elbow Down
Â  Â  Â  Â  Â  Â  Â  Â  solution2: { q1: q1_rad_sol2, q2: q2_rad_sol2 }, // Elbow Up
Â  Â  Â  Â  Â  Â  Â  Â  clampedX, clampedY, isClamped
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Drawing Functions ---
Â  Â  Â  Â  function resizeCanvas() {
Â  Â  Â  Â  Â  Â  const { canvas, ctx, stepSlider } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const dpr = window.devicePixelRatio || 1;
Â  Â  Â  Â  Â  Â  const rect = canvas.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  if (rect.width === 0) return; // Don't draw if canvas is hidden/not sized
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  canvas.width = rect.width * dpr;
Â  Â  Â  Â  Â  Â  canvas.height = rect.height * dpr;
Â  Â  Â  Â  Â  Â  ctx.scale(dpr, dpr);
Â  Â  Â  Â  Â  Â  canvasSize = rect.width;
Â  Â  Â  Â  Â  Â  originX = canvasSize / 2;
Â  Â  Â  Â  Â  Â  originY = canvasSize / 2;
Â  Â  Â  Â  Â  Â  drawToStep(stepSlider.value); // Redraw at current step
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawGrid() {
Â  Â  Â  Â  Â  Â  const { canvas, ctx } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;
Â  Â  Â  Â  Â  Â  scale = (canvasSize / 2) * 0.9 / MAX_REACH; // Use 90% of canvas for max reach
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.clearRect(0, 0, canvasSize, canvasSize);
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.translate(originX, originY);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw grid
Â  Â  Â  Â  Â  Â  const gridSize = 50 * scale;
Â  Â  Â  Â  Â  Â  const steps = Math.ceil(originX / gridSize);
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#e5e7eb'; // gray-200
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;
Â  Â  Â  Â  Â  Â  for (let i = -steps; i <= steps; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(i * gridSize, -originY); ctx.lineTo(i * gridSize, originY);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(-originX, i * gridSize); ctx.lineTo(originX, i * gridSize);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw axes
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#9ca3af'; // gray-400
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 2;
Â  Â  Â  Â  Â  Â  ctx.moveTo(-originX, 0); ctx.lineTo(originX, 0); // X Axis
Â  Â  Â  Â  Â  Â  ctx.moveTo(0, -originY); ctx.lineTo(0, originY); // Y Axis
Â  Â  Â  Â  Â  Â  ctx.stroke();

Â  Â  Â  Â  Â  Â  // Draw Max Reach Circle
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.arc(0, 0, MAX_REACH * scale, 0, 2 * Math.PI);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#3b82f6'; // blue-500
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 1;
Â  Â  Â  Â  Â  Â  ctx.setLineDash([5, 5]);
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  ctx.setLineDash([]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  // Draws just the path segments (lines)
Â  Â  Â  Â  function drawPathSegments(segments) {
Â  Â  Â  Â  Â  Â  const { canvas, ctx } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.translate(originX, originY);
Â  Â  Â  Â  Â  Â  ctx.scale(1, -1); // Flip Y-axis

Â  Â  Â  Â  Â  Â  for (const segment of segments) {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.moveTo(segment.startX * scale, segment.startY * scale);
s
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineTo(segment.endX * scale, segment.endY * scale);
Â  Â  Â  Â  Â  Â  Â  Â  ctx.strokeStyle = segment.isClamped ? '#ef4444' : '#22c55e'; // red-500 or green-500
Â  Â  Â  Â  Â  Â  Â  Â  ctx.lineWidth = 2;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Draws the arm at a specific X, Y cartesian coordinate
Â  Â  Â  Â  function drawArmAtPosition(x, y, color) {
Â  Â  Â  Â  Â  Â  const { canvas, ctx } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !ctx) return;
Â  Â  Â  Â  Â  Â  const result = calculateIK(L1_LENGTH, L2_LENGTH, x, y);
Â  Â  Â  Â  Â  Â  if (result.error) return;

Â  Â  Â  Â  Â  Â  const preferredSolution = document.querySelector('input[name="solution"]:checked').value;
Â  Â  Â  Â  Â  Â  const angles = (preferredSolution === 'down') ? result.solution1 : result.solution2;
Â  Â  Â  Â  Â  Â  const { q1, q2 } = angles;

Â  Â  Â  Â  Â  Â  const joint1X = (L1_LENGTH * Math.cos(q1)) * scale;
Â  Â  Â  Â  Â  Â  const joint1Y = (L1_LENGTH * Math.sin(q1)) * scale;

Â  Â  Â  Â  Â  Â  const endEffectorX = (L1_LENGTH * Math.cos(q1) + L2_LENGTH * Math.cos(q1 + q2)) * scale;
Â  Â  Â  Â  Â  Â  const endEffectorY = (L1_LENGTH * Math.sin(q1) + L2_LENGTH * Math.sin(q1 + q2)) * scale;

Â  Â  Â  Â  Â  Â  ctx.save();
s
Â  Â  Â  Â  Â  Â  ctx.translate(originX, originY);
Â  Â  Â  Â  Â  Â  ctx.scale(1, -1); // Flip Y-axis

Â  Â  Â  Â  Â  Â  // Draw Arm 1
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.moveTo(0, 0);
Â  Â  Â  Â  Â  Â  ctx.lineTo(joint1X, joint1Y);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = color;
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 8;
Â  Â  Â  Â  Â  Â  ctx.lineCap = 'round';
Â  Â  Â  Â  Â  Â  ctx.stroke();

Â  Â  Â  Â  Â  Â  // Draw Arm 2
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.moveTo(joint1X, joint1Y);
Â  Â  Â  Â  Â  Â  ctx.lineTo(endEffectorX, endEffectorY);
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = color;
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 8;
Â  Â  Â  Â  Â  Â  ctx.lineCap = 'round';
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw Joints
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  _B_
Â  Â  Â  Â  Â  ctx.arc(0, 0, 10, 0, 2 * Math.PI); // Base joint
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#4b5563'; // gray-600
Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.arc(joint1X, joint1Y, 8, 0, 2 * Math.PI); // Elbow joint
Â  Â  Â  Â  Â  Â  ctx.fillStyle = color;
Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw Target Point
s
Â  Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  Â  ctx.arc(endEffectorX, endEffectorY, 10, 0, 2 * Math.PI);
Â  Â  Â  Â  Â  Â  ctx.fillStyle = color;
Â  Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  Â  Â  ctx.strokeStyle = '#ffffff';
Â  Â  Â  Â  Â  Â  ctx.lineWidth = 3;
Â  Â  Â  Â  Â  Â  ctx.stroke();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }

Â  Â  Â  Â  // Main drawing function: draws grid, path, and arm
Â  Â  Â  Â  function drawToStep(stepIndex) {
Â  Â  Â  Â  Â  Â  const { canvas, initialXInput, initialYInput } = getCalculatorElements();
Â  Â  Â  Â  Â  Â  if (!canvas || !initialXInput || !initialYInput) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  stepIndex = parseInt(stepIndex, 10);
Â  Â  Â  Â  Â  Â  drawGrid();

Â  Â  Â  Â  Â  Â  // Get segments to draw (up to the current step)
Â  Â  Â  Â  Â  Â  const segmentsToDraw = globalPathSegments.slice(0, stepIndex);
Â  Â  Â  Â  Â  Â  drawPathSegments(segmentsToDraw);

Â  Â  Â  Â  Â  Â  // Find the position to draw the arm
Â  Â  Â  Â  Â  Â  let finalX, finalY;
Â  Â  Â  Â  Â  Â  if (stepIndex === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // === VALUE CHANGED ===
s
Â  Â  Â  Â  Â  Â  Â  Â  // Use the new default values
Â  Â  Â  Â  Â  Â  Â  Â  finalX = parseFloat(initialXInput.value || "203.6");
Â  Â  Â  Â  Â  Â  Â  Â  finalY = parseFloat(initialYInput.value || "0");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const lastSegment = segmentsToDraw[stepIndex - 1];
Â  Â  Â  Â  Â  Â  Â  Â  finalX = lastSegment.endX;
Â  Â  Â  Â  Â  Â  Â  Â  finalY = lastSegment.endY;
s
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Draw the arm in its final position for this step
Â  Â  Â  Â  Â  Â  drawArmAtPosition(finalX, finalY, '#2563eb'); // blue-600
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Main Conversion Logic ---
Â  Â  Â  Â  function handleConversion() {
Â  Â  Â  Â  Â  Â  const els = getCalculatorElements();
Â  Â  Â  Â  Â  Â  // Check if all elements exist before running
Â  Â  Â  Â  Â  Â  if (!els.inputGcodeEl || !els.initialXInput || !els.initialYInput || !els.warningIndicator || !els.warningMessages || !els.outputGcodeEl || !els.stepSlider) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const inputGcode = els.inputGcodeEl.value;
Â  Â  Â  Â  Â  Â  const lines = inputGcode.split('\n');
Â  Â  Â  Â  Â  Â  const preferredSolution = document.querySelector('input[name="solution"]:checked').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // === VALUE CHANGED ===
Â  Â  Â  Â  Â  Â  // Use new defaults if boxes are empty
Â  Â  Â  Â  Â  Â  let currentX = parseFloat(els.initialXInput.value || "203.6");
s
Â  Â  Â  Â  Â  Â  let currentY = parseFloat(els.initialYInput.value || "0");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- Reset state ---
Â  Â  Â  Â  Â  Â  els.warningIndicator.classList.add('hidden');
Â  Â  Â  Â  Â  Â  els.warningMessages.classList.add('hidden');
Â  Â  Â  Â  Â  Â  els.warningMessages.querySelector('ul').innerHTML = '';
Â  Â  Â  Â  Â  Â  globalPathSegments = []; // Clear previous path

Â  Â  Â  Â  Â  Â  if (isNaN(currentX) || isNaN(currentY)) {
Â  Â  Â  Â  Â  Â  Â  Â  els.warningMessages.querySelector('ul').innerHTML = '<li>Invalid Initial Start Position.</li>';
Â  Â  Â  Â  Â  Â  Â  Â  els.warningMessages.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  els.warningIndicator.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  els.outputGcodeEl.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  // Reset slider
Â  Â  Â  Â  Â  Â  Â  Â  els.stepSlider.max = 0;
Â  Â  Â  Â  Â  Â  Â  Â  els.stepSlider.value = 0;
Â  Â  Â  Â  Â  Â  Â  Â  els.stepLabel.textContent = '0 / 0';
Â  Â  Â  Â  Â  Â  Â  Â  drawToStep(0); // Draw starting arm
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let outputGcode = [];
Â  Â  Â  Â  Â  Â  let warnings = []; // Store warnings here
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for (const [index, line] of lines.entries()) {
Â  Â  Â  Â  Â  Â  Â  Â  const trimmedLine = line.trim();

Â  Â  Â  Â  Â  Â  Â  Â  // ONLY look for G1 commands
Â  Â  Â  Â  Â  Â  Â  Â  const g1Match = trimmedLine.toUpperCase().match(/^G1\s+/);
Â  Â  Â  Â  Â  Â  Â  Â  if (g1Match) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const xMatch = trimmedLine.match(/X\s*(-?[\d\.]+)/i);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const yMatch = trimmedLine.match(/Y\s*(-?[\d\.]+)/i);
s

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Skip if G1 has no X or Y
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!xMatch && !yMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetX = xMatch ? parseFloat(xMatch[1]) : currentX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const targetY = yMatch ? parseFloat(yMatch[1]) : currentY;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Run IK for Start and End ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startResult = calculateIK(L1_LENGTH, L2_LENGTH, currentX, currentY);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endResult = calculateIK(L1_LENGTH, L2_LENGTH, targetX, targetY);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (startResult.error || endResult.error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = startResult.error || endResult.error;
s
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  warnings.push(`Line ${index + 1} ('${trimmedLine}'): Calculation failed. ${errorMsg}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue; // Skip this line
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add warning if clamping occurred
isClamped
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (endResult.isClamped) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  warnings.push(`Line ${index + 1} ('${trimmedLine}'): Target unreachable, clamped to (${endResult.clampedX.toFixed(2)}, ${endResult.clampedY.toFixed(2)}).`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Get Deltas ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const startAngles = (preferredSolution === 'down') ? startResult.solution1 : startResult.solution2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const endAngles = (preferredSolution === 'down') ? endResult.solution1 : endResult.solution2;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delta_q1_deg = toDegrees(endAngles.q1 - startAngles.q1);
A
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delta_q2_deg = toDegrees(endAngles.q2 - startAngles.q2);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- [START] MODIFIED COUPLING LOGIC ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Convert arm deltas (in degrees) to theoretical "decoupled" steps
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // These are the "pure" steps for each arm if they weren't coupled
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const q1_steps = delta_q1_deg * DEG_TO_STEPS;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const q2_steps = delta_q2_deg * DEG_TO_STEPS;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Apply the new gear ratio coupling logic as requested
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // M1 (motor1) is assumed to still control q1 directly
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motor1_steps_float = q1_steps;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // M2 (motor2) uses the new formula: (0.125 * q1_steps) + q2_steps
Boolean
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motor2_steps_float = (0.125 * q1_steps) + q2_steps;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 3. Round to nearest integer for the G-code command
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motor1_steps = Math.round(motor1_steps_float);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const motor2_steps = Math.round(motor2_steps_float);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- [END] MODIFIED COUPLING LOGIC ---

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Format and Add G-Code ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Note: The G-code format is G1 [Motor 2 Steps] [Motor 1 Steps] [Feedrate]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newGcodeLine = `G1 ${motor2_steps} ${motor1_steps} 1000`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  outputGcode.push(newGcodeLine);

Â  Â  Â  Â  Â  Â  nbsp;
Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Store for drawing ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  globalPathSegments.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startX: currentX,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startY: currentY,
Â  Â  Â  Â  Â  Â  a
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endX: endResult.clampedX,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endY: endResult.clampedY,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isClamped: endResult.isClamped
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Update current position for next loop ---
Read
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentX = endResult.clampedX;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentY = endResult.clampedY;

Â  Â  Â  Â  Â  Â  Â  Â  } // else: ignore comments, blanks, and other G-codes
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- Finalize ---
Read
Â  Â  Â  Â  Â  Â  els.outputGcodeEl.value = outputGcode.join('\n');

Â  Â  Â  Â  Â  Â  // --- Update Slider ---
Â  Â  Â  Â  Â  Â  const totalSteps = globalPathSegments.length;
Â  Â  Â  Â  Â  Â  els.stepSlider.max = totalSteps;
Â  Â  Â  Â  Â  Â  els.stepSlider.value = totalSteps;
Read
Read
Â  Â  Â  Â  Â  Â  els.stepLabel.textContent = `${totalSteps} / ${totalSteps}`;

Â  Â  Â  Â  Â  Â  // --- Draw final path ---
Â  Â  Â  Â  Â  Â  drawToStep(totalSteps);

Â  Â  Â  Â  Â  Â  // --- Show Warnings if any ---
s
Â  Â  Â  Â  Â  Â  if (warnings.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  els.warningIndicator.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  els.warningMessages.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  els.warningMessages.querySelector('ul').innerHTML = warnings.map(w => `<li>${w}</li>`).join('');
s
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Slider Event ---
Â  Â  Â  Â  function handleSliderChange(event) {
Â  Â  Â  Â  Â  Â  const { stepLabel, stepSlider } = getCalculatorElements();
Read
Â  Â  Â  Â  Â  Â  if (!stepLabel || !stepSlider) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const step = event.target.value;
Â  Â  Â  Â  Â  Â  stepLabel.textContent = `${step} / ${stepSlider.max}`;
Â  Â  Â  Â  Â  Â  drawToStep(step);
Â  Â  Â  Â  }

Â  Â  nbsp;
Â  Â  // --- Copy Button Logic ---
Â  Â  Â  Â  function setupCopyButton() {
Â  Â  Â  Â  Â  Â  const { copyButton, outputGcodeEl, copySuccess } = getCalculatorElements();
s
Â  Â  Â  Â  Â  Â  if (!copyButton || !outputGcodeEl || !copySuccess) return;

Â  Â  Â  Â  Â  Â  copyButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const textToCopy = outputGcodeEl.value;
Â  Â  Â  Â  Â  Â  Â  Â  const textArea = document.createElement('textarea');
Â  Â  Â  Â  Â  Â  Â  Â  textArea.value = textToCopy;
Â  Â  Â  Â  Â  Â  Â  Â  textArea.style.position = 'fixed';
Read
Â  Â  Â  Â  Â  Â  Â  Â  textArea.style.top = '0';
Â  Â  Â  Â  Â  Â  Â  Â  textArea.style.left = '0';
Â  Â  Â  Â  Â  Â  Â  Â  textArea.style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(textArea);
Â  Â  Â  Â  Â  Â  Â  Â  textArea.focus();
Read
Â  Â  Â  Â  Â  Â  Â  Â  textArea.select();
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copySuccess.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyButton.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Read
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copySuccess.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  copyButton.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  _B_
Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Read
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Fallback: Oops, unable to copy', err);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(textArea);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initial Setup ---
Â  Â  Â  Â  // We need to wait for the DOM to be loaded, AND we need to
Read
Â  Â  Â  Â  // make sure we are on the /script page.
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  // The calculator script will only run if it finds the 'convertButton'
Â  Â  Â  Â  Â  Â  const { convertButton, stepSlider } = getCalculatorElements();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (convertButton) {
Read
Â  Â  Â  Â  Â  Â  Â  Â  convertButton.addEventListener('click', handleConversion);
Â  Â  Â  Â  Â  Â  Â  Â  stepSlider.addEventListener('input', handleSliderChange);
Â  Â  Â  Â  Â  Â  Â  Â  window.addEventListener('resize', resizeCanvas);
Â  Â  Â  Â  Â  Â  Â  Â  setupCopyButton();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // === CANVAS FIX ===
Read
open
Â  Â  Â  Â  Â  Â  Â  Â  // Wait a tiny moment for the CSS to paint the layout,
Â  Â  Â  Â  Â  Â  Â  Â  // then get the canvas size and do the first render.
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resizeCanvas();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleConversion(); // Run once on load
s
Â  Â  Â  Â  Â  Â  Â  Â  }, 100); // 100ms delay
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
