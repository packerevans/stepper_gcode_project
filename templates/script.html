This is an excellent idea, and I understand exactly what you want. You want to keep your "sand table" theme (with the sidebar, dark mode, and terminal) on the script.html page, but replace the simple text box with your new, powerful IK calculator.
The best way to do this is to load your new calculator inside the script.html page using an <iframe>. This keeps the two projects separate but lets them work together.
Here is a complete, step-by-step plan to make this work.
Step 1: Create calculator.html
Take the entire HTML file you just gave me (the one with Tailwind CSS and all the IK logic) and save it in your templates/ folder.
 * File Name: calculator.html
 * Location: templates/calculator.html
(You don't need to change anything in this file. It's perfect as-is.)
Step 2: Update app.py
We need to tell Flask about this new calculator.html page so the <iframe> can load it.
Add the new @app.route("/calculator") function to your APP ROUTES block. The final block should look like this:
# ---------------- APP ROUTES ----------------
@app.route("/")
def index():
    if not arduino_connected:
        return render_template("connect.html")
    # This is the main page for "Manual Command"
    return render_template("index.html") 

@app.route("/script")
def script():
    if not arduino_connected:
        return render_template("connect.html")
    # This is the page for "Bulk Commands"
    return render_template("script.html")

# --- NEW ROUTE FOR THE CALCULATOR ---
@app.route("/calculator")
def calculator():
    # This page will be loaded *inside* the script.html iframe
    return render_template("calculator.html")
# --- END OF NEW ROUTE ---

@app.route("/terminal")
def terminal():
    if not arduino_connected:
        return render_template("connect.html")
    return render_template("terminal.html")

@app.route("/led_controls")
def led_controls():
    return render_template("led_controls.html")

# --- NEW G-CODE BLOCK FUNCTIONALITY ---
# (Your process_and_send_gcode and send_gcode_block_route functions go here...)
# (No changes are needed for these functions. They will work perfectly.)

Save app.py and restart your server (press Ctrl+C and run python3 app.py) for this change to take effect.
Step 3: Replace script.html
This is the final step. We will replace your entire script.html file with the code below.
This new file does two things:
 * It removes the old <textarea> and replaces it with an <iframe> that loads your calculator.html.
 * It replaces the old sendGcode() JavaScript function with a new sendGcodeFromIframe() function that "reaches into" the iframe, grabs the G-code from the outputGcode box, and sends it to your (already existing) /send_gcode_block route.
Complete script.html (Copy/Paste this)
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packers Sand Table Control</title>
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="apple-touch-icon" sizes="512x512" href="{{ url_for('static', filename='icons/icon-512.png') }}">
    
  <style>
    /* --- Root Variables (Light Mode) --- */
    :root {
        --color-primary: #d2b48c; /* Khaki/Tan (Button/Sidebar Background) */
        --color-secondary: #b08d5c; /* Darker Tan (Button Hover/Accent) */
        --color-background: #f0f0f0; /* Light Gray Background */
        --color-surface: #ffffff; /* White Card/Container Background */
        --color-text: #333333;
        --color-shadow: rgba(0, 0, 0, 0.08);
        --color-icon: #000000;
        
        /* Terminal Colors (Light) */
        --color-terminal-bg: #e9e9e9;
        --color-terminal-text: #333333;
        --color-terminal-prompt: #008080; /* Teal/Cyan */
        
        --border-radius: 12px;
    }

    /* --- Dark Mode Variables --- */
    body[data-theme='dark'] {
        --color-background: #1e1e1e;
        --color-surface: #2c2c2c;
        --color-text: #e0e0e0;
        --color-shadow: rgba(255, 255, 255, 0.08);
        --color-icon: #ffffff;
        
        /* Terminal Colors (Dark) */
        --color-terminal-bg: #1a1a1a;
        --color-terminal-text: #cccccc;
        --color-terminal-prompt: #98fb98; /* Pale Green */
    }
    
    /* --- Base Styles --- */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--color-background);
        color: var(--color-text);
        padding: 0;
        margin: 0;
        transition: background 0.3s, color 0.3s;
    }

    /* --- Sidebar & Header --- */
    .sidebar {
        height: 100%; width: 0; position: fixed; top: 0; left: 0;
        background-color: var(--color-primary); overflow-x: hidden;
        transition: 0.3s; padding-top: 60px; z-index: 1000;
        box-shadow: 2px 0 5px var(--color-shadow);
    }

    .sidebar a {
        padding: 15px 24px; text-decoration: none; font-size: 18px;
        color: var(--color-text); display: block; transition: 0.2s;
        font-weight: 500;
    }

    .sidebar a:hover {
        background-color: var(--color-secondary);
        color: var(--color-surface);
    }

    .openbtn {
        font-size: 26px; cursor: pointer; background-color: var(--color-primary);
        color: var(--color-text); padding: 10px 20px; border: none;
        border-radius: 0 0 var(--border-radius) 0; position: fixed;
        top: 0; left: 0; z-index: 1100; box-shadow: 0 2px 5px var(--color-shadow);
    }
    
    /* --- Theme Toggle Button --- */
    #themeToggle {
        position: fixed; top: 15px; right: 15px; background: var(--color-surface);
        color: var(--color-icon); border: 1px solid var(--color-icon);
        padding: 8px 15px; border-radius: 20px; z-index: 1200;
        transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    
    .main-content {
        margin-left: 0; transition: margin-left 0.3s; padding: 20px;
        max-width: 800px; margin: 0 auto;
        /* --- CHANGED: Allow main content to be wider for the calculator --- */
        max-width: 1200px;
    }

    h1 {
        text-align: center; margin-top: 20px; margin-bottom: 30px;
        font-weight: 300; color: var(--color-secondary);
    }
    
    h2 {
        font-weight: 400;
        margin-top: 30px;
        border-bottom: 1px solid var(--color-shadow);
        padding-bottom: 10px;
    }

    .header-image {
        width: 100%; max-height: 250px; object-fit: cover;
        border-radius: var(--border-radius); margin-bottom: 30px;
        box-shadow: 0 4px 15px var(--color-shadow);
    }
    
    /* --- Main Control Container --- */
    .control-panel {
        background-color: var(--color-surface); padding: 30px;
        border-radius: var(--border-radius); box-shadow: 0 4px 10px var(--color-shadow);
        margin-bottom: 30px;
    }

    /* --- Buttons --- */
    button {
        background-color: var(--color-primary); 
        color: var(--color-text);
        border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px;
        cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
        font-weight: 600;
    }

    button:hover {
        background-color: var(--color-secondary); box-shadow: 0 2px 8px var(--color-shadow);
    }
    
    button:disabled {
        background-color: #ccc;
        color: #777;
        cursor: not-allowed;
    }

    /* --- NEW G-code Entry Section --- */
    .gcode-entry-section h2 {
        margin-top: 0;
        padding-bottom: 15px;
        font-weight: 400;
        border-bottom: none;
    }
    
    /* --- NEW IFRAME STYLES --- */
    #calculator-iframe {
        width: 100%;
        /* The calculator is complex, so we give it a lot of space */
        height: 800px; 
        border: 1px solid var(--color-shadow);
        border-radius: 8px;
    }

    /* --- Terminal --- */
    .terminal {
        background: var(--color-terminal-bg); color: var(--color-terminal-text);
        font-family: 'Consolas', 'Courier New', monospace; padding: 15px;
        border-radius: 8px; width: 100%; height: 200px; overflow-y: auto;
        font-size: 14px; border: 1px solid var(--color-shadow);
        white-space: pre-wrap; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        transition: background 0.3s, color 0.3s;
        box-sizing: border-box;
    }
    
    .terminal .prompt { color: var(--color-terminal-prompt); font-weight: bold; }
    .terminal .response { color: var(--color-terminal-text); }


    /* --- MOBILE RESPONSIVENESS --- */
    @media (max-width: 600px) {
        .main-content {
            padding: 10px;
        }
        .header-image {
            max-height: 120px;
            margin-bottom: 15px;
        }
        h1, h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
        }
        
        .control-panel {
            padding: 20px;
        }
        
        #calculator-iframe {
            height: 600px; /* Still needs a lot of space */
        }

        .terminal {
            height: 150px;
            font-size: 12px;
        }
    }
</style>
    
</head>
<body data-theme="light">
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" onclick="closeNav()">‚úñ Close</a>
        <a href="{{ url_for('index') }}">Manual Command</a>
        <a href="{{ url_for('led_controls') }}">LED Controls</a>
        <a href="{{ url_for('script') }}">Bulk Commands</a>
        <a href="{{ url_for('terminal') }}">Terminal</a>
    </div>

    <button class="openbtn" onclick="openNav()">‚ò∞</button>
    <button id="themeToggle" onclick="toggleDarkMode()">
        <span id="themeIcon">‚òÄÔ∏è</span>
    </button>

    <div class="main-content">
        <img src="{{ url_for('static', filename='sand.png') }}" alt="Sand Table Header" class="header-image">
        <h1>Sand Table Controls</h1>
        
        <div class="control-panel">
            
            <div class="gcode-entry-section">
                <h2>Bulk G-Code (from IK Calculator)</h2>
                
                <iframe id="calculator-iframe" src="{{ url_for('calculator') }}"></iframe>
                
                <button id="send-gcode-btn" onclick="sendGcodeFromIframe()" style="margin-top: 15px; width: 100%;">
                    Send G-Code from Calculator to Table
                </button>
            </div>
            
        </div>
        
        <h2>Live Terminal Log</h2>
        <div id="terminal" class="terminal"></div>
    </div>

    <script>
        // --- Sidebar Functions ---
        function openNav() {
            document.getElementById("mySidebar").style.width = "200px";
            // Adjust margin for wider content
            const main = document.querySelector(".main-content");
            if (main) main.style.marginLeft = "200px";
        }

        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            const main = document.querySelector(".main-content");
            if (main) main.style.marginLeft = "auto"; // Center again
        }

        // --- Dark Mode Toggle ---
        function updateThemeIcon(theme) {
            document.getElementById('themeIcon').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        function toggleDarkMode() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        
        // --- Terminal Logger ---
        function appendToTerminal(text, isCommand = false) {
            const term = document.getElementById("terminal");
            if (!term) return; 
            
            const line = document.createElement("div");
            
            if (isCommand) {
                line.innerHTML = `<span class="prompt">[${new Date().toLocaleTimeString()}] > </span><span class="response">${text}</span>`;
            } else {
                line.innerHTML = `<span class="response">[${new Date().toLocaleTimeString()}] ${text}</span>`;
            }
            
            term.appendChild(line);
            term.scrollTop = term.scrollHeight; 
        }

        // --- NEW: Function to send the G-code block from the IFRAME ---
        function sendGcodeFromIframe() {
            const sendButton = document.getElementById('send-gcode-btn');
            const iframe = document.getElementById('calculator-iframe');
            let gcodeText = "";

            try {
                // Access the iframe's contentWindow
                const iframeWindow = iframe.contentWindow;
                if (!iframeWindow) {
                    throw new Error("Could not access iframe window.");
                }
                
                // Access the document inside the iframe
                const iframeDoc = iframeWindow.document;
                if (!iframeDoc) {
                    throw new Error("Could not access iframe document.");
                }

                // Get the text from the calculator's output box
                const outputBox = iframeDoc.getElementById('outputGcode');
                if (!outputBox) {
                    throw new Error("Could not find 'outputGcode' element in calculator.");
                }
                
                gcodeText = outputBox.value;
            } catch (e) {
                appendToTerminal(`Error reading from calculator: ${e.message}`, false);
                appendToTerminal("Make sure the calculator is fully loaded.", false);
                return;
            }

            if (!gcodeText.trim()) {
                appendToTerminal("Calculator output text box is empty.", false);
                return;
            }

            // Disable button to prevent double-sending
            sendButton.disabled = true;
            sendButton.textContent = "Sending...";
            
            appendToTerminal("Sending G-code block to server...", true);

            fetch("/send_gcode_block", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ gcode: gcodeText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // This message comes from app.py immediately
                    appendToTerminal(`Server response: ${data.message}`, false);
                } else {
                    appendToTerminal(`Error: ${data.error || 'Unknown Error'}`, false);
                }
            })
            .catch(error => {
                appendToTerminal(`Network Error: ${error.message}`, false);
            })
            .finally(() => {
                // Re-enable the button after the server responds
                sendButton.disabled = false;
                sendButton.textContent = "Send G-Code from Calculator to Table";
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Load theme from local storage
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            
            appendToTerminal("System ready. Bulk command page initialized.", false);
        });
    </script>
</body>
</html>

