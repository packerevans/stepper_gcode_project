<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sand Controller Pro</title>
    <style>
        :root {
            --primary: #d2b48c; 
            --secondary: #b08d5c; 
            --bg: #f4f4f4; 
            --panel: #ffffff; 
            --text: #333;
            --accent: #2ecc71;
            --danger: #e74c3c;
            --btn-text: #fff;
        }
        body[data-theme='dark'] {
            --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --btn-text: #000;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: var(--bg); color: var(--text);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        .nav-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: var(--panel);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100;
        }
        .sidebar {
            height: 100%; width: 0; position: fixed; top: 0; left: 0;
            background-color: var(--primary); overflow-x: hidden;
            transition: 0.3s; padding-top: 60px; z-index: 2000;
            box-shadow: 4px 0 10px rgba(0,0,0,0.3);
        }
        .sidebar a {
            padding: 15px 24px; text-decoration: none; font-size: 18px;
            color: #fff; display: block; font-weight: 500;
        }

        .app-container {
            display: flex; flex-direction: column; height: 100%; width: 100%;
            padding: 10px; box-sizing: border-box; gap: 10px; overflow-y: auto;
        }
        @media (min-width: 768px) {
            .app-container { flex-direction: row; overflow: hidden; }
            .drawing-panel { flex: 2; border-radius: 16px; background: var(--panel); position: relative; display: flex; align-items: center; justify-content: center; }
            .controls-panel { flex: 1; max-width: 400px; border-radius: 16px; background: var(--panel); padding: 20px; overflow-y: auto; }
        }
        @media (max-width: 767px) {
            .drawing-panel { width: 100%; aspect-ratio: 1/1; border-radius: 16px; background: var(--panel); flex-shrink: 0; position: relative;}
            .controls-panel { flex: 1; border-radius: 16px; background: var(--panel); padding: 15px; }
        }

        .canvas-wrapper {
            position: relative;
            width: 95vmin;
            height: 95vmin;
            max-width: 95%;
            max-height: 95%;
            aspect-ratio: 1 / 1;
            margin: auto;
            border-radius: 50%;
            border: 4px solid var(--primary); 
            background: #fff;
            touch-action: none; cursor: crosshair; overflow: hidden;
        }
        body[data-theme='dark'] .canvas-wrapper { background: #222; border-color: var(--secondary); }
        canvas { display: block; width: 100%; height: 100%; border-radius: 50%; }

        h2 { margin: 0 0 15px 0; font-size: 1.2rem; color: var(--secondary); text-align: center; }
        .btn-group { display: flex; gap: 8px; margin-bottom: 12px; }
        button {
            background: var(--primary); color: var(--btn-text); border: none;
            padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer;
            flex: 1; transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button.secondary { background: transparent; border: 1px solid var(--text); color: var(--text); }
        button.active { background: var(--secondary); border: 2px solid var(--text); }
        button.action { background: var(--accent); color: #000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .slider-row { margin-bottom: 15px; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; font-weight: bold; }
        input[type="range"] { width: 100%; accent-color: var(--secondary); }
        
        #progressSlider {
            -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #d3d3d3; outline: none;
        }
        #progressSlider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--secondary); cursor: pointer;
        }

        details { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; margin-top: 10px; }
        summary { cursor: pointer; font-weight: bold; font-size: 13px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        input[type="number"], input[type="text"], select { width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }

        #status-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 13px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 3000;
        }
        .success { background: var(--accent) !important; color: #000 !important; }
        .error { background: var(--danger) !important; color: #fff !important; }

        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-tog { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider-tog:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-tog { background-color: var(--secondary); }
        input:checked + .slider-tog:before { transform: translateX(18px); }

        #toolSettingsArea {
            background: rgba(0,0,0,0.03);
            border: 1px dashed var(--secondary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
            display: none;
        }
        .tool-setting-group { display: none; }
        .tool-setting-group.active { display: block; }
        .tool-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--secondary); margin-bottom: 5px; display:block;}
        .full-width { width: 100%; }

    </style>
</head>
<body data-theme="light">

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" onclick="closeNav()">‚úñ Close</a>
        <a href="/">Designs</a> 
        <a href="/ai_builder">AI Builder</a>
        <a href="/led_controls">LED Controls</a>
        <a href="/terminal">Terminal</a>
    </div>

    <div class="nav-bar">
        <button style="flex:0; background:none; font-size:24px; color:var(--text); padding:0;" onclick="openNav()">‚ò∞</button>
        <h1 style="margin:0; font-size:1.2rem;">Sand Controller Pro</h1>
        <button style="flex:0; background:none; font-size:20px;" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>

    <div class="app-container">
        <div class="drawing-panel">
            <div class="canvas-wrapper" id="canvasContainer">
                <canvas id="drawCanvas"></canvas>
            </div>
            <div id="coordDisplay" style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:4px 8px; border-radius:4px; font-size:11px; pointer-events:none;">X:0 Y:0</div>
        </div>

        <div class="controls-panel">
            <div id="designPhaseControls">
                <h2>Tools</h2>
                
                <div id="toolSettingsArea">
                    <div id="set-pen" class="tool-setting-group">
                        <div class="toggle-row" style="margin:0;">
                            <span style="font-size:13px;">üîó Shape Connector</span>
                            <label class="switch">
                                <input type="checkbox" id="shapeConnectMode" checked>
                                <span class="slider-tog"></span>
                            </label>
                        </div>
                    </div>

                    <div id="set-erase" class="tool-setting-group">
                        <span class="tool-label">Eraser Size: <span id="eraseSizeVal">10px</span></span>
                        <input type="range" min="2" max="50" value="10" oninput="updateToolSettings()" id="eraserSizeSlider">
                    </div>

                    <div id="set-text" class="tool-setting-group">
                        <span class="tool-label" style="color:var(--accent); font-weight:bold;">Sand Text Tool</span>
                        <input type="text" id="textInput" placeholder="Type text..." value="SAND" class="full-width" style="margin-bottom:8px;" oninput="generateTextPath()">
                        <div class="settings-grid" style="grid-template-columns: 2fr 1fr; margin-bottom: 8px;">
                            <select id="textFont" onchange="generateTextPath()">
                                <option value="Arial">Arial</option>
                                <option value="serif">Serif</option>
                                <option value="Courier New">Monospace</option>
                                <option value="Georgia">Georgia</option>
                            </select>
                            <input type="number" id="textSize" value="150" oninput="generateTextPath()">
                        </div>
                        <button class="action" onclick="generateTextPath()">Apply Text</button>
                    </div>

                    <div id="set-select" class="tool-setting-group">
                        <span class="tool-label">Transform Selection</span>
                        <span class="tool-label">Rotate Live</span>
                        <input type="range" min="-180" max="180" value="0" step="1" id="liveRotSlider" oninput="liveRotate(this.value)" onchange="endLiveTransform(this)">
                        <span class="tool-label" style="margin-top:10px;">Resize Live</span>
                        <input type="range" min="10" max="200" value="100" step="1" id="liveScaleSlider" oninput="liveScale(this.value)" onchange="endLiveTransform(this)">
                    </div>

                    <div id="set-sandify" class="tool-setting-group">
                        <span class="tool-label" style="color:var(--accent); font-weight:bold;">Vortex Generator</span>
                        <label class="tool-label">Shape Source</label>
                        <select id="vortexShape" class="full-width" onchange="updateVortexParams()">
                            <option value="custom">Current Drawing</option>
                            <option value="triangle">Triangle</option>
                            <option value="square">Square</option>
                            <option value="pentagon">Pentagon</option>
                            <option value="hexagon">Hexagon</option>
                            <option value="star">Star</option>
                        </select>
                        <span class="tool-label" style="margin-top:10px;">Loop Count: <span id="val-swirl">20</span></span>
                        <input type="range" id="vortexSwirl" min="5" max="50" step="1" value="20" oninput="updateVortexParams()">
                    </div>
                    
                    <div id="set-trace" class="tool-setting-group">
                         <span class="tool-label" style="color:var(--accent); font-weight:bold;">Ball-Aware Trace</span>
                         <span class="tool-label">Contrast Threshold: <span id="traceThreshVal">150</span></span>
                         <input type="range" min="10" max="240" value="150" id="traceThreshInput" oninput="runHighPrecisionTrace()">
                         <button class="secondary" style="margin-top:10px;" onclick="document.getElementById('imgUpload').click()">üìÇ Change Image</button>
                    </div>
                </div>

                <div class="btn-group">
                    <button id="btnDraw" onclick="setTool('draw')" class="active">‚úèÔ∏è Draw</button>
                    <button id="btnErase" onclick="setTool('erase')" class="secondary">üßº Erase</button>
                </div>

                <div class="btn-group">
                    <button id="btnSelect" onclick="setTool('select')" class="secondary">‚úã Move</button>
                    <button id="btnSandify" onclick="setTool('sandify')" class="secondary">üåÄ Vortex</button>
                </div>

                <div class="btn-group">
                    <button id="btnText" onclick="setTool('text')" class="secondary">üî§ Text</button>
                    <input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
                    <button id="btnTrace" class="secondary" onclick="document.getElementById('imgUpload').click()">‚ú® Trace</button>
                </div>

                <div class="btn-group">
                    <button onclick="undo()" class="secondary">‚Ü∂ Undo</button>
                    <button onclick="clearCanvas()" class="secondary" style="color:var(--danger); border-color:var(--danger);">‚úñ Clear</button>
                </div>

                <hr style="border:0; border-top:1px solid #ddd; margin: 15px 0;">
                
                <div class="slider-row">
                    <div class="slider-header"><span>SYMMETRY</span> <span id="symVal">1x</span></div>
                    <input type="range" id="symSlider" min="1" max="12" value="1" step="1" oninput="updateUI()">
                </div>

                <button class="action" onclick="prepareGCode()" style="margin-bottom:15px; font-size:1.1em;">‚öôÔ∏è Prepare Path</button>
            </div>
            
            <div id="productionPhaseControls" style="display:none; margin-bottom:15px;">
                <button class="secondary" onclick="returnToEditing()" style="width:100%; border:2px dashed #999;">‚úèÔ∏è Back to Edit</button>
            </div>

            <div class="slider-row">
                <div class="slider-header"><span>SIMULATION</span> <span id="progVal">100%</span></div>
                <input type="range" id="progressSlider" min="0" max="100" value="100" oninput="render()">
            </div>

            <div class="btn-group">
                <button onclick="sendToTable()" class="active">üöÄ Run</button>
                <button onclick="saveToServer()" class="secondary">üíæ Save to Pi</button>
            </div>

            <details>
                <summary>‚öôÔ∏è Machine Settings</summary>
                <div class="settings-grid">
                    <div><label>Radius</label><input type="number" id="cfgRadius" value="202.6" onchange="resizeCanvas()"></div>
                    <div><label>Ball Size (mm)</label><input type="number" id="cfgBallSize" value="13" onchange="resetStatus()"></div>
                    <div><label>Center Speed</label><input type="number" id="cfgCenterDelay" value="500"></div>
                    <div><label>Rim Speed</label><input type="number" id="cfgPerimDelay" value="3000"></div>
                    <div><label>Steps/Deg</label><input type="number" id="cfgStepsPerDeg" value="8.888888"></div>
                    <div><label>Arm 1</label><input type="number" id="cfgL1" value="101.3"></div>
                    <div><label>Arm 2</label><input type="number" id="cfgL2" value="101.3"></div>
                </div>
                <button class="secondary" onclick="copyGCode()" style="margin-top:10px; width:100%;">üìã Copy GCode</button>
            </details>
        </div>
    </div>

    <div id="status-toast"></div>
    <canvas id="hiddenTraceBuffer" width="800" height="800" style="display:none;"></canvas>
    <canvas id="vortexScanCanvas" width="600" height="600" style="display:none;"></canvas>

    <script>
        // --- GLOBAL STATE ---
        let rawPoints = []; 
        let processedPoints = []; 
        let historyStack = [];
        let isDrawing = false;
        let currentTool = 'draw';
        let origin = {x:0, y:0};
        let scale = 1;
        let generatedGCode = null;
        let eraserRadius = 10;

        // Trace & Text State
        let traceImgData = null;
        let traceState = { active: false, img: null, x: 0, y: 0, scale: 1.0, baseScale: 1.0, rotation: 0 }; 

        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const BASE_URL = window.location.origin;

        // --- CORE LOGIC ---
        function init() {
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            canvas.addEventListener('pointerdown', startDraw);
            canvas.addEventListener('pointermove', moveDraw);
            canvas.addEventListener('pointerup', endDraw);
            updateToolSettings();
        }

        function startDraw(e) {
            if(generatedGCode) return;
            saveState();
            isDrawing = true;
            canvas.setPointerCapture(e.pointerId);
            processPointer(e);
        }

        function moveDraw(e) {
            const pos = getPos(e);
            document.getElementById('coordDisplay').textContent = `X:${pos.x.toFixed(0)} Y:${pos.y.toFixed(0)}`;
            if(!isDrawing) { render(); drawCursor(pos); return; }
            processPointer(e);
        }

        function endDraw(e) {
            isDrawing = false;
            canvas.releasePointerCapture(e.pointerId);
            if(currentTool === 'draw') rawPoints.push({type:'break'});
            render();
        }

        function getPos(e) { return { x: (e.offsetX - origin.x) / scale, y: -(e.offsetY - origin.y) / scale }; }

        function processPointer(e) {
            const p = getPos(e);
            if(currentTool === 'draw') rawPoints.push({x: p.x, y: p.y, type: 'point'}); 
            else if (currentTool === 'erase') {
                rawPoints = rawPoints.filter(pt => pt.type === 'break' || Math.hypot(pt.x - p.x, pt.y - p.y) > eraserRadius);
            }
            render();
        }

        function setTool(t) {
            currentTool = t;
            ['btnDraw', 'btnErase', 'btnSelect', 'btnSandify', 'btnText', 'btnTrace'].forEach(id => {
                const btn = document.getElementById(id);
                if(btn) btn.className = id === 'btn' + t.charAt(0).toUpperCase() + t.slice(1) ? 'active' : 'secondary';
            });
            updateToolSettings();
        }

        function updateToolSettings() {
            const area = document.getElementById('toolSettingsArea');
            document.querySelectorAll('.tool-setting-group').forEach(g => g.style.display = 'none');
            const active = document.getElementById('set-' + (currentTool === 'text' ? 'text' : currentTool === 'trace_set' ? 'trace' : currentTool === 'draw' ? 'pen' : currentTool));
            if(active) { area.style.display = 'block'; active.style.display = 'block'; }
        }

        // --- NEW TEXT FEATURE ---
        function generateTextPath() {
            const text = document.getElementById('textInput').value;
            const font = document.getElementById('textFont').value;
            const size = document.getElementById('textSize').value;
            const buff = document.getElementById('hiddenTraceBuffer');
            const bCtx = buff.getContext('2d');
            
            bCtx.fillStyle = "white";
            bCtx.fillRect(0, 0, 800, 800);
            bCtx.fillStyle = "black";
            bCtx.font = `bold ${size}px ${font}`;
            bCtx.textAlign = "center";
            bCtx.textBaseline = "middle";
            bCtx.fillText(text, 400, 400);
            
            traceImgData = bCtx.getImageData(0,0,800,800);
            runHighPrecisionTrace();
        }

        // --- BALL-AWARE TRACE ENGINE ---
        function runHighPrecisionTrace() {
            if(!traceImgData) return;
            const ballSizeMm = parseFloat(document.getElementById('cfgBallSize').value);
            const tableRadius = parseFloat(document.getElementById('cfgRadius').value);
            const thresh = parseInt(document.getElementById('traceThreshInput').value);
            
            // Map ball size to pixel grid (800px = 2 * tableRadius)
            const ballSizePx = (ballSizeMm / (tableRadius * 2)) * 800;
            const mergeRadius = Math.max(1, Math.floor(ballSizePx * 0.3)); 

            const SIZE = 800; 
            let pixelGrid = new Uint8Array(SIZE*SIZE);
            for(let i=0; i<SIZE*SIZE; i++) pixelGrid[i] = traceImgData.data[i*4] < thresh ? 1 : 0;

            // Simple Morphological Closing to merge thin lines
            if(mergeRadius > 1) {
                let tempGrid = new Uint8Array(SIZE*SIZE);
                for(let y=mergeRadius; y<SIZE-mergeRadius; y++) {
                    for(let x=mergeRadius; x<SIZE-mergeRadius; x++) {
                        if(pixelGrid[y*SIZE+x]) {
                            for(let dy=-mergeRadius; dy<=mergeRadius; dy++)
                                for(let dx=-mergeRadius; dx<=mergeRadius; dx++)
                                    tempGrid[(y+dy)*SIZE+(x+dx)] = 1;
                        }
                    }
                }
                pixelGrid = tempGrid;
            }

            // Path generation from grid
            let finalPath = [];
            const traced = new Uint8Array(SIZE*SIZE);
            for(let y=2; y<SIZE-2; y+=2) {
                for(let x=2; x<SIZE-2; x+=2) {
                    if(pixelGrid[y*SIZE+x] && !traced[y*SIZE+x]) {
                        // Basic boundary follower
                        let cx = x, cy = y;
                        while(pixelGrid[cy*SIZE+cx] && !traced[cy*SIZE+cx]) {
                            traced[cy*SIZE+cx] = 1;
                            finalPath.push({x: (cx-400)*(tableRadius*2/800), y: (400-cy)*(tableRadius*2/800)});
                            // Look for next neighbor
                            let found = false;
                            for(let ny=cy-1; ny<=cy+1; ny++) {
                                for(let nx=cx-1; nx<=cx+1; nx++) {
                                    if(pixelGrid[ny*SIZE+nx] && !traced[ny*SIZE+nx]) {
                                        cx = nx; cy = ny; found = true; break;
                                    }
                                }
                                if(found) break;
                            }
                            if(!found) break;
                        }
                        finalPath.push({type: 'break'});
                    }
                }
            }

            rawPoints = [];
            finalPath.forEach(p => {
                if(p.type === 'break') rawPoints.push({type:'break'});
                else rawPoints.push({x: p.x, y: p.y, type:'point'});
            });
            render();
        }

        // --- VORTEX & GCODE HELPERS ---
        function updateVortexParams() {
            const ballSize = parseFloat(document.getElementById('cfgBallSize').value);
            const radius = parseFloat(document.getElementById('cfgRadius').value);
            const spacing = ballSize * 1.1; // Ensure 10% safety gap
            const suggestedSwirls = Math.max(5, Math.floor(radius / spacing));
            document.getElementById('vortexSwirl').value = suggestedSwirls;
            document.getElementById('val-swirl').innerText = suggestedSwirls;
        }

        function handleImageUpload(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const bCtx = document.getElementById('hiddenTraceBuffer').getContext('2d');
                    bCtx.fillStyle = "white"; bCtx.fillRect(0,0,800,800);
                    const s = Math.min(800/img.width, 800/img.height);
                    bCtx.drawImage(img, 400-(img.width*s/2), 400-(img.height*s/2), img.width*s, img.height*s);
                    traceImgData = bCtx.getImageData(0,0,800,800);
                    setTool('trace_set');
                    runHighPrecisionTrace();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ... [Include your existing resizeCanvas, render, saveState, prepareGCode, and sendToTable functions here] ...
        // Note: Ensure calculateIK and generateGCodeStringFromProcessed remain intact from your original code.

        function resizeCanvas() {
            const container = document.getElementById('canvasContainer');
            const size = container.getBoundingClientRect().width;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = size * dpr; canvas.height = size * dpr;
            ctx.scale(dpr, dpr);
            origin = { x: size/2, y: size/2 };
            const tableR = parseFloat(document.getElementById('cfgRadius').value);
            scale = (size/2) / (tableR * 1.05);
            render();
        }

        function render() {
            const w = canvas.width / window.devicePixelRatio;
            const h = canvas.height / window.devicePixelRatio;
            ctx.clearRect(0, 0, w, h);
            const tableR = parseFloat(document.getElementById('cfgRadius').value);
            ctx.save();
            ctx.translate(origin.x, origin.y);
            ctx.beginPath(); ctx.arc(0, 0, tableR*scale, 0, Math.PI*2);
            ctx.strokeStyle = '#ddd'; ctx.stroke();
            
            ctx.beginPath();
            ctx.strokeStyle = '#007bff';
            let isMove = true;
            rawPoints.forEach(p => {
                if(p.type === 'break') { isMove = true; }
                else {
                    const px = p.x * scale, py = -p.y * scale;
                    if(isMove) { ctx.moveTo(px, py); isMove = false; }
                    else ctx.lineTo(px, py);
                }
            });
            ctx.stroke();
            ctx.restore();
        }

        function saveState() { historyStack.push(JSON.stringify(rawPoints)); if(historyStack.length > 20) historyStack.shift(); }
        function undo() { if(historyStack.length) { rawPoints = JSON.parse(historyStack.pop()); render(); } }
        function clearCanvas() { saveState(); rawPoints = []; render(); }
        function resetStatus() { generatedGCode = null; render(); }
        function updateUI() { document.getElementById('symVal').innerText = document.getElementById('symSlider').value + 'x'; render(); }
        function showToast(m, t) { const s = document.getElementById('status-toast'); s.innerText = m; s.className = t; s.style.opacity = 1; setTimeout(()=>s.style.opacity=0, 3000); }

        init();
    </script>
</body>
</html>
