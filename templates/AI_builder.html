<div><label>Ball Size (mm)</label><input type="number" id="cfgBallSize" value="13" onchange="runHighPrecisionTrace()"></div>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sand Controller Pro</title>
    <style>
        :root {
            --primary: #d2b48c; --secondary: #b08d5c; --bg: #f4f4f4; --panel: #ffffff; 
            --text: #333; --accent: #2ecc71; --danger: #e74c3c; --btn-text: #fff;
        }
        body[data-theme='dark'] {
            --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --btn-text: #000;
        }
        body {
            font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text);
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--panel); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; }
        .sidebar { height: 100%; width: 0; position: fixed; top: 0; left: 0; background-color: var(--primary); overflow-x: hidden; transition: 0.3s; padding-top: 60px; z-index: 2000; box-shadow: 4px 0 10px rgba(0,0,0,0.3); }
        .sidebar a { padding: 15px 24px; text-decoration: none; font-size: 18px; color: #fff; display: block; font-weight: 500; }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; padding: 10px; box-sizing: border-box; gap: 10px; overflow-y: auto; }
        @media (min-width: 768px) {
            .app-container { flex-direction: row; overflow: hidden; }
            .drawing-panel { flex: 2; border-radius: 16px; background: var(--panel); position: relative; display: flex; align-items: center; justify-content: center; }
            .controls-panel { flex: 1; max-width: 400px; border-radius: 16px; background: var(--panel); padding: 20px; overflow-y: auto; }
        }
        @media (max-width: 767px) {
            .drawing-panel { width: 100%; aspect-ratio: 1/1; border-radius: 16px; background: var(--panel); flex-shrink: 0; position: relative;}
            .controls-panel { flex: 1; border-radius: 16px; background: var(--panel); padding: 15px; }
        }
        .canvas-wrapper { position: relative; width: 95vmin; height: 95vmin; max-width: 95%; max-height: 95%; aspect-ratio: 1 / 1; margin: auto; border-radius: 50%; border: 4px solid var(--primary); background: #fff; touch-action: none; cursor: crosshair; overflow: hidden; }
        body[data-theme='dark'] .canvas-wrapper { background: #222; border-color: var(--secondary); }
        canvas { display: block; width: 100%; height: 100%; border-radius: 50%; }
        h2 { margin: 0 0 15px 0; font-size: 1.2rem; color: var(--secondary); text-align: center; }
        .btn-group { display: flex; gap: 8px; margin-bottom: 12px; }
        button { background: var(--primary); color: var(--btn-text); border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; flex: 1; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button.secondary { background: transparent; border: 1px solid var(--text); color: var(--text); }
        button.active { background: var(--secondary); border: 2px solid var(--text); }
        button.action { background: var(--accent); color: #000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .slider-row { margin-bottom: 15px; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; font-weight: bold; }
        input[type="range"] { width: 100%; accent-color: var(--secondary); }
        #progressSlider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #d3d3d3; outline: none; }
        #progressSlider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--secondary); cursor: pointer; }
        details { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; margin-top: 10px; }
        summary { cursor: pointer; font-weight: bold; font-size: 13px; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        input[type="number"], input[type="text"], select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; }
        #status-toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 3000; }
        .success { background: var(--accent) !important; color: #000 !important; }
        .error { background: var(--danger) !important; color: #fff !important; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-tog { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider-tog:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-tog { background-color: var(--secondary); }
        input:checked + .slider-tog:before { transform: translateX(18px); }
        #toolSettingsArea { background: rgba(0,0,0,0.03); border: 1px dashed var(--secondary); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none; }
        .tool-setting-group { display: none; }
        .tool-setting-group.active { display: block; }
        .tool-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--secondary); margin-bottom: 5px; display:block;}
        .stamp-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 8px; }
        .stamp-btn { font-size: 18px; padding: 5px; background: rgba(0,0,0,0.05); border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        #hiddenTraceBuffer, #vortexScanCanvas { display: none; }
    </style>
</head>
<body data-theme="light">
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" onclick="closeNav()">‚úñ Close</a>
        <a href="/">Designs</a> <a href="/ai_builder">AI Builder</a> <a href="/led_controls">LED Controls</a> <a href="/terminal">Terminal</a>
    </div>
    <div class="nav-bar">
        <button style="flex:0; background:none; font-size:24px; color:var(--text); padding:0;" onclick="openNav()">‚ò∞</button>
        <h1 style="margin:0; font-size:1.2rem;">Sand Controller Pro</h1>
        <button style="flex:0; background:none; font-size:20px;" onclick="toggleTheme()">‚òÄÔ∏è</button>
    </div>
    <div class="app-container">
        <div class="drawing-panel">
            <div class="canvas-wrapper" id="canvasContainer"><canvas id="drawCanvas"></canvas></div>
            <div id="coordDisplay" style="position:absolute; bottom:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:4px 8px; border-radius:4px; font-size:11px; pointer-events:none;">X:0 Y:0</div>
        </div>
        <div class="controls-panel">
            <div id="designPhaseControls">
                <h2>Tools</h2>
                <div class="toggle-row">
                    <span style="font-weight:600; font-size:13px;">üñãÔ∏è Stylus Mode</span>
                    <label class="switch"><input type="checkbox" id="stylusMode"><span class="slider-tog"></span></label>
                </div>
                <div id="toolSettingsArea">
                    <div id="set-pen" class="tool-setting-group">
                        <div class="toggle-row" style="margin:0;"><span style="font-size:13px;">üîó Shape Connector</span><label class="switch"><input type="checkbox" id="shapeConnectMode" checked><span class="slider-tog"></span></label></div>
                        <div style="margin-top:10px;"><span class="tool-label">Add Stamps</span><div class="stamp-grid">
                            <button class="stamp-btn" onclick="addShape('circle')">‚≠ï</button><button class="stamp-btn" onclick="addShape('square')">‚¨ú</button><button class="stamp-btn" onclick="addShape('triangle')">üî∫</button><button class="stamp-btn" onclick="addShape('hexagon')">‚¨°</button><button class="stamp-btn" onclick="addShape('pentagon')">‚¨†</button><button class="stamp-btn" onclick="addShape('star')">‚≠ê</button><button class="stamp-btn" onclick="addShape('spiral')">üåÄ</button><button class="stamp-btn" onclick="addShape('random')">üé≤</button>
                        </div></div>
                    </div>
                    <div id="set-erase" class="tool-setting-group"><span class="tool-label">Eraser Size: <span id="eraseSizeVal">10px</span></span><input type="range" min="2" max="50" value="10" oninput="updateToolSettings()" id="eraserSizeSlider"></div>
                    <div id="set-text" class="tool-setting-group">
                        <span class="tool-label" style="color:var(--accent); font-weight:bold;">Text to Path</span><label class="tool-label">Your Text</label><input type="text" id="toolTextInput" value="USU" oninput="renderTextToTrace()">
                        <div class="settings-grid"><div><label class="tool-label">Size</label><input type="number" id="toolTextSize" value="150" oninput="renderTextToTrace()"></div><div><label class="tool-label">Font</label><select id="toolTextFont" onchange="renderTextToTrace()"><option value="Arial">Arial</option><option value="Serif">Serif</option><option value="Monospace">Mono</option></select></div></div>
                        <button class="action" style="margin-top:10px; width:100%;" onclick="setTool('draw')">Confirm</button>
                    </div>
                    <div id="set-select" class="tool-setting-group">
                        <span class="tool-label">Transform Selection</span><div id="traceMoveMsg" style="display:none; color:var(--accent); font-size:11px; margin-bottom:8px;">‚ú® Trace Active: Drag/Rotate/Resize image</div>
                        <span class="tool-label">Rotate</span><input type="range" min="-180" max="180" value="0" step="1" id="liveRotSlider" oninput="liveRotate(this.value)" onchange="endLiveTransform(this)">
                        <span class="tool-label">Resize</span><input type="range" min="10" max="200" value="100" step="1" id="liveScaleSlider" oninput="liveScale(this.value)" onchange="endLiveTransform(this)">
                    </div>
                    <div id="set-trace" class="tool-setting-group">
                         <span class="tool-label" style="color:var(--accent); font-weight:bold;">Precision Trace</span>
                         <span class="tool-label">Threshold: <span id="traceThreshVal">150</span></span><input type="range" min="10" max="240" value="150" id="traceThreshInput" oninput="runHighPrecisionTrace()">
                         <span class="tool-label">Spiral Gap Multiplier: <span id="traceDensityVal">1.5</span></span><input type="range" min="1" max="5" value="1.5" step="0.1" id="traceDensityInput" oninput="runHighPrecisionTrace()">
                         <button class="secondary" style="margin-top:10px; font-size:11px;" onclick="document.getElementById('imgUpload').click()">üìÇ Change Image</button>
                    </div>
                </div>
                <div class="btn-group"><button id="btnDraw" onclick="setTool('draw')" class="active">‚úèÔ∏è Draw</button><button id="btnErase" onclick="setTool('erase')" class="secondary">üßº Erase</button></div>
                <div class="btn-group"><button id="btnSelect" onclick="setTool('select')" class="secondary">‚úã Move</button><button id="btnSandify" onclick="setTool('sandify')" class="secondary">üåÄ Vortex</button></div>
                <div class="btn-group"><button id="btnText" onclick="setTool('text')" class="secondary">üî† Text</button><input type="file" id="imgUpload" accept="image/*" style="display:none" onchange="handleImageUpload(this)"><button id="btnTrace" class="secondary" onclick="document.getElementById('imgUpload').click()">‚ú® Trace</button></div>
                <div class="btn-group"><button onclick="undo()" class="secondary">‚Ü∂ Undo</button><button onclick="clearCanvas()" class="secondary" style="color:var(--danger); border-color:var(--danger);">‚úñ Clear</button></div>
                <hr style="border:0; border-top:1px solid #ddd; margin: 15px 0;">
                <div class="slider-row"><div class="slider-header"><span>SYMMETRY</span> <span id="symVal">1x</span></div><input type="range" id="symSlider" min="1" max="12" value="1" step="1" oninput="updateUI()"></div>
                <button class="action" onclick="prepareGCode()" style="margin-bottom:15px; font-size:1.1em;">‚öôÔ∏è Prepare Path</button>
            </div>
            <div id="productionPhaseControls" style="display:none; margin-bottom:15px;"><button class="secondary" onclick="returnToEditing()" style="width:100%;">‚úèÔ∏è Back to Edit</button></div>
            <div class="slider-row"><div class="slider-header"><span>SIMULATION</span> <span id="progVal">100%</span></div><input type="range" id="progressSlider" min="0" max="100" value="100" oninput="render()"></div>
            <div class="btn-group"><button onclick="sendToTable()" class="active">üöÄ Run</button><button onclick="saveToServer()" class="secondary">üíæ Save</button></div>
            <details>
                <summary>‚öôÔ∏è Machine Settings</summary>
                <div class="settings-grid">
                    <div><label>Radius (mm)</label><input type="number" id="cfgRadius" value="202.6" onchange="resizeCanvas()"></div>
                    <div><label>Ball Size (mm)</label><input type="number" id="cfgBallSize" value="13" onchange="runHighPrecisionTrace()"></div>
                    <div><label>Center Speed</label><input type="number" id="cfgCenterDelay" value="500"></div>
                    <div><label>Rim Speed</label><input type="number" id="cfgPerimDelay" value="3000"></div>
                    <div><label>Steps/Deg</label><input type="number" id="cfgStepsPerDeg" value="8.888888"></div>
                    <div><label>Arm 1</label><input type="number" id="cfgL1" value="101.3"></div>
                    <div><label>Arm 2</label><input type="number" id="cfgL2" value="101.3"></div>
                </div>
                <button class="secondary" onclick="copyGCode()" style="margin-top:10px; width:100%;">üìã Copy GCode</button>
            </details>
        </div>
    </div>
    <div id="status-toast"></div>
    <canvas id="hiddenTraceBuffer" width="800" height="800"></canvas>
    <canvas id="vortexScanCanvas" width="600" height="600"></canvas>

    <script>
        let rawPoints = [], processedPoints = [], historyStack = [], isDrawing = false, currentTool = 'draw', origin = {x:0, y:0}, scale = 1, generatedGCode = null;
        let eraserRadius = 10, traceImgData = null, traceState = { active: false, img: null, x: 0, y: 0, scale: 1.0, baseScale: 1.0, rotation: 0 };
        const canvas = document.getElementById('drawCanvas'), ctx = canvas.getContext('2d'), BASE_URL = window.location.origin;

        function init() { resizeCanvas(); window.addEventListener('resize', resizeCanvas); canvas.addEventListener('pointerdown', startDraw); canvas.addEventListener('pointermove', moveDraw); canvas.addEventListener('pointerup', endDraw); updateUI(); updateToolSettings(); }
        function getPos(e) { return { x: (e.offsetX - origin.x) / scale, y: -(e.offsetY - origin.y) / scale }; }
        function startDraw(e) { e.preventDefault(); if(generatedGCode) return; if(currentTool === 'select') { isDrawing = true; canvas.setPointerCapture(e.pointerId); return; } if(currentTool === 'draw' || currentTool === 'erase') { saveState(); isDrawing = true; canvas.setPointerCapture(e.pointerId); processPointer(e); resetStatus(); } }
        function moveDraw(e) { e.preventDefault(); const pos = getPos(e); document.getElementById('coordDisplay').textContent = `X:${pos.x.toFixed(0)} Y:${pos.toFixed(0)}`; if(!isDrawing) { render(); return; } processPointer(e); }
        function endDraw(e) { if(!isDrawing) return; isDrawing = false; if(currentTool === 'draw') rawPoints.push({type:'break'}); render(); }
        function processPointer(e) { const p = getPos(e); if(currentTool === 'draw') rawPoints.push({x: p.x, y: p.y, type: 'point'}); else if (currentTool === 'erase') { rawPoints = rawPoints.filter(pt => pt.type === 'break' || Math.hypot(pt.x - p.x, pt.y - p.y) > eraserRadius); } render(); }

        // --- NEW IMAGE & TEXT LOGIC ---
        function renderTextToTrace() {
            const text = document.getElementById('toolTextInput').value, size = document.getElementById('toolTextSize').value, font = document.getElementById('toolTextFont').value;
            const bCtx = document.getElementById('hiddenTraceBuffer').getContext('2d');
            bCtx.fillStyle = "white"; bCtx.fillRect(0,0,800,800); bCtx.fillStyle = "black"; bCtx.font = `bold ${size}px ${font}`; bCtx.textAlign = "center"; bCtx.textBaseline = "middle"; bCtx.fillText(text, 400, 400);
            traceImgData = bCtx.getImageData(0,0,800,800); runHighPrecisionTrace();
        }

        function handleImageUpload(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = (e) => {
                const img = new Image(); img.onload = () => { traceState.active = true; traceState.img = img; traceState.x = 0; traceState.y = 0; commitTraceMove(); setTool('trace_set'); }; img.src = e.target.result;
            }; reader.readAsDataURL(file);
        }

        function commitTraceMove() {
            const bCtx = document.getElementById('hiddenTraceBuffer').getContext('2d'); bCtx.fillStyle = "white"; bCtx.fillRect(0,0,800,800);
            bCtx.save(); bCtx.translate(400,400); bCtx.drawImage(traceState.img, -200, -200, 400, 400); bCtx.restore();
            traceImgData = bCtx.getImageData(0,0,800,800); runHighPrecisionTrace();
        }

        // --- THE TUNED TRACE ENGINE ---
        function runHighPrecisionTrace() {
            if(!traceImgData) return;
            const thresh = parseInt(document.getElementById('traceThreshInput').value);
            const ballSizeMm = parseFloat(document.getElementById('cfgBallSize').value);
            const tableRadiusMm = parseFloat(document.getElementById('cfgRadius').value);
            const densityMult = parseFloat(document.getElementById('traceDensityInput').value);
            
            // Step 1: Calculate pixel equivalence for ball size
            // Buffer is 800px wide, representing Table Diameter (tableRadiusMm * 2)
            const mmToPx = 800 / (tableRadiusMm * 2);
            const ballPx = ballSizeMm * mmToPx;
            
            // Offset logic: We need shapes to be far enough from spiral to avoid bleed
            const offsetPx = ballPx * 0.5; // Half-ball buffer
            const spacingPx = ballPx * densityMult;

            let pixelGrid = new Uint8Array(800*800);
            for(let i=0; i<800*800; i++) pixelGrid[i] = traceImgData.data[i*4] < thresh ? 1 : 0;

            // Step 2: Line Merging (Thin lines -> Single Path)
            // Morphological closing/thinning simplified: Check neighbors to bridge small gaps
            let mergedGrid = new Uint8Array(800*800);
            for(let y=2; y<798; y++) {
                for(let x=2; x<798; x++) {
                    if(pixelGrid[y*800+x]) {
                        mergedGrid[y*800+x] = 1;
                        // Bridge 1px gaps
                        if(pixelGrid[y*800+(x+2)]) mergedGrid[y*800+(x+1)] = 1;
                        if(pixelGrid[(y+2)*800+x]) mergedGrid[(y+1)*800+x] = 1;
                    }
                }
            }

            // Step 3: High Precision Path Finding
            let contours = []; const traced = new Uint8Array(800*800).fill(0);
            for(let y=1; y<799; y++) {
                for(let x=1; x<799; x++) {
                    const idx = y*800 + x;
                    if(mergedGrid[idx] && !traced[idx]) {
                        // Boundary tracing logic
                        let path = []; let cx=x, cy=y;
                        while(path.length < 5000) {
                            path.push({x:cx, y:cy}); traced[cy*800+cx] = 1;
                            let neighbors = [{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1}];
                            let found = false;
                            for(let n of neighbors) {
                                let nx=cx+n.x, ny=cy+n.y;
                                if(nx>=0 && nx<800 && ny>=0 && ny<800 && mergedGrid[ny*800+nx] && !traced[ny*800+nx]) { cx=nx; cy=ny; found=true; break; }
                            }
                            if(!found) break;
                        }
                        if(path.length > 10) contours.push(path);
                    }
                }
            }

            // Step 4: Calibrated Spiral Fill
            let spiral = []; let angle = 0, r = 0;
            while(r < 395) {
                // Adjust spiral radius to maintain "ball-width" gap
                r = (spacingPx / (2*Math.PI)) * angle;
                let tx = 400 + Math.cos(angle)*r, ty = 400 + Math.sin(angle)*r;
                let ix = Math.floor(tx), iy = Math.floor(ty);
                
                // Calibration: Check if current spiral point is within the "No-Fly Zone" of a shape
                let tooClose = false;
                if(ix>=0 && ix<800 && iy>=0 && iy<800) {
                    // Check local neighborhood around ball size
                    let checkRad = Math.ceil(offsetPx);
                    outer: for(let dy=-checkRad; dy<=checkRad; dy++) {
                        for(let dx=-checkRad; dx<=checkRad; dx++) {
                            if(mergedGrid[(iy+dy)*800+(ix+dx)]) { tooClose = true; break outer; }
                        }
                    }
                }
                if(!tooClose) spiral.push({x:tx, y:ty});
                angle += 0.05;
            }

            // Convert to Table Units
            const mmScale = (tableRadiusMm * 2) / 800;
            rawPoints = []; rawPoints.push({type:'break'});
            spiral.forEach(p => rawPoints.push({x:(p.x-400)*mmScale, y:(400-p.y)*mmScale, type:'point'}));
            contours.forEach(c => {
                rawPoints.push({type:'break'});
                c.forEach(p => rawPoints.push({x:(p.x-400)*mmScale, y:(400-p.y)*mmScale, type:'point'}));
            });
            render();
        }

        // --- UI & RENDER ---
        function setTool(t) { currentTool = t; updateToolSettings(); if(t==='text') renderTextToTrace(); }
        function updateToolSettings() { const area = document.getElementById('toolSettingsArea'); area.style.display = 'block'; document.querySelectorAll('.tool-setting-group').forEach(g => { g.classList.remove('active'); if(g.id === 'set-'+currentTool) g.classList.add('active'); }); }
        function resizeCanvas() { const size = document.getElementById('canvasContainer').clientWidth; canvas.width = size; canvas.height = size; origin = {x:size/2, y:size/2}; scale = (size/2) / (parseFloat(document.getElementById('cfgRadius').value)*1.05); render(); }
        function render() {
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.save(); ctx.translate(origin.x, origin.y);
            ctx.beginPath(); ctx.arc(0,0,parseFloat(document.getElementById('cfgRadius').value)*scale, 0, Math.PI*2); ctx.strokeStyle="#ddd"; ctx.stroke();
            ctx.beginPath(); ctx.strokeStyle = "#007bff"; let isMove = true;
            rawPoints.forEach(p => { if(p.type==='break') isMove=true; else { if(isMove) ctx.moveTo(p.x*scale, -p.y*scale); else ctx.lineTo(p.x*scale, -p.y*scale); isMove=false; } });
            ctx.stroke(); ctx.restore();
        }
        function saveState() { historyStack.push(JSON.stringify(rawPoints)); }
        function undo() { if(historyStack.length) rawPoints = JSON.parse(historyStack.pop()); render(); }
        function clearCanvas() { saveState(); rawPoints = []; render(); }
        function updateUI() { document.getElementById('symVal').innerText = document.getElementById('symSlider').value+'x'; }
        init();
    </script>
</body>
</html>
