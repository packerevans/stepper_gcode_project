<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sand Table</title>
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
    <style>
        /* --- Modern Variables --- */
        :root {
            --color-accent: #d2b48c; 
            --color-selected: #4ade80; /* Vibrant Light Green */
            --color-selected-ring: #22c55e;
            --color-bg: #f8f9fa;
            --color-surface: #ffffff;
            --color-text: #222222;
            --shadow-float: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        body[data-theme='dark'] {
            --color-bg: #121212;
            --color-surface: #1e1e1e;
            --color-text: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            margin: 0; padding-bottom: 100px;
            transition: background 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: grid; 
            grid-template-columns: 40px 1fr 40px;
            align-items: center;
            padding: 0 15px; height: 60px;
        }
        body[data-theme='dark'] header { background: rgba(30, 30, 30, 0.95); border-bottom: 1px solid rgba(255,255,255,0.05); }

        .header-center { text-align: center; overflow: hidden; }
        .playing-text { font-weight: 700; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .queue-text { font-size: 0.8rem; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--color-text); }

        /* --- Loop Indicator Bar --- */
        #loop-indicator {
            background-color: var(--color-selected);
            color: #004d00;
            text-align: center; padding: 8px; font-weight: 700; font-size: 0.9rem;
            display: none; justify-content: center; align-items: center; gap: 10px;
        }
        .close-loop { background: none; border: 1px solid #004d00; border-radius: 50%; width:20px; height:20px; line-height:18px; cursor: pointer; font-size:12px; }

        /* --- Hero --- */
        .hero-container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 20px 15px 0; }
        .hero-image { width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }

        /* --- Controls --- */
        .controls-wrapper { max-width: 1200px; margin: 20px auto 10px; padding: 0 15px; }
        .status-pill { background: var(--color-accent); color: #fff; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; opacity: 0; transition: opacity 0.3s; display: inline-block; margin-bottom: 10px; }
        .main-actions { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        
        select, button.action-btn {
            background: var(--color-surface); color: var(--color-text);
            border: 1px solid rgba(0,0,0,0.1); padding: 10px 16px;
            border-radius: 12px; font-weight: 600; font-size: 0.9rem; cursor: pointer; white-space: nowrap;
        }
        .btn-primary { background: var(--color-accent) !important; color: white !important; border: none !important; }

        /* --- Grid --- */
        .grid { display: grid; gap: 16px; padding: 15px; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); max-width: 1200px; margin: 0 auto; }

        .card {
            background: var(--color-surface); border-radius: var(--radius);
            overflow: hidden; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: transform 0.2s; cursor: pointer;
            border: 2px solid transparent;
        }
        
        /* Selected State */
        .card.selected { border-color: var(--color-selected-ring); background-color: rgba(74, 222, 128, 0.05); transform: scale(0.98); }

        .card-img-wrap { position: relative; aspect-ratio: 1/1; background: #fff; width: 100%; }
        
        /* UPDATED: Added transform scaleX(-1) to mirror the rendering */
        .card canvas { 
            width: 100%; 
            height: 100%; 
            display: block; 
            transform: scaleX(-1); 
        }
        
        /* Select Dot */
        .select-dot {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; border-radius: 50%;
            background: rgba(0,0,0,0.2); border: 2px solid #fff;
            z-index: 10; transition: 0.2s;
        }
        .card.selected .select-dot { background: var(--color-selected); border-color: var(--color-selected); }
        
        .card-body { padding: 12px; }
        .card-title { margin: 0; font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-meta { font-size: 0.75rem; opacity: 0.6; margin-top: 4px; }

        /* --- Floating Selection Bar --- */
        .selection-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150px);
            background: var(--color-text); color: var(--color-bg);
            padding: 12px 20px; border-radius: 50px;
            display: flex; gap: 15px; align-items: center;
            box-shadow: var(--shadow-float); z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 300px; justify-content: space-between;
        }
        .selection-bar.active { transform: translateX(-50%) translateY(0); }
        .bar-actions { display: flex; gap: 10px; }
        .bar-btn { background: rgba(255,255,255,0.2); border: none; color: inherit; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .bar-btn.loop { background: var(--color-selected); color: #004d00; }
        .bar-btn.danger { background: #ff4d4d; color: white; }

        /* Sidebar */
        .sidebar { height: 100%; width: 0; position: fixed; top: 0; left: 0; background: var(--color-surface); overflow-x: hidden; z-index: 1100; transition: 0.3s; padding-top: 20px; border-right: 1px solid rgba(0,0,0,0.1); }
        .sidebar a { padding: 15px 25px; text-decoration: none; font-size: 1.1rem; color: var(--color-text); display: block; font-weight: 600; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 1050; display: none; }
    </style>
</head>
<body data-theme="light">

    <div id="loop-indicator">
        <span>Drawing on Repeat</span>
        <button class="close-loop" onclick="cancelLoop()">✕</button>
    </div>

    <header>
        <button class="icon-btn" onclick="openNav()">☰</button>
        <div class="header-center">
            <div id="playing-display" class="playing-text">Select a design</div>
            <div id="queue-display" class="queue-text">Queue empty</div>
        </div>
        <button class="icon-btn" onclick="toggleTheme()">◑</button>
    </header>

    <div id="overlay" class="overlay" onclick="closeNav()"></div>
    <div id="mySidebar" class="sidebar">
        <div style="padding:0 25px; margin-bottom:20px; opacity:0.5;">MENU</div>
        <a href="/">Designs</a>
        <a href="/AI_builder">AI Builder</a>
        <a href="/led_controls">LED Controls</a>
        <a href="/terminal">Terminal</a>
    </div>

    <div class="hero-container">
        <img src="/static/sand.png" alt="Sand Table" class="hero-image">
    </div>

    <div class="controls-wrapper">
        <div id="status-pill" class="status-pill">Ready</div>
        <div class="main-actions">
            <select id="speedSelect">
                <option value="0.5">Speed: Fast</option>
                <option value="1.0" selected>Speed: Normal</option>
                <option value="2.0">Speed: Slow</option>
            </select>
            <button class="action-btn btn-primary" onclick="resumeDesign()">Resume</button>
            <button class="action-btn" onclick="pauseDesign()">Pause</button>
            <button class="action-btn" onclick="clearQueue()">Clear All</button>
        </div>
    </div>

    <div id="grid" class="grid"></div>
    <div style="text-align:center; margin-top:20px;">
        <button id="more-btn" class="action-btn" style="display:none;" onclick="showAll()">Show All Designs</button>
    </div>

    <div id="selection-bar" class="selection-bar">
        <span style="font-weight:600; padding-left:5px;" id="sel-count">0 Selected</span>
        <div class="bar-actions">
            <button class="bar-btn loop" onclick="loopSelected()">Loop</button>
            <button class="bar-btn" onclick="copySelected()">Copy</button>
            <button class="bar-btn danger" onclick="deleteSelected()">Delete</button>
        </div>
    </div>

    <script>
        const BASE_URL = `${window.location.protocol}//${window.location.host}`;
        let selectedFiles = new Set();
        let allFiles = [];

        // --- MATH & LAZY LOADING ---
        const observer = new IntersectionObserver((e,o)=>{e.forEach(x=>{if(x.isIntersecting){loadPreview(x.target,x.target.dataset.f);o.unobserve(x.target)}})},{rootMargin:"100px"});
        const L1=101.3, L2=101.3, R=9/8, S_RAD=(3200/360)*(180/Math.PI);
        const lerp=(a,b,t)=>a+(b-a)*t;

        function calcFK(b,e){
            let t1 = -b/S_RAD, tb = -e/S_RAD - (R*(-b/S_RAD)), t2=t1+tb;
            return {p2:{x:L1*Math.cos(t1)+L2*Math.cos(t2), y:L1*Math.sin(t1)+L2*Math.sin(t2)}, t1:t1, t2:t2, tb:b, te:e};
        }
        function interp(f,t,p){
            let t1=lerp(f.t1,t.t1,p), t2=lerp(f.t2,t.t2,p);
            return {x:L1*Math.cos(t1)+L2*Math.cos(t2), y:L1*Math.sin(t1)+L2*Math.sin(t2)};
        }

        function drawTrace(cvs, txt) {
            let ctx = cvs.getContext('2d'), w=cvs.width, h=cvs.height;
            ctx.clearRect(0,0,w,h);
            let cmds = txt.split('\n').filter(l=>l.trim().toUpperCase().startsWith('G1'))
                .map(l=>{let p=l.substring(2).trim().split(/\s+/); return {e:parseInt(p[0])||0, b:parseInt(p[1])||0}});
            if(!cmds.length) return;
            
            let path=[], cur=calcFK(0,0), tb=0, te=0;
            path.push(cur.p2);
            for(let c of cmds){
                tb+=c.b; te+=c.e;
                let next=calcFK(tb,te);
                let dist=Math.max(Math.abs(next.tb-cur.tb), Math.abs(next.te-cur.te));
                let step=Math.max(2, Math.ceil(dist/600)); 
                for(let i=1; i<=step; i++) path.push(interp(cur,next,i/step));
                cur=next;
            }

            let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
            for(let p of path){ if(p.x<minX)minX=p.x; if(p.x>maxX)maxX=p.x; if(p.y<minY)minY=p.y; if(p.y>maxY)maxY=p.y; }
            let sc = (w/Math.max(maxX-minX||1, maxY-minY||1))*0.9;
            let cx=(minX+maxX)/2, cy=(minY+maxY)/2;

            ctx.beginPath(); ctx.strokeStyle='#333'; ctx.lineWidth=1.5;
            path.forEach((p,i)=>{
                let x = w/2 + (p.x-cx)*sc, y = h/2 + (p.y-cy)*-sc;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            });
            ctx.stroke();
        }

        function toggleTheme() {
            let b = document.body, n = b.getAttribute('data-theme')==='dark'?'light':'dark';
            b.setAttribute('data-theme', n);
        }

        function showStatus(msg) {
            let el = document.getElementById('status-pill');
            el.textContent = msg; el.style.opacity='1';
            setTimeout(()=>el.style.opacity='0', 3000);
        }

        function toggleSelect(f, e) {
            e.stopPropagation();
            if(selectedFiles.has(f)) selectedFiles.delete(f); else selectedFiles.add(f);
            renderSel();
        }
        function renderSel() {
            document.querySelectorAll('.card').forEach(c=>{
                if(selectedFiles.has(c.dataset.name)) c.classList.add('selected'); else c.classList.remove('selected');
            });
            let bar=document.getElementById('selection-bar');
            if(selectedFiles.size>0){ bar.classList.add('active'); document.getElementById('sel-count').textContent=`${selectedFiles.size} Selected`; }
            else bar.classList.remove('active');
        }

        async function loopSelected() {
            let files = Array.from(selectedFiles);
            if(files.length === 0) return;
            showStatus("Starting Loop...");
            await fetch(`${BASE_URL}/set_loop`, {
                method:"POST", headers:{"Content-Type":"application/json"},
                body:JSON.stringify({files:files})
            });
            selectedFiles.clear(); renderSel(); updateQ();
        }

        async function cancelLoop() {
            await fetch(`${BASE_URL}/cancel_loop`, {method:"POST"});
            updateQ();
        }

        async function deleteSelected() {
            let toDel = [], protected = 0;
            for(let f of selectedFiles) {
                let c = document.querySelector(`.card[data-name="${f}"]`);
                if(c && c.dataset.hasPng==="true") protected++; else toDel.push(f);
            }
            if(!toDel.length) { if(protected) alert("Protected files skipped."); return; }
            if(!confirm(`Delete ${toDel.length} files?`)) return;
            for(let f of toDel) await fetch(`${BASE_URL}/delete_design`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:f})});
            selectedFiles.clear(); renderSel(); loadLib();
        }

        // --- IMPROVED COPY FUNCTION (Secure & Fallback) ---
        async function copySelected() {
            let txt = "";
            showStatus("Fetching code...");
            
            // 1. Fetch text
            try {
                for(let f of selectedFiles) {
                    let r = await fetch(`${BASE_URL}/designs/${f}`);
                    txt += `; --- ${f} ---\n${await r.text()}\n\n`;
                }
            } catch(e) { showStatus("Error fetching files"); return; }

            // 2. Try Modern API (HTTPS/Localhost)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(txt);
                    showStatus("Copied!");
                    selectedFiles.clear(); renderSel();
                    return;
                } catch (err) { console.log("Clipboard API failed, trying fallback..."); }
            }

            // 3. Fallback (HTTP/Mobile)
            const ta = document.createElement("textarea");
            ta.value = txt;
            ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            
            try {
                document.execCommand('copy');
                showStatus("Copied!");
                selectedFiles.clear(); renderSel();
            } catch (err) {
                showStatus("Copy Failed");
            }
            document.body.removeChild(ta);
        }

        async function runDesign(f) {
            let spd = document.getElementById('speedSelect').value;
            showStatus("Queueing...");
            let r=await fetch(`${BASE_URL}/designs/${f}`), txt=await r.text();
            let gcode = txt.split('\n').map(l=>{
                if(l.trim().toUpperCase().startsWith('G1')){
                    let p=l.substring(2).trim().split(/\s+/);
                    return `G1 ${p[0]} ${p[1]} ${Math.round((parseInt(p[2])||1000)*parseFloat(spd))}`;
                } return l;
            }).join('\n');
            await fetch(`${BASE_URL}/send_gcode_block`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gcode:gcode, filename:f})});
            updateQ();
        }

        function sendCmd(c) { fetch(`${BASE_URL}/send`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:c})}); }
        function pauseDesign() { sendCmd('PAUSE'); }
        function resumeDesign() { sendCmd('RESUME'); }
        function clearQueue() { sendCmd('CLEAR'); updateQ(); }

        async function updateQ() {
            try {
                let r=await fetch(`${BASE_URL}/status_full`);
                let d=await r.json();
                document.getElementById('playing-display').textContent = d.playing ? `Playing: ${d.playing}` : "Select a design";
                
                let qText = "Queue empty";
                if(d.queue_count > 0) qText = `Next: ${d.next_up} (+${d.queue_count-1})`;
                else if(d.is_looping) qText = `Next: ${d.next_up}`;
                
                document.getElementById('queue-display').textContent = qText;
                document.getElementById('loop-indicator').style.display = d.is_looping ? 'flex' : 'none';
            } catch(e){}
        }

        async function loadLib() {
            let g=document.getElementById('grid'); g.innerHTML='Loading...';
            let r=await fetch(`${BASE_URL}/api/designs`), files=await r.json();
            allFiles=files; renderGrid(files.slice(0,15));
            if(files.length>15) document.getElementById('more-btn').style.display='inline-block';
        }
        function showAll() { renderGrid(allFiles); document.getElementById('more-btn').style.display='none'; }
        
        function renderGrid(fs) {
            let g=document.getElementById('grid'); g.innerHTML='';
            fs.forEach(f=>{
                let d=document.createElement('div'), clean=f.replace('.txt','');
                d.className='card'; d.dataset.name=f; d.dataset.hasPng="false";
                d.onclick=(e)=>{if(e.target.className!=='select-dot')runDesign(f)};
                d.innerHTML=`<div class="card-img-wrap"><canvas data-f="${f}" width="300" height="300"></canvas><div class="select-dot" onclick="toggleSelect('${f}', event)"></div></div><div class="card-body"><h3 class="card-title">${clean}</h3><div class="card-meta">Est: <span id="t-${clean}">...</span></div></div>`;
                g.appendChild(d); observer.observe(d.querySelector('canvas'));
            }); renderSel();
        }

        function loadPreview(cvs, f) {
            let clean=f.replace('.txt',''), card=cvs.closest('.card'), img=new Image();
            img.src=`${BASE_URL}/designs/${clean}.png`;
            img.onload=()=>{cvs.getContext('2d').drawImage(img,0,0,300,300); card.dataset.hasPng="true"};
            img.onerror=()=>{
                fetch(`${BASE_URL}/designs/${f}`).then(r=>r.text()).then(t=>{
                    drawTrace(cvs,t);
                    let tm=0; t.split('\n').forEach(l=>{if(l.startsWith('G1')){let p=l.substring(2).split(/\s+/); tm+=Math.max(Math.abs(p[0]),Math.abs(p[1]))*(p[2]||1000)}});
                    document.getElementById(`t-${clean}`).textContent=Math.ceil(tm/6e7)+" min";
                });
            }
        }

        function openNav() { document.getElementById('mySidebar').style.width="250px"; document.getElementById('overlay').style.display="block"; }
        function closeNav() { document.getElementById('mySidebar').style.width="0"; document.getElementById('overlay').style.display="none"; }

        loadLib(); updateQ(); setInterval(updateQ, 3000);
    </script>
</body>
</html>
