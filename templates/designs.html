<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sand Table Controller</title>
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
    <style>
        /* --- Modern Variables --- */
        :root {
            /* 1. Main Accent (The Tan) */
            --color-accent: #d2b48c; 
            
            /* 2. Background */
            --color-bg: #f8f9fa;
            
            /* 3. Surface/Text (High Contrast) */
            --color-surface: #ffffff;
            --color-text: #222222;
            
            --shadow-subtle: 0 4px 6px -1px rgba(0,0,0,0.05);
            --shadow-float: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius: 16px;
        }

        body[data-theme='dark'] {
            --color-bg: #121212;
            --color-surface: #1e1e1e;
            --color-text: #e0e0e0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding-bottom: 80px; /* Space for floating bar */
            transition: background 0.3s, color 0.3s;
        }

        /* --- Minimal Header --- */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; height: 60px;
        }
        
        body[data-theme='dark'] header { 
            background: rgba(30, 30, 30, 0.85); 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .header-title { font-weight: 700; font-size: 1.1rem; letter-spacing: -0.5px; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--color-text); }

        /* --- Controls --- */
        .controls-wrapper {
            max-width: 1200px; margin: 20px auto 10px; padding: 0 15px;
        }
        
        .status-pill {
            background: var(--color-accent); color: #fff;
            padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            opacity: 0; transition: opacity 0.3s; display: inline-block; margin-bottom: 10px;
        }

        .main-actions {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;
        }
        
        select, button.action-btn {
            background: var(--color-surface); color: var(--color-text);
            border: 1px solid rgba(0,0,0,0.1); padding: 10px 16px;
            border-radius: 12px; font-weight: 600; font-size: 0.9rem;
            cursor: pointer; box-shadow: var(--shadow-subtle);
            white-space: nowrap;
        }
        
        button.action-btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--color-accent) !important; color: white !important; border: none !important; }

        /* --- Grid --- */
        .grid {
            display: grid; gap: 16px; padding: 15px;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            max-width: 1200px; margin: 0 auto;
        }

        .card {
            background: var(--color-surface); border-radius: var(--radius);
            overflow: hidden; position: relative;
            box-shadow: var(--shadow-subtle);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .card:hover { transform: translateY(-2px); }
        .card.selected { ring: 2px solid var(--color-accent); transform: scale(0.98); }

        .card-img-wrap { position: relative; aspect-ratio: 1/1; background: #fff; }
        .card canvas { width: 100%; height: 100%; display: block; }
        
        /* Selection Dot */
        .select-dot {
            position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; border-radius: 50%;
            background: rgba(0,0,0,0.3); border: 2px solid #fff;
            z-index: 10; transition: 0.2s;
        }
        
        .card.selected .select-dot {
            background: var(--color-accent);
            box-shadow: 0 0 0 2px var(--color-surface);
        }
        
        .card-body { padding: 12px; }
        .card-title {
            margin: 0; font-size: 0.9rem; font-weight: 600;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .card-meta { font-size: 0.75rem; opacity: 0.6; margin-top: 4px; }

        /* --- Floating Selection Bar --- */
        .selection-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: var(--color-text); color: var(--color-bg);
            padding: 12px 20px; border-radius: 50px;
            display: flex; gap: 15px; align-items: center;
            box-shadow: var(--shadow-float); z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 300px; justify-content: space-between;
        }
        
        .selection-bar.active { transform: translateX(-50%) translateY(0); }
        
        .bar-actions { display: flex; gap: 10px; }
        .bar-btn {
            background: rgba(255,255,255,0.2); border: none; color: inherit;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; font-weight: 600;
        }
        .bar-btn.danger { background: #ff4d4d; color: white; }

        /* --- Sidebar --- */
        .sidebar {
            height: 100%; width: 0; position: fixed; top: 0; left: 0;
            background: var(--color-surface); overflow-x: hidden; z-index: 1100;
            transition: 0.3s; padding-top: 20px;
            border-right: 1px solid rgba(0,0,0,0.1);
        }
        .sidebar a {
            padding: 15px 25px; text-decoration: none; font-size: 1.1rem;
            color: var(--color-text); display: block; font-weight: 600;
        }
        .overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 1050; display: none;
        }

    </style>
</head>
<body data-theme="light">

    <header>
        <button class="icon-btn" onclick="openNav()">☰</button>
        <div class="header-title">Design Library <span id="q-badge" style="font-size:0.8em; opacity:0.5; margin-left:5px;"></span></div>
        <button class="icon-btn" onclick="toggleTheme()">◑</button>
    </header>

    <div id="overlay" class="overlay" onclick="closeNav()"></div>
    <div id="mySidebar" class="sidebar">
        <div style="padding:0 25px; margin-bottom:20px; opacity:0.5; font-size:0.9rem;">MENU</div>
        <a href="/">Designs</a>
        <a href="/AI_builder">AI Builder</a>
        <a href="/led_controls">LED Controls</a>
        <a href="/terminal">Terminal</a>
    </div>

    <div class="controls-wrapper">
        <div id="status-pill" class="status-pill">Ready</div>
        
        <div class="main-actions">
            <select id="speedSelect">
                <option value="0.5">Speed: Fast</option>
                <option value="1.0" selected>Speed: Normal</option>
                <option value="2.0">Speed: Slow</option>
            </select>
            <button class="action-btn btn-primary" onclick="resumeDesign()">Resume</button>
            <button class="action-btn" onclick="pauseDesign()">Pause</button>
            <button class="action-btn" onclick="clearQueue()">Clear Queue</button>
        </div>
    </div>

    <div id="grid" class="grid">
        </div>
    <div style="text-align:center; margin-top:20px;">
        <button id="more-btn" class="action-btn" style="display:none;" onclick="showAll()">Show All Designs</button>
    </div>

    <div id="selection-bar" class="selection-bar">
        <span style="font-weight:600; padding-left:5px;" id="sel-count">0 Selected</span>
        <div class="bar-actions">
            <button class="bar-btn" onclick="copySelected()">Copy Code</button>
            <button class="bar-btn danger" onclick="deleteSelected()">Delete</button>
        </div>
    </div>

    <script>
        const BASE_URL = `${window.location.protocol}//${window.location.host}`;
        let selectedFiles = new Set();
        let allFiles = [];

        // --- KINEMATICS (Minified for visuals) ---
        const L1=101.3, L2=101.3, R=9/8, S_DEG=3200/360, S_RAD=S_DEG*(180/Math.PI);
        const lerp=(a,b,t)=>a+(b-a)*t;
        function calcFK(b,e){
            let t1 = -b/S_RAD, tb = -e/S_RAD - (R*(-b/S_RAD));
            let t2 = t1+tb;
            return { x: L1*Math.cos(t1)+L2*Math.cos(t2), y: L1*Math.sin(t1)+L2*Math.sin(t2) };
        }
        // Basic Trace Generator
        function drawTrace(canvas, text) {
            const ctx = canvas.getContext('2d');
            const w=canvas.width, h=canvas.height;
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
            
            let cmds = text.split('\n').filter(l=>l.trim().toUpperCase().startsWith('G1'))
                .map(l=>{let p=l.substring(2).trim().split(/\s+/); return {b:parseInt(p[1])||0, e:parseInt(p[0])||0}});
            
            if(cmds.length<2) return;
            
            let path=[]; let b=0, e=0;
            path.push(calcFK(0,0));
            
            // Subsampling for performance
            let step = Math.max(1, Math.floor(cmds.length/500));
            for(let i=0; i<cmds.length; i+=step) {
                b+=cmds[i].b; e+=cmds[i].e;
                path.push(calcFK(b,e));
            }
            
            // Bounds
            let minX=path[0].x, maxX=path[0].x, minY=path[0].y, maxY=path[0].y;
            path.forEach(p=>{if(p.x<minX)minX=p.x; if(p.x>maxX)maxX=p.x; if(p.y<minY)minY=p.y; if(p.y>maxY)maxY=p.y;});
            
            let sc = Math.min(w/(maxX-minX||1), h/(maxY-minY||1))*0.8;
            let cx=(minX+maxX)/2, cy=(minY+maxY)/2;
            
            ctx.strokeStyle='#333'; ctx.lineWidth=1.5; ctx.beginPath();
            path.forEach((p,i)=>{
                let x = w/2 + (p.x-cx)*sc;
                let y = h/2 + (p.y-cy)*(-sc);
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            });
            ctx.stroke();
        }

        // --- CORE LOGIC ---

        function toggleTheme() {
            let b = document.body;
            let n = b.getAttribute('data-theme')==='dark'?'light':'dark';
            b.setAttribute('data-theme', n);
        }

        function showStatus(msg) {
            let el = document.getElementById('status-pill');
            el.textContent = msg; el.style.opacity = '1';
            setTimeout(()=>el.style.opacity='0', 3000);
        }

        // --- SELECTION HANDLING ---
        function toggleSelect(filename, event) {
            event.stopPropagation(); // Don't trigger run
            if(selectedFiles.has(filename)) selectedFiles.delete(filename);
            else selectedFiles.add(filename);
            renderSelectionState();
        }

        function renderSelectionState() {
            // Update Dots
            document.querySelectorAll('.card').forEach(card => {
                let fname = card.getAttribute('data-name');
                if(selectedFiles.has(fname)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            // Update Bar
            let bar = document.getElementById('selection-bar');
            let count = document.getElementById('sel-count');
            
            if(selectedFiles.size > 0) {
                bar.classList.add('active');
                count.textContent = `${selectedFiles.size} Selected`;
            } else {
                bar.classList.remove('active');
            }
        }

        async function deleteSelected() {
            if(!confirm(`Delete ${selectedFiles.size} files?`)) return;
            
            for(let f of selectedFiles) {
                try {
                    await fetch(`${BASE_URL}/delete_design`, {
                        method: "POST", headers:{"Content-Type":"application/json"},
                        body: JSON.stringify({filename: f})
                    });
                } catch(e) { console.error(e); }
            }
            selectedFiles.clear();
            renderSelectionState();
            loadLibrary(); // Refresh grid
            showStatus("Files deleted");
        }

        async function copySelected() {
            let fullText = "";
            showStatus("Fetching code...");
            
            for(let f of selectedFiles) {
                try {
                    let res = await fetch(`${BASE_URL}/designs/${f}`);
                    let txt = await res.text();
                    fullText += `; --- START ${f} ---\n${txt}\n; --- END ${f} ---\n\n`;
                } catch(e) {}
            }
            
            navigator.clipboard.writeText(fullText).then(() => {
                showStatus("Copied to Clipboard!");
                selectedFiles.clear();
                renderSelectionState();
            });
        }

        // --- RUNNING ---
        async function runDesign(filename) {
            // If we are in selection mode (bar active) and click a card, maybe just select it?
            // For now, clicking the *Body* runs, clicking *Dot* selects.
            
            let spd = document.getElementById('speedSelect').value;
            showStatus("Queueing...");
            
            // Fetch text to apply speed multiplier locally (simplified logic from previous)
            try {
                let res = await fetch(`${BASE_URL}/designs/${filename}`);
                let txt = await res.text();
                
                // Simple modifier
                let lines = txt.split('\n').map(l => {
                    if(l.trim().startsWith('G1')) {
                        let p = l.split(/\s+/);
                        // Assuming G1 E B Delay
                        if(p.length >= 3) {
                           let d = Math.round(parseInt(p[2]) * parseFloat(spd));
                           return `G1 ${p[1]} ${p[2]} ${d}`; // Reconstruct carefully, split index 0 is 'G1' usually? 
                           // Actually parsing standard Gcode usually is G1 X Y. Your format is custom.
                           // Let's rely on the previous logic: G1 Elbow Base Delay
                        }
                    }
                    return l;
                });
                
                // Re-using the robust logic from previous version in a condensed way is risky without full parser.
                // Let's just send the file name and speed override if backend supported it, 
                // OR just send raw text. For this UI demo, I'll send the raw text unmodified for safety 
                // unless I duplicate the exact parsing logic.
                // *Self-correction*: I will use the exact parsing logic from your previous file.
                
                let modLines = [];
                for(let line of txt.split('\n')) {
                    let trim = line.trim();
                    if(trim.toUpperCase().startsWith('G1')) {
                        let parts = trim.substring(2).trim().split(/\s+/); // [Elbow, Base, Delay]
                        let d = parts[2] ? parseInt(parts[2]) : 1000;
                        d = Math.round(d * parseFloat(spd));
                        modLines.push(`G1 ${parts[0]} ${parts[1]} ${d}`);
                    } else {
                        modLines.push(trim);
                    }
                }
                
                await fetch(`${BASE_URL}/send_gcode_block`, {
                    method:"POST", headers:{"Content-Type":"application/json"},
                    body: JSON.stringify({ gcode: modLines.join('\n'), filename: filename })
                });
                
                showStatus("Added to Queue");
                updateQ();
            } catch(e) { showStatus("Error"); }
        }

        // --- CONTROLS ---
        function sendCmd(c) { 
            fetch(`${BASE_URL}/send`, {
                method:"POST",headers:{"Content-Type":"application/json"},
                body:JSON.stringify({command:c})
            }).then(()=>showStatus("Sent: "+c)); 
        }
        function pauseDesign() { sendCmd('PAUSE'); }
        function resumeDesign() { sendCmd('RESUME'); }
        function clearQueue() { sendCmd('CLEAR'); updateQ(); }
        
        async function updateQ() {
            try {
                let r = await fetch(`${BASE_URL}/queue_count`);
                let d = await r.json();
                document.getElementById('q-badge').textContent = d.count > 0 ? `Q: ${d.count}` : '';
            } catch(e){}
        }

        // --- LOADING ---
        async function loadLibrary() {
            let g = document.getElementById('grid');
            g.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px;">Loading...</div>';
            
            try {
                let res = await fetch(`${BASE_URL}/api/designs`);
                let files = await res.json();
                allFiles = files; // Store
                renderGrid(files.slice(0, 12)); // Show first 12
                if(files.length > 12) document.getElementById('more-btn').style.display='inline-block';
            } catch(e) {
                g.innerHTML = 'Error loading files.';
            }
        }
        
        function showAll() {
            renderGrid(allFiles);
            document.getElementById('more-btn').style.display='none';
        }

        function renderGrid(files) {
            let g = document.getElementById('grid');
            g.innerHTML = '';
            
            files.forEach(f => {
                let clean = f.replace('.txt','');
                let div = document.createElement('div');
                div.className = 'card';
                div.setAttribute('data-name', f);
                div.onclick = () => runDesign(f);
                
                // Selection Dot Logic
                let dot = document.createElement('div');
                dot.className = 'select-dot';
                dot.onclick = (e) => toggleSelect(f, e);
                
                div.innerHTML = `
                    <div class="card-img-wrap">
                        <canvas id="cvs-${clean}"></canvas>
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">${clean}</h3>
                        <div class="card-meta">Est: <span id="time-${clean}">...</span></div>
                    </div>
                `;
                div.querySelector('.card-img-wrap').appendChild(dot);
                g.appendChild(div);
                
                // Async Load Preview
                setTimeout(() => {
                    let cvs = document.getElementById(`cvs-${clean}`);
                    let img = new Image();
                    img.src = `${BASE_URL}/designs/${clean}.png`;
                    img.onload = () => cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                    img.onerror = () => {
                        fetch(`${BASE_URL}/designs/${f}`).then(r=>r.text()).then(t=>drawTrace(cvs,t));
                    };
                    
                    // Calc Time
                    fetch(`${BASE_URL}/designs/${f}`).then(r=>r.text()).then(t=>{
                        let time=0;
                        t.split('\n').forEach(l=>{
                             if(l.toUpperCase().startsWith('G1')) {
                                 let p=l.substring(2).split(/\s+/);
                                 let s=Math.max(Math.abs(parseInt(p[0])||0), Math.abs(parseInt(p[1])||0));
                                 time += s*(parseInt(p[2])||1000);
                             }
                        });
                        document.getElementById(`time-${clean}`).textContent = Math.ceil(time/60000000) + " min";
                    });
                }, 0);
            });
            renderSelectionState(); // Re-apply selections if needed
        }

        function openNav() { document.getElementById('mySidebar').style.width="250px"; document.getElementById('overlay').style.display="block"; }
        function closeNav() { document.getElementById('mySidebar').style.width="0"; document.getElementById('overlay').style.display="none"; }

        // Init
        loadLibrary();
        updateQ(); setInterval(updateQ, 5000);
    </script>
</body>
</html>
